
--- Файл: admin_approval_tasks.txt ---

{% extends "admin/admin_base.html" %} {% block title %}Задачи на согласование - {{ super() }}{% endblock %}

{% block content %}
<div class="container mx-auto">
    <div class="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
        <h2 class="text-2xl font-semibold text-gray-800">Задачи на согласование Техкарт (<span id="total-tasks-count">{{ tasks|length }}</span>)</h2>
        </div>

    <div class="bg-white shadow-md rounded-lg overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 table">
            <thead>
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50">ID Задачи</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50">Товар</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50">Артикул</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50">Статус</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50">Инициатор</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50">Дата поступления</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50">Действия</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% if tasks %}
                    {% for task in tasks %}
                    <tr>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">{{ task.id }}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">{{ task.tech_card.product.name if task.tech_card and task.tech_card.product else task.product_name or 'N/A' }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">{{ task.tech_card.product.sku if task.tech_card and task.tech_card.product else task.product_sku or 'N/A' }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">
                            <span class="status-badge 
                                {% if task.status == 'Ожидает бухгалтера' %}bg-yellow-100 text-yellow-800
                                {% elif task.status == 'Ожидает руководителя' %}bg-blue-100 text-blue-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ task.status }}
                            </span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">{{ task.created_by_user.username if task.created_by_user else 'Система' }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">{{ task.created_at.strftime('%d.%m.%Y %H:%M') if task.created_at else '-' }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">
                            <a href="{{ url_for('admin_approval_task_detail', task_id=task.id) }}" class="btn btn-primary btn-sm">
                                Рассмотреть
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="7" class="text-center py-4 text-gray-500">Нет задач на согласование.</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
    </div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Скрипты для страницы списка задач, если нужны
</script>
{% endblock %}

--- Файл: admin_base.txt ---

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}РђРґРјРёРЅ-РїР°РЅРµР»СЊ{% endblock %} - РњРµР±РµР»СЊРџСЂР°Р№СЃРџСЂРѕ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Tailwind gray-100 */
        }
        .admin-sidebar {
            transition: width 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateX(0); 
        }
        /* РЎС‚РёР»Рё РґР»СЏ СЃРІРµСЂРЅСѓС‚РѕРіРѕ СЃРѕСЃС‚РѕСЏРЅРёСЏ РЅР° РґРµСЃРєС‚РѕРїРµ */
        .admin-sidebar.collapsed-desktop { 
            width: 4rem; /* 64px */
        }
        .admin-sidebar.collapsed-desktop .sidebar-text,
        .admin-sidebar.collapsed-desktop .nav-item-count,
        .admin-sidebar.collapsed-desktop .logo-full {
            display: none;
        }
        .admin-sidebar.collapsed-desktop .logo-icon {
            display: inline-block; /* РџРѕРєР°Р·С‹РІР°РµРј РёРєРѕРЅРєСѓ Р»РѕРіРѕС‚РёРїР° */
        }
        .admin-sidebar.collapsed-desktop .nav-link i {
            margin-right: 0; /* РЈР±РёСЂР°РµРј РѕС‚СЃС‚СѓРї Сѓ РёРєРѕРЅРѕРє */
        }
        .admin-sidebar.collapsed-desktop .nav-link {
            justify-content: center; /* Р¦РµРЅС‚СЂРёСЂСѓРµРј РёРєРѕРЅРєСѓ */
        }

        /* РЎС‚РёР»Рё РґР»СЏ РјРѕР±РёР»СЊРЅРѕРіРѕ СЃРєСЂС‹С‚РёСЏ/РїРѕРєР°Р·Р° */
        @media (max-width: 767px) { /* РњРµРЅСЊС€Рµ md Р±СЂРµР№РєРїРѕРёРЅС‚Р° Tailwind */
            .admin-sidebar {
                position: fixed; /* Р¤РёРєСЃРёСЂСѓРµРј РґР»СЏ РІС‹РµР·Р¶Р°РЅРёСЏ */
                left: 0;
                top: 0;
                bottom: 0;
                height: 100vh; /* Р’Р°Р¶РЅРѕ РґР»СЏ РїСЂР°РІРёР»СЊРЅРѕРіРѕ СЃРєСЂРѕР»Р»Р° РЅР° РјРѕР±РёР»СЊРЅС‹С… */
                z-index: 40; /* Р’С‹С€Рµ РѕРІРµСЂР»РµСЏ */
                transform: translateX(-100%); /* РР·РЅР°С‡Р°Р»СЊРЅРѕ СЃРєСЂС‹С‚ Р·Р° СЌРєСЂР°РЅРѕРј */
            }
            .admin-sidebar.mobile-visible {
                transform: translateX(0); /* РџРѕРєР°Р·С‹РІР°РµРј */
            }
            /* РЎР±СЂР°СЃС‹РІР°РµРј РґРµСЃРєС‚РѕРїРЅС‹Рµ СЃС‚РёР»Рё РґР»СЏ СЃРІРµСЂРЅСѓС‚РѕРіРѕ СЃРѕСЃС‚РѕСЏРЅРёСЏ РЅР° РјРѕР±РёР»СЊРЅС‹С… */
            .admin-sidebar.collapsed-desktop, 
            .admin-sidebar.mobile-visible.collapsed-desktop { 
                width: 16rem; /* Р’РѕР·РІСЂР°С‰Р°РµРј РїРѕР»РЅСѓСЋ С€РёСЂРёРЅСѓ РЅР° РјРѕР±РёР»СЊРЅС‹С… */
            }
            .admin-sidebar.mobile-visible .sidebar-text,
            .admin-sidebar.mobile-visible .nav-item-count,
            .admin-sidebar.mobile-visible .logo-full {
                display: inline-block; /* РџРѕРєР°Р·С‹РІР°РµРј С‚РµРєСЃС‚ РЅР° РјРѕР±РёР»СЊРЅС‹С… */
            }
            .admin-sidebar.mobile-visible .logo-icon {
                display: none; /* РЎРєСЂС‹РІР°РµРј РёРєРѕРЅРєСѓ Р»РѕРіРѕ РЅР° РјРѕР±РёР»СЊРЅС‹С… */
            }
             .admin-sidebar.mobile-visible .nav-link i {
                margin-right: 0.75rem; /* Р’РѕР·РІСЂР°С‰Р°РµРј РѕС‚СЃС‚СѓРї */
            }
            .admin-sidebar.mobile-visible .nav-link {
                justify-content: flex-start; /* Р’РѕР·РІСЂР°С‰Р°РµРј РІС‹СЂР°РІРЅРёРІР°РЅРёРµ */
            }
            .admin-content {
                 margin-left: 0 !important; /* РЈР±РёСЂР°РµРј РѕС‚СЃС‚СѓРї РєРѕРЅС‚РµРЅС‚Р° РЅР° РјРѕР±РёР»СЊРЅС‹С…, РєРѕРіРґР° СЃР°Р№РґР±Р°СЂ РІС‹РµР·Р¶Р°РµС‚ */
            }
        }

        .admin-content {
            transition: margin-left 0.3s ease-in-out;
        }
        .form-input, .form-select, .form-textarea {
            @apply px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm;
        }
        .form-label {
            @apply block text-sm font-medium text-gray-700 mb-1;
        }
        .btn {
            @apply font-medium py-2 px-4 rounded-md shadow-sm transition-colors duration-150 ease-in-out;
        }
        .btn-primary { @apply bg-sky-600 hover:bg-sky-700 text-white; }
        .btn-secondary { @apply bg-gray-200 hover:bg-gray-300 text-gray-800; }
        .btn-success { @apply bg-green-500 hover:bg-green-600 text-white; }
        .btn-danger { @apply bg-red-500 hover:bg-red-600 text-white; }
        
        .nav-item-count { 
            @apply ml-auto text-xs bg-sky-500 text-white rounded-full px-1.5 py-0.5; 
        }
        #notification-container { 
            @apply fixed top-4 right-4 z-[1050] space-y-2; 
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .notification-item { 
            animation: fadeIn 0.3s ease-out, slideIn 0.3s ease-out; 
        }
        .notification-item.fade-out { 
            opacity: 0; 
            transform: translateX(100%); 
            transition: opacity 0.3s ease-in, transform 0.3s ease-in; 
        }
        .table th { @apply px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50; }
        .table td { @apply px-4 py-3 whitespace-nowrap text-sm text-gray-700; }
        .table tbody tr:nth-child(even) { @apply bg-gray-50; }

        .sidebar-logo-container {
            @apply px-4 py-4 border-b border-gray-700 flex items-center justify-center;
            min-height: 4rem; /* Р’С‹СЃРѕС‚Р° С…РµРґРµСЂР° */
        }
        .logo-icon { display: none; } /* РџРѕ СѓРјРѕР»С‡Р°РЅРёСЋ СЃРєСЂС‹С‚, Р±СѓРґРµС‚ РїРѕРєР°Р·Р°РЅ РІ collapsed-desktop */

    </style>
    {% block head_styles %}{% endblock %}
</head>
<body class="flex h-screen overflow-hidden">

    <aside id="admin-sidebar" class="admin-sidebar w-64 bg-gray-800 text-gray-100 flex flex-col print:hidden md:relative md:translate-x-0">
        <div class="sidebar-logo-container">
            <a href="{{ url_for('admin_dashboard') }}" class="text-2xl font-semibold text-white">
                <span class="logo-full">РњРµР±РµР»СЊ<span class="text-orange-400">РџСЂР°Р№СЃ</span>РђРґРјРёРЅ</span>
                <i class="fas fa-store-alt logo-icon text-2xl text-orange-400"></i> </a>
        </div>
        <nav class="flex-grow px-3 py-4 space-y-1.5 overflow-y-auto">
            <a href="{{ url_for('admin_dashboard') }}" class="nav-link flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 {% if request.endpoint == 'admin_dashboard' %}bg-gray-700 text-sky-400{% else %}text-gray-300 hover:text-sky-300{% endif %}">
                <i class="fas fa-tachometer-alt w-5 h-5 mr-3"></i> <span class="sidebar-text">Р”Р°С€Р±РѕСЂРґ</span>
            </a>
            <a href="{{ url_for('admin_products') }}" class="nav-link flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 {% if request.endpoint in ['admin_products', 'admin_add_product', 'admin_edit_product'] %}bg-gray-700 text-sky-400{% else %}text-gray-300 hover:text-sky-300{% endif %}">
                <i class="fas fa-box-open w-5 h-5 mr-3"></i> <span class="sidebar-text">РўРѕРІР°СЂС‹</span>
            </a>
            <a href="{{ url_for('admin_techcard_list') }}" class="nav-link flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 {% if request.endpoint == 'admin_techcard_list' %}bg-gray-700 text-sky-400{% else %}text-gray-300 hover:text-sky-300{% endif %}">
                <i class="fas fa-clipboard-list w-5 h-5 mr-3"></i> <span class="sidebar-text">РўРµС…РєР°СЂС‚С‹</span>
            </a>
            <a href="{{ url_for('admin_approval_tasks') }}" class="nav-link flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 {% if request.endpoint in ['admin_approval_tasks', 'admin_approval_task_detail'] %}bg-gray-700 text-sky-400{% else %}text-gray-300 hover:text-sky-300{% endif %}">
                <i class="fas fa-tasks w-5 h-5 mr-3"></i> <span class="sidebar-text">РЎРѕРіР»Р°СЃРѕРІР°РЅРёРµ</span> <span class="nav-item-count sidebar-text" id="nav-approval-count-sidebar-base">{{ pending_approvals_count if pending_approvals_count > 0 else '' }}</span>
            </a>
            <a href="{{ url_for('admin_raw_materials') }}" class="nav-link flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 {% if request.endpoint == 'admin_raw_materials' %}bg-gray-700 text-sky-400{% else %}text-gray-300 hover:text-sky-300{% endif %}">
                <i class="fas fa-cubes w-5 h-5 mr-3"></i> <span class="sidebar-text">РЎС‹СЂСЊС‘ Рё Р¦РµРЅС‹</span>
            </a>
            <a href="{{ url_for('admin_dealers_list') }}" class="nav-link flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 {% if request.endpoint == 'admin_dealers_list' %}bg-gray-700 text-sky-400{% else %}text-gray-300 hover:text-sky-300{% endif %}">
                <i class="fas fa-handshake w-5 h-5 mr-3"></i> <span class="sidebar-text">Р”РёР»РµСЂС‹</span>
            </a>
            <a href="{{ url_for('admin_users') }}" class="nav-link flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 {% if request.endpoint == 'admin_users' %}bg-gray-700 text-sky-400{% else %}text-gray-300 hover:text-sky-300{% endif %}">
                <i class="fas fa-users-cog w-5 h-5 mr-3"></i> <span class="sidebar-text">РџРѕР»СЊР·РѕРІР°С‚РµР»Рё</span>
            </a>
            
            <div class="mt-auto pt-4 border-t border-gray-700">
                 <a href="{{ url_for('index') }}" class="nav-link flex items-center px-3 py-2.5 text-sm font-medium rounded-md text-gray-400 hover:bg-gray-700 hover:text-sky-300">
                    <i class="fas fa-home w-5 h-5 mr-3"></i> <span class="sidebar-text">РќР° СЃР°Р№С‚</span>
                </a>
                <a href="{{ url_for('logout') }}" class="nav-link flex items-center px-3 py-2.5 text-sm font-medium rounded-md text-gray-400 hover:bg-gray-700 hover:text-red-400">
                    <i class="fas fa-sign-out-alt w-5 h-5 mr-3"></i> <span class="sidebar-text">Р’С‹С…РѕРґ</span>
                </a>
            </div>
        </nav>
    </aside>
    
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden" onclick="toggleMobileSidebar()"></div>

    <div class="flex-1 flex flex-col overflow-hidden admin-content">
        <header class="bg-white shadow-sm print:hidden">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <button id="sidebar-toggle-main" class="text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-sky-500">
                            <span class="sr-only">РћС‚РєСЂС‹С‚СЊ/Р—Р°РєСЂС‹С‚СЊ РјРµРЅСЋ</span>
                            <i class="fas fa-bars text-xl"></i>
                        </button>
                        <h1 class="text-xl font-semibold text-gray-800 ml-3">
                            {% block page_header %}{{ page_title | default('Р”Р°С€Р±РѕСЂРґ') }}{% endblock %}
                        </h1>
                    </div>
                    <div class="flex items-center">
                        {% if current_user %}
                        <span class="text-sm text-gray-600 mr-3 hidden sm:inline">
                            {{ current_user.first_name or current_user.username }} ({{ current_user.role }})
                        </span> 
                        <img class="h-8 w-8 rounded-full object-cover" 
                             src="https://placehold.co/100x100/7dd3fc/0c4a6e?text={{ current_user.username[0].upper() if current_user.username else 'A' }}" 
                             alt="Р¤РѕС‚Рѕ РїРѕР»СЊР·РѕРІР°С‚РµР»СЏ {{ current_user.username }}">
                        {% else %}
                        <span class="text-sm text-gray-600 mr-3">Р“РѕСЃС‚СЊ</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-x-auto overflow-y-auto bg-gray-100 p-4 sm:p-6">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="container mx-auto mb-4">
                    {% for category, message in messages %}
                        <div class="p-3 rounded-md text-sm
                            {% if category == 'success' %} bg-green-100 text-green-700 border border-green-200
                            {% elif category == 'danger' %} bg-red-100 text-red-700 border border-red-200
                            {% elif category == 'warning' %} bg-yellow-100 text-yellow-700 border border-yellow-200
                            {% else %} bg-sky-100 text-sky-700 border border-sky-200 {% endif %}"
                             role="alert">
                            {{ message }}
                        </div>
                    {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}
            
            {% block content %}{% endblock %}
        </main>
        
        <footer class="bg-white border-t border-gray-200 p-4 text-center text-sm text-gray-500 print:hidden">
            &copy; {{ now().year }} РњРµР±РµР»СЊРџСЂР°Р№СЃРџСЂРѕ. Р’СЃРµ РїСЂР°РІР° Р·Р°С‰РёС‰РµРЅС‹.
        </footer>
    </div>

    <div id="notification-container"></div>

    <script>
        const adminSidebar = document.getElementById('admin-sidebar');
        const sidebarToggleMain = document.getElementById('sidebar-toggle-main');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const mainContentArea = document.querySelector('.admin-content');

        function applyDesktopSidebarState() {
            const isCollapsed = localStorage.getItem('adminSidebarCollapsed') === 'true';
            if (isCollapsed) {
                adminSidebar.classList.add('collapsed-desktop');
                if (mainContentArea) mainContentArea.style.marginLeft = '4rem';
            } else {
                adminSidebar.classList.remove('collapsed-desktop');
                if (mainContentArea) mainContentArea.style.marginLeft = '16rem';
            }
        }

        function toggleMobileSidebar() {
            adminSidebar.classList.toggle('mobile-visible');
            sidebarOverlay.classList.toggle('hidden');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const isMobile = () => window.innerWidth < 768;

            if (sidebarToggleMain && adminSidebar) {
                sidebarToggleMain.addEventListener('click', () => {
                    if (isMobile()) {
                        toggleMobileSidebar();
                    } else {
                        adminSidebar.classList.toggle('collapsed-desktop');
                        localStorage.setItem('adminSidebarCollapsed', adminSidebar.classList.contains('collapsed-desktop') ? 'true' : 'false');
                        applyDesktopSidebarState(); // РџСЂРёРјРµРЅСЏРµРј СЃРѕСЃС‚РѕСЏРЅРёРµ, С‡С‚РѕР±С‹ СЃРґРІРёРЅСѓС‚СЊ РєРѕРЅС‚РµРЅС‚
                    }
                });
            }
            
            if (!isMobile()) {
                applyDesktopSidebarState();
            } else {
                 adminSidebar.classList.remove('collapsed-desktop'); // РЈР±РёСЂР°РµРј РґРµСЃРєС‚РѕРїРЅРѕРµ СЃРІРѕСЂР°С‡РёРІР°РЅРёРµ
                 adminSidebar.classList.add('transform', '-translate-x-full'); // РР·РЅР°С‡Р°Р»СЊРЅРѕ СЃРєСЂС‹С‚ РЅР° РјРѕР±РёР»СЊРЅС‹С…
                 if (mainContentArea) mainContentArea.style.marginLeft = '0';
            }
            
            window.addEventListener('resize', () => {
                if (!isMobile()) {
                    adminSidebar.classList.remove('mobile-visible'); // РЎРєСЂС‹РІР°РµРј РјРѕР±РёР»СЊРЅРѕРµ СЃРѕСЃС‚РѕСЏРЅРёРµ
                    sidebarOverlay.classList.add('hidden'); // РЎРєСЂС‹РІР°РµРј РѕРІРµСЂР»РµР№
                    applyDesktopSidebarState(); // РџСЂРёРјРµРЅСЏРµРј РґРµСЃРєС‚РѕРїРЅРѕРµ СЃРѕСЃС‚РѕСЏРЅРёРµ
                } else {
                    // Р•СЃР»Рё РЅР° РјРѕР±РёР»СЊРЅРѕРј, РЅРѕ СЃР°Р№РґР±Р°СЂ Р±С‹Р» РѕС‚РєСЂС‹С‚ С‡РµСЂРµР· РґРµСЃРєС‚РѕРїРЅС‹Р№ toggle,
                    // Рё РЅРµ Р±С‹Р» СЏРІРЅРѕ СЃРєСЂС‹С‚ РјРѕР±РёР»СЊРЅС‹Рј toggle, РѕРЅ РјРѕР¶РµС‚ РѕСЃС‚Р°С‚СЊСЃСЏ РІРёРґРёРјС‹Рј.
                    // РџРѕСЌС‚РѕРјСѓ РїСЂРёРЅСѓРґРёС‚РµР»СЊРЅРѕ РїСЂРёРјРµРЅСЏРµРј РѕС‚СЃС‚СѓРї РєРѕРЅС‚РµРЅС‚Р° 0.
                    if (mainContentArea) mainContentArea.style.marginLeft = '0';
                    if (!adminSidebar.classList.contains('mobile-visible')) {
                         adminSidebar.classList.add('transform', '-translate-x-full');
                    }
                }
            });

            const approvalCountBadgeBase = document.getElementById('nav-approval-count-sidebar-base');
            if (approvalCountBadgeBase) {
                 const mockCount = parseInt("{{ pending_approvals_count | default(0) }}");
                 if (mockCount > 0) {
                    approvalCountBadgeBase.textContent = mockCount;
                    approvalCountBadgeBase.classList.remove('hidden'); // РџРѕРєР°Р·С‹РІР°РµРј, РµСЃР»Рё РµСЃС‚СЊ Р·Р°РґР°С‡Рё
                 } else {
                    approvalCountBadgeBase.textContent = ''; // РћС‡РёС‰Р°РµРј, РµСЃР»Рё 0
                    approvalCountBadgeBase.classList.add('hidden'); // РЎРєСЂС‹РІР°РµРј, РµСЃР»Рё 0
                 }
            }
        });

        function showNotification(message, type = 'info', duration = 3500) {
            const notificationContainer = document.getElementById('notification-container');
            if (!notificationContainer) {
                console.warn("РљРѕРЅС‚РµР№РЅРµСЂ СѓРІРµРґРѕРјР»РµРЅРёР№ #notification-container РЅРµ РЅР°Р№РґРµРЅ.");
                alert(message); 
                return;
            }
            const notif = document.createElement('div');
            notif.className = `notification-item max-w-sm w-full bg-white shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden m-2
                ${ type === 'success' ? 'border-green-500' : 
                   type === 'error'   ? 'border-red-500'   : 
                   type === 'warning' ? 'border-yellow-500': 'border-sky-500' }`;
            let iconHtml = '';
            let textColor = 'text-gray-900';
            if (type === 'success') {
                iconHtml = '<i class="fas fa-check-circle text-green-500"></i>';
                textColor = 'text-green-700';
            } else if (type === 'error') {
                iconHtml = '<i class="fas fa-exclamation-triangle text-red-500"></i>';
                textColor = 'text-red-700';
            } else if (type === 'warning') {
                iconHtml = '<i class="fas fa-exclamation-circle text-yellow-500"></i>';
                textColor = 'text-yellow-700';
            } else { 
                iconHtml = '<i class="fas fa-info-circle text-sky-500"></i>';
                textColor = 'text-sky-700';
            }
            notif.innerHTML = `
                <div class="p-4">
                  <div class="flex items-start">
                    <div class="flex-shrink-0">${iconHtml}</div>
                    <div class="ml-3 w-0 flex-1 pt-0.5"><p class="text-sm font-medium ${textColor}">${message}</p></div>
                    <div class="ml-4 flex-shrink-0 flex">
                      <button type="button" class="inline-flex bg-white rounded-md text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500" onclick="this.closest('.notification-item').remove()">
                        <span class="sr-only">Р—Р°РєСЂС‹С‚СЊ</span><i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                </div>`;
            notificationContainer.appendChild(notif);
            setTimeout(() => {
                notif.classList.add('fade-out');
                setTimeout(() => notif.remove(), 300); 
            }, duration);
        }
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>

--- Файл: admin_dealers_list.txt ---

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Дилеры и Оптовики - МебельПрайсПро Админ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* gray-100 */
        }
        .admin-sidebar {
            transition: width 0.3s ease-in-out;
        }
        .admin-content {
            transition: margin-left 0.3s ease-in-out;
        }
        .form-input, .form-select, .form-textarea {
            @apply px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm;
        }
        .form-label {
            @apply block text-sm font-medium text-gray-700 mb-1;
        }
        .table th.sortable-header { 
            @apply cursor-pointer hover:bg-gray-100 relative; 
        }
        .table th .sort-icon-container { 
            @apply inline-flex items-center justify-center ml-1.5 align-middle;
            width: 1em; 
            height: 1em;
        }
        .table th svg.sort-icon {
            @apply h-full w-full;
        }
        .table th svg.sort-icon.neutral { @apply text-gray-400; }
        .table th svg.sort-icon.asc, .table th svg.sort-icon.desc { @apply text-sky-600; }
        
        .table td { @apply px-4 py-3 whitespace-nowrap text-sm text-gray-700; }
        .table tbody tr:nth-child(even) { @apply bg-gray-50; }
        .btn { @apply font-medium py-2 px-4 rounded-md shadow-sm transition-colors duration-150; }
        .btn-primary { @apply bg-sky-600 hover:bg-sky-700 text-white; }
        .btn-secondary { @apply bg-gray-200 hover:bg-gray-300 text-gray-700; }
        .btn-success { @apply bg-green-500 hover:bg-green-600 text-white; }
        .btn-danger { @apply bg-red-500 hover:bg-red-600 text-white; }
        .btn-warning { @apply bg-yellow-500 hover:bg-yellow-600 text-white; }
        .btn-icon { @apply p-1.5; }
        .nav-item-count { @apply ml-auto text-xs bg-sky-500 text-white rounded-full px-1.5 py-0.5; }
        .status-badge { @apply px-2 inline-flex text-xs leading-5 font-semibold rounded-full; }
        .status-active { @apply bg-green-100 text-green-800; }
        .status-inactive { @apply bg-red-100 text-red-800; }
    </style>
</head>
<body class="flex h-screen">

    <aside id="admin-sidebar" class="admin-sidebar w-64 bg-gray-800 text-gray-100 flex flex-col transition-all duration-300 ease-in-out">
        <div class="px-6 py-4 border-b border-gray-700">
            <a href="admin_dashboard.html" class="text-2xl font-semibold text-white">Мебель<span class="text-orange-400">Прайс</span>Админ</a>
        </div>
        <nav class="flex-grow px-3 py-4 space-y-1.5">
            <a href="admin_dashboard.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                Дашборд
            </a>
            <a href="admin_products.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                 <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                Товары
            </a>
            <a href="admin_techcard_list.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.153 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM10.5 16.5h3.75m-3.75 0h3.75" /></svg>
                Техкарты (Редактор)
            </a>
            <a href="admin_approval_tasks.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                 <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                Согласование Техкарт <span class="nav-item-count" id="nav-approval-count-sidebar">3</span>
            </a>
            <a href="admin_raw_materials.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10.5 11.25h3M12 15h.008m-7.008 0h14.016m0 0A48.108 48.108 0 0012 15c-2.282 0-4.441.68-6.267 1.875M7.5 7.5h9M3.75 7.5A2.25 2.25 0 016 5.25h12a2.25 2.25 0 012.25 2.25m0 0A2.25 2.25 0 0019.5 6c-.023 0-.046.002-.069.004l-.01.002-.008.001-.002.001-.002 0a.002.002 0 01-.002 0l-.002.001-.008.001-.01.002A2.232 2.232 0 0019.5 6c-1.24 0-2.25.985-2.25 2.188V7.5M3.75 7.5c0 .067.003.132.008.196M12 15c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125h0c-.621 0-1.125.504-1.125 1.125v4.5c0 .621.504 1.125 1.125 1.125h0z" /></svg>
                Сырьё и Цены
            </a>
             <a href="admin_dealers_list.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md bg-gray-900 text-sky-400"> <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345h5.518a.562.562 0 01.329 1.004l-4.243 2.97a.563.563 0 00-.178.643l2.125 5.111a.563.563 0 01-.83.632l-4.243-2.97a.563.563 0 00-.652 0l-4.243 2.97a.563.563 0 01-.83-.632l2.125-5.111a.563.563 0 00-.178-.643l-4.243-2.97a.562.562 0 01.329-1.004h5.518a.563.563 0 00.475-.345L11.48 3.5z" />
                </svg>
                Дилеры и Оптовики
            </a>
            <a href="admin_users.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" /></svg>
                Пользователи
            </a>
            <a href="../html/index.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 text-red-400 hover:text-red-300 mt-auto">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" /></svg>
                Выход (на сайт)
            </a>
        </nav>
    </aside>

    <div class="flex-1 flex flex-col overflow-hidden">
        <header class="bg-white shadow-sm">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <button id="sidebar-toggle" class="text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-sky-500 md:hidden">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        </button>
                        <h1 class="text-xl font-semibold text-gray-800 ml-3">Дилеры и Оптовики</h1>
                    </div>
                    <div class="flex items-center">
                        <span class="text-sm text-gray-600 mr-3">Администратор</span>
                        <img class="h-8 w-8 rounded-full object-cover" src="https://placehold.co/100x100/7dd3fc/0c4a6e?text=A" alt="[Фото пользователя]">
                    </div>
                </div>
            </div>
        </header>
        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
            <div class="container mx-auto">
                <div class="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                    <h2 class="text-2xl font-semibold text-gray-800">Список Дилеров/Оптовиков (<span id="total-dealers-count">12</span>)</h2>
                    <a href="admin_dealer_edit.html" class="btn btn-success">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline -ml-1 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                        Добавить дилера/оптовика
                    </a>
                </div>
                
                <div class="bg-white p-4 rounded-md shadow mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="filter-dealer-search" class="form-label">Поиск:</label>
                            <input type="text" id="filter-dealer-search" placeholder="Название, ИНН, контакт..." class="form-input w-full">
                        </div>
                        <div>
                            <label for="filter-dealer-status" class="form-label">Статус:</label>
                            <select id="filter-dealer-status" class="form-select w-full">
                                <option value="">Все статусы</option>
                                <option value="active">Активен</option>
                                <option value="inactive">Неактивен</option>
                            </select>
                        </div>
                        <div class="flex space-x-2 items-end">
                            <button class="btn btn-primary w-full sm:w-auto">Применить</button>
                            <button class="btn btn-secondary w-full sm:w-auto">Сбросить</button>
                        </div>
                    </div>
                </div>

                <div class="bg-white shadow-md rounded-lg overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 table" id="dealers-table">
                        <thead>
                            <tr>
                                <th class="sortable-header" data-sort-by="id">ID <span class="sort-icon-container"></span></th>
                                <th class="sortable-header" data-sort-by="name">Наименование/ФИО <span class="sort-icon-container"></span></th>
                                <th class="sortable-header" data-sort-by="contact_person">Контактное лицо <span class="sort-icon-container"></span></th>
                                <th class="sortable-header" data-sort-by="email">Email <span class="sort-icon-container"></span></th>
                                <th class="sortable-header" data-sort-by="phone">Телефон <span class="sort-icon-container"></span></th>
                                <th class="sortable-header" data-sort-by="discount">Скидка (%) <span class="sort-icon-container"></span></th>
                                <th class="sortable-header" data-sort-by="status">Статус <span class="sort-icon-container"></span></th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td>D001</td>
                                <td>ОсОО "СтройМир Плюс"</td>
                                <td>Асанов Руслан</td>
                                <td>stroymir@example.com</td>
                                <td>+996 (550) 112233</td>
                                <td class="text-right">15%</td>
                                <td><span class="status-badge status-active">Активен</span></td>
                                <td class="flex items-center space-x-1 py-3">
                                    <a href="admin_dealer_edit.html?id=D001" class="btn btn-primary btn-icon" title="Редактировать">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                    </a>
                                    <button class="btn btn-warning btn-icon toggle-dealer-status-btn" data-id="D001" data-current-status="active" title="Деактивировать">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg>
                                    </button>
                                     <a href="admin_dealer_purchase_history.html?id=D001" class="btn btn-secondary btn-icon" title="История покупок">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12c0-1.232-.046-2.453-.138-3.662a4.006 4.006 0 00-3.7-3.7 48.678 48.678 0 00-7.324 0 4.006 4.006 0 00-3.7 3.7c-.092 1.21-.138 2.43-.138 3.662v2.159c0 1.232.046 2.453.138 3.662a4.006 4.006 0 003.7 3.7 48.656 48.656 0 007.324 0 4.006 4.006 0 003.7-3.7c.092-1.21.138-2.43.138-3.662v-2.159z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0012 21a8.967 8.967 0 000-14.958m0 0A8.966 8.966 0 0112 2.25a8.966 8.966 0 010 14.958m0-14.958L12 6.042m0 0a2.25 2.25 0 00-2.25 2.25m0 0a2.25 2.25 0 012.25 2.25m0 0a2.25 2.25 0 002.25-2.25m0 0a2.25 2.25 0 01-2.25-2.25m0 0a2.25 2.25 0 00-2.25 2.25" /></svg>
                                    </a>
                                </td>
                            </tr>
                             <tr>
                                <td>D002</td>
                                <td>ИП "Умаров Т.А."</td>
                                <td>Умаров Тимур</td>
                                <td>umarov.t@example.com</td>
                                <td>+996 (700) 445566</td>
                                <td class="text-right">10%</td>
                                <td><span class="status-badge status-inactive">Неактивен</span></td>
                                <td class="flex items-center space-x-1 py-3">
                                    <a href="admin_dealer_edit.html?id=D002" class="btn btn-primary btn-icon" title="Редактировать">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                    </a>
                                    <button class="btn btn-success btn-icon toggle-dealer-status-btn" data-id="D002" data-current-status="inactive" title="Активировать">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                                    </button>
                                     <a href="admin_dealer_purchase_history.html?id=D002" class="btn btn-secondary btn-icon" title="История покупок">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12c0-1.232-.046-2.453-.138-3.662a4.006 4.006 0 00-3.7-3.7 48.678 48.678 0 00-7.324 0 4.006 4.006 0 00-3.7 3.7c-.092 1.21-.138 2.43-.138 3.662v2.159c0 1.232.046 2.453.138 3.662a4.006 4.006 0 003.7 3.7 48.656 48.656 0 007.324 0 4.006 4.006 0 003.7-3.7c.092-1.21.138-2.43.138-3.662v-2.159z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0012 21a8.967 8.967 0 000-14.958m0 0A8.966 8.966 0 0112 2.25a8.966 8.966 0 010 14.958m0-14.958L12 6.042m0 0a2.25 2.25 0 00-2.25 2.25m0 0a2.25 2.25 0 012.25 2.25m0 0a2.25 2.25 0 002.25-2.25m0 0a2.25 2.25 0 01-2.25-2.25m0 0a2.25 2.25 0 00-2.25 2.25" /></svg>
                                    </a>
                                </td>
                            </tr>
                            </tbody>
                    </table>
                </div>
                <div class="mt-6 flex justify-center">
                     <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        <a href="#" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                          <span class="sr-only">Предыдущая</span>
                          <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        </a>
                        <a href="#" aria-current="page" class="z-10 bg-sky-50 border-sky-500 text-sky-600 relative inline-flex items-center px-4 py-2 border text-sm font-medium">1</a>
                        <a href="#" class="bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium">2</a>
                        <a href="#" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                          <span class="sr-only">Следующая</span>
                          <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                        </a>
                      </nav>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const sidebar = document.getElementById('admin-sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');

            if (sidebarToggle && sidebar) {
                sidebarToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('w-64');
                    sidebar.classList.toggle('w-16');
                });
            }

            const approvalCountBadge = document.getElementById('nav-approval-count-sidebar');
            if (approvalCountBadge) {
                approvalCountBadge.textContent = '3';
            }

            const sortableHeaders = document.querySelectorAll('#dealers-table th.sortable-header');
            let currentSort = { column: null, direction: 'none' };
            const sortIconAsc = `<svg class="sort-icon asc" viewBox="0 0 20 20" fill="currentColor"><polygon points="10 4 4.5 13 15.5 13"></polygon></svg>`;
            const sortIconDesc = `<svg class="sort-icon desc" viewBox="0 0 20 20" fill="currentColor"><polygon points="10 16 4.5 7 15.5 7"></polygon></svg>`;
            const sortIconNeutral = `<svg class="sort-icon neutral" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 15L12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9"></path></svg>`;

            sortableHeaders.forEach(header => {
                const sortIconContainer = header.querySelector('.sort-icon-container');
                if (sortIconContainer) sortIconContainer.innerHTML = sortIconNeutral;
                header.addEventListener('click', () => { /* ... логика сортировки ... */ });
            });

            document.querySelectorAll('.toggle-dealer-status-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const dealerId = event.currentTarget.dataset.id;
                    const currentStatus = event.currentTarget.dataset.currentStatus;
                    const newStatusActionText = currentStatus === 'active' ? 'Деактивировать' : 'Активировать';
                    const dealerName = event.currentTarget.closest('tr').querySelector('td:nth-child(2)').textContent;
                    if (confirm(`Вы уверены, что хотите сделать дилера "${dealerName}" ${newStatusActionText.toLowerCase()}?`)) {
                        console.log(`${newStatusActionText} дилера ID ${dealerId}`);
                        alert(`Статус дилера "${dealerName}" изменен (имитация).`);
                        const statusBadge = event.currentTarget.closest('tr').querySelector('.status-badge');
                        const iconActivate = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>`;
                        const iconDeactivate = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg>`;

                        if (currentStatus === 'active') {
                            statusBadge.classList.remove('status-active');
                            statusBadge.classList.add('status-inactive');
                            statusBadge.textContent = 'Неактивен';
                            event.currentTarget.dataset.currentStatus = 'inactive';
                            event.currentTarget.title = 'Активировать';
                            event.currentTarget.innerHTML = iconActivate;
                            event.currentTarget.classList.remove('btn-warning');
                            event.currentTarget.classList.add('btn-success');
                        } else {
                            statusBadge.classList.remove('status-inactive');
                            statusBadge.classList.add('status-active');
                            statusBadge.textContent = 'Активен';
                            event.currentTarget.dataset.currentStatus = 'active';
                            event.currentTarget.title = 'Деактивировать';
                            event.currentTarget.innerHTML = iconDeactivate;
                            event.currentTarget.classList.remove('btn-success');
                            event.currentTarget.classList.add('btn-warning');
                        }
                    }
                });
            });
        });
    </script>
</body>
</html>

--- Файл: admin_dealer_edit.txt ---

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }} - МебельПрайсПро Админ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .admin-sidebar { transition: width 0.3s ease-in-out; }
        .admin-content { transition: margin-left 0.3s ease-in-out; }
        .form-input, .form-select, .form-textarea { @apply px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm; }
        .form-label { @apply block text-sm font-medium text-gray-700 mb-1; }
        .btn { @apply font-medium py-2 px-4 rounded-md shadow-sm transition-colors duration-150 ease-in-out; }
        .btn-primary { @apply bg-sky-600 hover:bg-sky-700 text-white; }
        .btn-secondary { @apply bg-gray-200 hover:bg-gray-300 text-gray-800; }
        .btn-success { @apply bg-green-500 hover:bg-green-600 text-white; }
        .btn-warning { @apply bg-yellow-500 hover:bg-yellow-600 text-white; }
        .btn-danger { @apply bg-red-500 hover:bg-red-600 text-white; }
        .nav-item-count { @apply ml-auto text-xs bg-sky-500 text-white rounded-full px-1.5 py-0.5; }
        
        .image-uploader-preview-container { @apply relative group border border-gray-300 rounded-md overflow-hidden w-24 h-24; }
        .image-uploader-preview { @apply w-full h-full object-cover cursor-grab; }
        .image-uploader-preview.sortable-ghost { @apply opacity-50 border-2 border-sky-500; }
        .image-uploader-preview.main-image-indicator { @apply border-2 border-sky-600 shadow-lg; }
        .image-uploader-add { @apply w-24 h-24 border-2 border-dashed border-gray-300 rounded-md flex items-center justify-center text-gray-400 hover:border-sky-500 hover:text-sky-500 cursor-pointer; }
        .image-upload-dropzone { @apply border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-sky-500 bg-gray-50 transition-colors duration-150 ease-in-out; }
        .image-upload-dropzone.dragover { @apply border-sky-500 bg-sky-50 ring-2 ring-sky-500 ring-offset-1; }
        
        .markup-slider-container { @apply flex items-center space-x-3; }
        .markup-slider { @apply w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer; }
        .markup-slider-green::-webkit-slider-thumb { @apply bg-green-500; }
        .markup-slider-green::-moz-range-thumb { @apply bg-green-500; }
        .markup-slider-yellow::-webkit-slider-thumb { @apply bg-yellow-500; }
        .markup-slider-yellow::-moz-range-thumb { @apply bg-yellow-500; }
        .markup-slider-orange::-webkit-slider-thumb { @apply bg-orange-500; }
        .markup-slider-orange::-moz-range-thumb { @apply bg-orange-500; }
        .markup-slider-red::-webkit-slider-thumb { @apply bg-red-500; }
        .markup-slider-red::-moz-range-thumb { @apply bg-red-500; }
        .markup-slider::-webkit-slider-thumb { @apply appearance-none w-5 h-5 rounded-full shadow-md cursor-pointer transition-colors; background-color: #3b82f6; }
        .markup-slider::-moz-range-thumb { @apply w-5 h-5 rounded-full shadow-md cursor-pointer border-none transition-colors; background-color: #3b82f6; }
        
        .status-badge { @apply px-2 py-0.5 text-xs font-medium rounded-full inline-block; }
        .status-approved { @apply bg-green-100 text-green-800; }
        .status-pending-accountant { @apply bg-yellow-100 text-yellow-700; }
        .status-pending-manager { @apply bg-orange-100 text-orange-700; }
        .status-draft { @apply bg-gray-200 text-gray-800; }
        .status-rejected { @apply bg-red-100 text-red-800; }
        .status-archived { @apply bg-slate-100 text-slate-600; }
        .status-not-found { @apply bg-gray-100 text-gray-500; }
        .status-needs-prices { @apply bg-amber-100 text-amber-800; } 

        /* Стили для модального окна техкарты */
        .modal-overlay { @apply fixed inset-0 bg-gray-600 bg-opacity-75 transition-opacity; }
        .modal-content { @apply bg-white rounded-lg shadow-xl transform transition-all sm:max-w-3xl w-full p-6; } 
        .modal-table th { @apply px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50; }
        .modal-table td { @apply px-3 py-2 whitespace-nowrap text-sm text-gray-600; }
        .modal-table tbody tr:nth-child(even) { @apply bg-gray-50; }
        .modal-component-not-found td { @apply bg-red-50 text-red-700; }
        .modal-component-new td { @apply bg-yellow-50 text-yellow-700; }
        .modal-price-placeholder { @apply font-semibold; }

        #drop-area-modal {
            @apply mt-2 p-6 border-2 border-dashed border-gray-300 rounded-md text-center cursor-pointer 
                   hover:border-sky-500 hover:bg-sky-50 transition-colors duration-150 ease-in-out
                   flex flex-col items-center justify-center min-h-[100px]; 
        }
        #drop-area-modal.dragover { 
            @apply border-sky-500 bg-sky-100 ring-2 ring-sky-500 ring-offset-2; 
        }
        #drop-area-modal p { @apply text-sm text-gray-600 pointer-events-none; }
        #drop-area-modal svg { @apply w-10 h-10 text-gray-400 mb-2 pointer-events-none; }
        #file-info-modal { @apply text-sm text-gray-700 mt-2 font-medium; }

        #notification-container { @apply fixed top-4 right-4 z-[1050] space-y-2; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .notification-item { animation: fadeIn 0.3s ease-out, slideIn 0.3s ease-out; }
        .notification-item.fade-out { opacity: 0; transform: translateX(100%); transition: opacity 0.3s ease-in, transform 0.3s ease-in; }
    </style>
</head>
<body class="flex h-screen">

    <aside id="admin-sidebar" class="admin-sidebar w-64 bg-gray-800 text-gray-100 flex flex-col transition-all duration-300 ease-in-out">
        <div class="px-6 py-4 border-b border-gray-700">
            <a href="{{ url_for('admin_dashboard') }}" class="text-2xl font-semibold text-white">Мебель<span class="text-orange-400">Прайс</span>Админ</a>
        </div>
        <nav class="flex-grow px-3 py-4 space-y-1.5">
            <a href="{{ url_for('admin_dashboard') }}" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                Дашборд
            </a>
            <a href="{{ url_for('admin_products') }}" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md bg-gray-900 text-sky-400"> <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                Товары
            </a>
            <a href="{{ url_for('admin_techcard_list') }}" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.153 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM10.5 16.5h3.75m-3.75 0h3.75" /></svg>
                Техкарты (Редактор)
            </a>
            <a href="{{ url_for('admin_approval_tasks') }}" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                 <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                Согласование Техкарт <span class="nav-item-count" id="nav-approval-count-sidebar">0</span>
            </a>
            <a href="{{ url_for('admin_raw_materials') }}" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10.5 11.25h3M12 15h.008m-7.008 0h14.016m0 0A48.108 48.108 0 0012 15c-2.282 0-4.441.68-6.267 1.875M7.5 7.5h9M3.75 7.5A2.25 2.25 0 016 5.25h12a2.25 2.25 0 012.25 2.25m0 0A2.25 2.25 0 0019.5 6c-.023 0-.046.002-.069.004l-.01.002-.008.001-.002.001-.002 0a.002.002 0 01-.002 0l-.002.001-.008.001-.01.002A2.232 2.232 0 0019.5 6c-1.24 0-2.25.985-2.25 2.188V7.5M3.75 7.5c0 .067.003.132.008.196M12 15c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125h0c-.621 0-1.125.504-1.125 1.125v4.5c0 .621.504 1.125 1.125 1.125h0z" /></svg>
                Сырьё и Цены
            </a>
             <a href="{{ url_for('admin_dealers_list') }}" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345h5.518a.562.562 0 01.329 1.004l-4.243 2.97a.563.563 0 00-.178.643l2.125 5.111a.563.563 0 01-.83.632l-4.243-2.97a.563.563 0 00-.652 0l-4.243 2.97a.563.563 0 01-.83-.632l2.125-5.111a.563.563 0 00-.178-.643l-4.243-2.97a.562.562 0 01.329-1.004h5.518a.563.563 0 00.475-.345L11.48 3.5z" />
                </svg>
                Дилеры и Оптовики
            </a>
            <a href="{{ url_for('admin_users') }}" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" /></svg>
                Пользователи
            </a>
            <a href="{{ url_for('index') }}" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 text-red-400 hover:text-red-300 mt-auto">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" /></svg>
                Выход (на сайт)
            </a>
        </nav>
    </aside>

    <div class="flex-1 flex flex-col overflow-hidden">
        <header class="bg-white shadow-sm">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <button id="sidebar-toggle" class="text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-sky-500 md:hidden">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        </button>
                        <h1 class="text-xl font-semibold text-gray-800 ml-3" id="page-title-main">{{ page_title }}</h1>
                    </div>
                     <div class="flex items-center">
                        <span class="text-sm text-gray-600 mr-3">Администратор</span> 
                        <img class="h-8 w-8 rounded-full object-cover" src="https://placehold.co/100x100/7dd3fc/0c4a6e?text={{ current_user.username[0].upper() if current_user and current_user.username else 'A' }}" alt="[Фото пользователя]">
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
            <div class="container mx-auto">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="mb-4 p-4 rounded-md 
                                {% if category == 'success' %} bg-green-100 text-green-700 
                                {% elif category == 'danger' %} bg-red-100 text-red-700 
                                {% elif category == 'warning' %} bg-yellow-100 text-yellow-700
                                {% else %} bg-sky-100 text-sky-700 {% endif %}"
                                 role="alert">
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <form id="product-form" method="POST" 
                      action="{{ url_for('admin_edit_product', product_id=product.id) if product and product.id else url_for('admin_add_product') }}"
                      enctype="multipart/form-data">
                    {{ form.hidden_tag() if form }} 
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 space-y-6">
                           <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">Основная информация</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="product-name" class="form-label">Наименование товара <span class="text-red-500">*</span></label>
                                        <input type="text" name="name" id="product-name" class="form-input w-full" 
                                               value="{{ product.name if product else (product_data.name if product_data else '') }}" required>
                                    </div>
                                    <div>
                                        <label for="product-sku" class="form-label">Артикул (SKU) <span class="text-red-500">*</span></label>
                                        <input type="text" name="sku" id="product-sku" class="form-input w-full" 
                                               value="{{ product.sku if product else (product_data.sku if product_data else '') }}" required>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">Ценообразование и Наличие</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                                    <div>
                                        <label for="product-cost-price" class="form-label">Себестоимость (сом)</label>
                                        <div class="flex items-center space-x-2">
                                            <input type="number" name="cost_price" id="product-cost-price" class="form-input w-full" 
                                                   step="0.01" min="0" placeholder="0.00" value="{{ '%.2f'|format(product.cost_price|float) if product and product.cost_price is not none else (product_data.cost_price if product_data else '') }}">
                                            <button type="button" id="fetch-cost-from-techcard" class="btn btn-secondary text-xs whitespace-nowrap" title="Подтянуть из утвержденной техкарты">Авто (ТК)</button>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">Источник: <span id="cost-price-source">{% if product and product.cost_price_source %}{{ product.cost_price_source }}{% else %}Не указана{% endif %}</span></p>
                                    </div>
                                    <div>
                                        <label for="product-markup-percentage" class="form-label">Розничная наценка (%)</label>
                                        <div class="markup-slider-container">
                                            <input type="range" name="markup_slider" id="product-markup-slider" min="0" max="200" 
                                                   value="{{ product.markup_percentage if product and product.markup_percentage is not none else (product_data.markup_percentage if product_data else 50) }}" class="markup-slider flex-grow">
                                            <input type="number" name="markup_percentage" id="product-markup-percentage" 
                                                   value="{{ product.markup_percentage if product and product.markup_percentage is not none else (product_data.markup_percentage if product_data else 50) }}" class="form-input w-20 text-center" step="1" min="0" max="200">
                                            <span>%</span>
                                        </div>
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="product-retail-price" class="form-label">Розничная цена (сом) <span class="text-red-500">*</span></label>
                                        <input type="number" name="price" id="product-retail-price" class="form-input w-full font-semibold" 
                                               step="0.01" min="0" required placeholder="0.00" value="{{ '%.2f'|format(product.price|float) if product and product.price is not none else (product_data.price if product_data else '') }}">
                                    </div>
                                    
                                    <div>
                                        <label for="product-wholesale-markup-percentage" class="form-label">Оптовая наценка (%)</label>
                                        <div class="markup-slider-container">
                                            <input type="range" name="wholesale_markup_slider" id="product-wholesale-markup-slider" min="0" max="200" 
                                                   value="{{ product.wholesale_markup_percentage if product and product.wholesale_markup_percentage is not none else (product_data.wholesale_markup_percentage if product_data else 30) }}" class="markup-slider flex-grow">
                                            <input type="number" name="wholesale_markup_percentage" id="product-wholesale-markup-percentage" 
                                                   value="{{ product.wholesale_markup_percentage if product and product.wholesale_markup_percentage is not none else (product_data.wholesale_markup_percentage if product_data else 30) }}" class="form-input w-20 text-center" step="1" min="0" max="200">
                                            <span>%</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="product-wholesale-price" class="form-label">Оптовая цена (сом)</label>
                                        <input type="number" name="wholesale_price" id="product-wholesale-price" class="form-input w-full" 
                                               step="0.01" min="0" placeholder="0.00" value="{{ '%.2f'|format(product.wholesale_price|float) if product and product.wholesale_price is not none else (product_data.wholesale_price if product_data else '') }}" readonly>
                                    </div>

                                    <div>
                                        <label for="product-dealer-markup-percentage" class="form-label">Дилерская наценка (%)</label>
                                        <div class="markup-slider-container">
                                            <input type="range" name="dealer_markup_slider" id="product-dealer-markup-slider" min="0" max="200" 
                                                   value="{{ product.dealer_markup_percentage if product and product.dealer_markup_percentage is not none else (product_data.dealer_markup_percentage if product_data else 20) }}" class="markup-slider flex-grow">
                                            <input type="number" name="dealer_markup_percentage" id="product-dealer-markup-percentage" 
                                                   value="{{ product.dealer_markup_percentage if product and product.dealer_markup_percentage is not none else (product_data.dealer_markup_percentage if product_data else 20) }}" class="form-input w-20 text-center" step="1" min="0" max="200">
                                            <span>%</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="product-dealer-price" class="form-label">Дилерская цена (сом)</label>
                                        <input type="number" name="dealer_price" id="product-dealer-price" class="form-input w-full" 
                                               step="0.01" min="0" placeholder="0.00" value="{{ '%.2f'|format(product.dealer_price|float) if product and product.dealer_price is not none else (product_data.dealer_price if product_data else '') }}" readonly>
                                    </div>
                                    
                                    <div class="md:col-span-2"> 
                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
                                            <div>
                                                <label for="product-old-price" class="form-label">Старая розничная цена (сом)</label>
                                                <input type="number" name="discounted_price" id="product-old-price" class="form-input w-full" 
                                                    step="0.01" min="0" placeholder="0.00" value="{{ '%.2f'|format(product.discounted_price|float) if product and product.discounted_price is not none else (product_data.discounted_price if product_data else '') }}">
                                            </div>
                                            <div>
                                                <label class="form-label">Расчетная розничная маржа:</label>
                                                <p class="text-sm text-gray-700 mt-2"><span id="product-margin-amount" class="font-semibold">0.00 сом</span> (<span id="product-margin-percentage" class="font-semibold">0.00</span>%)</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="product-availability" class="form-label">Наличие <span class="text-red-500">*</span></label>
                                        <select id="product-availability" name="availability_status" class="form-select w-full" required>
                                            <option value="in_stock" {% if (product and product.availability_status == 'in_stock') or (product_data and product_data.availability_status == 'in_stock') %}selected{% endif %}>В наличии</option>
                                            <option value="on_order" {% if (product and product.availability_status == 'on_order') or (product_data and product_data.availability_status == 'on_order') %}selected{% endif %}>Под заказ</option>
                                            <option value="out_of_stock" {% if (product and product.availability_status == 'out_of_stock') or (product_data and product_data.availability_status == 'out_of_stock') %}selected{% endif %}>Нет в наличии</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">Описания</h3>
                                <div>
                                    <label for="product-short-description" class="form-label">Краткое описание / Ключевые особенности (каждый пункт с новой строки)</label>
                                    <textarea name="short_description" id="product-short-description" rows="4" class="form-textarea w-full" placeholder="Например:&#10;- Современный дизайн&#10;- Влагостойкие материалы">{{ product.short_description if product else (product_data.short_description if product_data else '') }}</textarea>
                                </div>
                                <div class="mt-4">
                                    <label for="product-full-description" class="form-label">Полное описание</label>
                                    <textarea name="description" id="product-full-description" rows="8" class="form-textarea w-full hidden">{{ product.description if product else (product_data.description if product_data else '') }}</textarea>
                                    <div id="quill-editor-container" class="form-textarea w-full min-h-[200px]">
                                    </div>
                                    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
                                    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-lg shadow" id="product-techcard-section">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-medium text-gray-900">Техническая карта и Состав</h3>
                                    <button type="button" 
                                            id="open-techcard-modal-btn"
                                            class="btn btn-secondary btn-sm"
                                            {% if not product or not product.id %}disabled title="Сначала сохраните товар"{% endif %}>
                                        {% if active_tech_card %}Редактировать/Загрузить новую{% else %}Добавить техкарту{% endif %}
                                    </button>
                                </div>
                                <div id="active-tech-card-summary">
                                     {% if active_tech_card %}
                                        <p class="text-sm text-gray-700">Активная техкарта: <span class="font-semibold">{{ active_tech_card.name }} (v{{ active_tech_card.version }})</span></p>
                                        <p class="text-sm text-gray-700">Статус: 
                                            <span class="font-semibold status-badge 
                                                {% if active_tech_card.status == TECH_CARD_STATUS_APPROVED %}status-approved
                                                {% elif active_tech_card.status == TECH_CARD_STATUS_PENDING_ACCOUNTANT %}status-pending-accountant
                                                {% elif active_tech_card.status == TECH_CARD_STATUS_PENDING_MANAGER %}status-pending-manager
                                                {% elif active_tech_card.status == TECH_CARD_STATUS_PROCESSED %}status-approved 
                                                {% elif active_tech_card.status == TECH_CARD_STATUS_PROCESSED_NEEDS_PRICES %}status-needs-prices
                                                {% elif active_tech_card.status == TECH_CARD_STATUS_DRAFT %}status-draft
                                                {% elif active_tech_card.status == TECH_CARD_STATUS_REJECTED_ACCOUNTANT or active_tech_card.status == TECH_CARD_STATUS_REJECTED_MANAGER %}status-rejected
                                                {% elif active_tech_card.status == TECH_CARD_STATUS_ARCHIVED %}status-archived
                                                {% else %}status-not-found{% endif %}">
                                                {{ active_tech_card.status }}
                                            </span>
                                        </p>
                                        <p class="text-xs text-gray-500">Себестоимость по ней: 
                                            <span class="font-semibold">
                                                {{ '%.2f сом'|format(active_tech_card.total_cost|float) if active_tech_card.total_cost is not none else 'N/A' }}
                                            </span>
                                        </p>
                                        {% if active_tech_card.file_url %}
                                        <p class="text-xs text-gray-500">Файл: {{ active_tech_card.file_url.split('/')[-1] }}</p>
                                        {% endif %}
                                        
                                        {% if tech_card_components and tech_card_components|length > 0 %}
                                            <h4 class="text-md font-medium text-gray-800 mt-4 mb-2">Компоненты активной техкарты:</h4>
                                            <div class="max-h-60 overflow-y-auto border border-gray-200 rounded-md">
                                                <table class="min-w-full divide-y divide-gray-200 table">
                                                    <thead>
                                                        <tr>
                                                            <th>№</th>
                                                            <th>Артикул</th>
                                                            <th>Наименование</th>
                                                            <th>Кол-во</th>
                                                            <th>Ед.</th>
                                                            <th>Цена</th>
                                                            <th>Сумма</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody class="bg-white divide-y divide-gray-200">
                                                        {% for component in tech_card_components %}
                                                        <tr>
                                                            <td>{{ loop.index }}</td>
                                                            <td>{{ component.raw_material_item.sku or '-' }}</td>
                                                            <td>{{ component.raw_material_item.name }}</td>
                                                            <td>{{ "%.3f"|format(component.quantity|float) }}</td>
                                                            <td>{{ component.raw_material_item.unit_of_measurement }}</td>
                                                            <td>{{ "%.2f"|format(component.raw_material_item.price|float) if component.raw_material_item.price is not none else 'N/A' }}</td>
                                                            <td>
                                                                {% if component.raw_material_item.price is not none %}
                                                                    {{ "%.2f"|format((component.quantity * component.raw_material_item.price)|float) }}
                                                                {% else %}
                                                                    N/A
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        {% else %}
                                            <p class="text-sm text-gray-500 mt-2">Компоненты для этой техкарты не загружены или отсутствуют.</p>
                                        {% endif %}
                                     {% else %}
                                        <p class="text-sm text-gray-500">Активная/утвержденная техкарта для этого товара не найдена. Нажмите кнопку выше, чтобы добавить.</p>
                                     {% endif %}
                                </div>
                                </div>


                             <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">Технические характеристики</h3>
                                <div id="specifications-container" class="space-y-3">
                                    {% set specs_data = (product.specifications|fromjson if product and product.specifications else (product_data.specifications_json|fromjson if product_data and product_data.specifications_json else {})) %}
                                    {% if specs_data and specs_data is mapping and specs_data|length > 0 %}
                                        {% for spec_name, spec_value in specs_data.items() %}
                                        <div class="flex items-center space-x-2 spec-row">
                                            <input type="text" name="spec_name[]" placeholder="Название характеристики" class="form-input flex-1" value="{{ spec_name }}">
                                            <input type="text" name="spec_value[]" placeholder="Значение" class="form-input flex-1" value="{{ spec_value }}">
                                            <button type="button" class="text-red-500 hover:text-red-700 remove-spec-btn" title="Удалить характеристику">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                            </button>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                     <div class="flex items-center space-x-2 spec-row">
                                        <input type="text" name="spec_name[]" placeholder="Название характеристики (напр. Ширина)" class="form-input flex-1">
                                        <input type="text" name="spec_value[]" placeholder="Значение (напр. 750 мм)" class="form-input flex-1">
                                        <button type="button" class="text-red-500 hover:text-red-700 remove-spec-btn" title="Удалить характеристику">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                        </button>
                                    </div>
                                    {% endif %}
                                </div>
                                <button type="button" id="add-spec-btn" class="mt-3 btn btn-secondary text-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline -ml-1 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                                    Добавить характеристику
                                </button>
                            </div>
                        </div>

                        <div class="lg:col-span-1 space-y-6">
                            <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">Организация</h3>
                                <div>
                                    <label for="product-category" class="form-label">Категория товара <span class="text-red-500">*</span></label>
                                    <select id="product-category" name="category_id" class="form-select w-full" required>
                                        <option value="">Выберите категорию</option>
                                        {% for category_item in categories %} 
                                        <option value="{{ category_item.id }}" 
                                                {% if product and product.category_id == category_item.id %}selected
                                                {% elif product_data and product_data.category_id|int == category_item.id %}selected
                                                {% endif %}>
                                            {{ category_item.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mt-4">
                                    <label for="product-status" class="form-label">Статус товара</label>
                                    <select id="product-status" name="is_published" class="form-select w-full">
                                        <option value="true" {% if (product and product.is_published) or (product_data and product_data.is_published == 'true') %}selected{% endif %}>Опубликован</option>
                                        <option value="false" {% if (product and not product.is_published) or (product_data and product_data.is_published == 'false') %}selected{% endif %}>Черновик</option>
                                    </select>
                                </div>
                                <div class="mt-4">
                                    <label for="product-weight" class="form-label">Вес (кг)</label>
                                    <input type="number" name="weight" id="product-weight" class="form-input w-full" 
                                           step="0.01" min="0" value="{{ product.weight if product and product.weight is not none else (product_data.weight if product_data else '') }}">
                                </div>
                                <div class="mt-4">
                                    <label for="product-dimensions" class="form-label">Габариты (ДxШxВ см)</label>
                                    <input type="text" name="dimensions" id="product-dimensions" class="form-input w-full" 
                                           placeholder="например, 120x60x75" value="{{ product.dimensions if product else (product_data.dimensions if product_data else '') }}">
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">Изображения товара</h3>
                                <div id="image-upload-dropzone-area" class="image-upload-dropzone mb-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                    <p class="text-gray-500 text-sm">Перетащите файлы сюда или <span class="text-sky-600 font-semibold">нажмите для выбора</span></p>
                                    <p class="text-xs text-gray-400 mt-1">PNG, JPG, GIF, WEBP</p>
                                </div>
                                <div id="image-previews" class="grid grid-cols-3 sm:grid-cols-4 gap-3 mb-3">
                                    {% if product and product.images %}
                                        {% for image in product.images %}
                                            <div class="image-uploader-preview-container product-image-item" data-image-id="{{ image.id }}" data-image-filename="{{ image.image_url.split('/')[-1] }}">
                                                <img src="{{ url_for('static', filename=image.image_url) }}" alt="{{ image.alt_text or 'Изображение товара' }}" 
                                                     class="image-uploader-preview {% if image.is_main or (loop.first and not product.images|selectattr('is_main', 'equalto', true)|list) %}main-image-indicator{% endif %}">
                                                <button type="button" class="absolute top-0 right-0 m-1 p-0.5 bg-red-600 hover:bg-red-700 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity remove-image-btn" title="Удалить изображение" data-image-id="{{ image.id }}">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                                </button>
                                                {% if not (image.is_main or (loop.first and not product.images|selectattr('is_main', 'equalto', true)|list)) %}
                                                <button type="button" class="absolute bottom-0 left-0 m-1 p-0.5 bg-sky-600 hover:bg-sky-700 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity set-main-image-btn" title="Сделать главным">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                                                </button>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    {% endif %}
                                    </div>
                                {% set main_image_filename_val = '' %}
                                {% if product %}
                                    {% set all_product_images = product.images.all() %} {# Выполняем запрос к БД #}
                                    {% if all_product_images %} {# Проверяем, есть ли изображения #}
                                        {% set main_image_obj = (all_product_images|selectattr('is_main', 'equalto', true)|first) %}
                                        {% if main_image_obj %}
                                            {% set main_image_filename_val = main_image_obj.image_url.split('/')[-1] %}
                                        {% elif all_product_images[0] %} {# Берем первое из списка, если is_main не найдено #}
                                            {% set main_image_filename_val = all_product_images[0].image_url.split('/')[-1] %}
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                                <input type="file" name="product_images_upload[]" id="image-upload-input" multiple accept="image/*" class="hidden">
                                <input type="hidden" name="main_image_filename" id="main-image-filename-input" value="{{ main_image_filename_val }}">
                                <p class="text-xs text-gray-500">Первое изображение является главным. Перетащите для изменения порядка. Нажмите на звездочку, чтобы сделать изображение главным.</p>
                            </div>
                            
                            <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">SEO-Настройки</h3>
                                <div>
                                    <label for="seo-title" class="form-label">SEO Title</label>
                                    <input type="text" name="seo_title" id="seo-title" class="form-input w-full" value="{{ product.seo_title if product else (product_data.seo_title if product_data else '') }}">
                                </div>
                                <div class="mt-4">
                                    <label for="seo-description" class="form-label">Meta Description</label>
                                    <textarea name="seo_description" id="seo-description" rows="3" class="form-textarea w-full">{{ product.seo_description if product else (product_data.seo_description if product_data else '') }}</textarea>
                                </div>
                                <div class="mt-4">
                                    <label for="seo-keywords" class="form-label">Meta Keywords (через запятую)</label>
                                    <input type="text" name="seo_keywords" id="seo-keywords" class="form-input w-full" value="{{ product.seo_keywords if product else (product_data.seo_keywords if product_data else '') }}">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 pt-6 border-t border-gray-300 flex justify-end space-x-3">
                        <a href="{{ url_for('admin_products') }}" class="btn btn-secondary">Отмена</a>
                        <button type="submit" class="btn btn-success">
                            {% if product and product.id %}Сохранить товар{% else %}Добавить товар{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </main>
    </div>
    
    <div id="techCardModal" class="fixed inset-0 z-[100] overflow-y-auto hidden" aria-labelledby="modal-title-techcard" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="modal-overlay fixed inset-0 bg-gray-600 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeTechCardModal()"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

            <div class="modal-content inline-block align-bottom sm:align-middle sm:my-8 text-left">
                <div>
                    <div class="flex justify-between items-center pb-3 border-b mb-4">
                        <h3 class="text-xl font-semibold text-gray-800" id="modal-title-techcard">
                            Обработка Техкарты
                        </h3>
                        <button type="button" onclick="closeTechCardModal()" class="text-gray-400 hover:text-gray-600">
                            <span class="sr-only">Закрыть</span>
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>

                    <div id="modal-product-info-techcard" class="text-sm text-gray-600 mb-4">
                        </div>
                    
                    <input type="hidden" id="modal-product-id-techcard" name="modal_product_id_techcard_val" value=""> 
                    <input type="hidden" id="modal-tech-card-id" name="modal_tech_card_id_val" value=""> <div id="upload-block-modal" class="mb-6">
                        <label class="form-label" for="techcard-file-input-modal">Файл техкарты (XLSX/XLS):</label>
                        <div id="drop-area-modal" class="techcard-dropzone"> 
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 text-gray-400 mb-2 pointer-events-none">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                            </svg>
                            <p class="pointer-events-none">Перетащите XLSX/XLS файл сюда или
                                <span class="font-medium text-sky-600 hover:text-sky-500 cursor-pointer" onclick="document.getElementById('techcard-file-input-modal').click()">выберите файл</span>
                            </p>
                            <input type="file" name="tech_card_excel_file_modal_input" id="techcard-file-input-modal" class="hidden" accept=".xlsx,.xls,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel">
                        </div>
                        <div id="file-info-modal" class="mt-2 text-sm text-gray-700 hidden">
                            Выбран файл: <span class="font-medium" id="loaded-file-name-modal"></span> (<span id="loaded-file-size-modal"></span>)
                            <button type="button" id="remove-file-btn-modal" class="text-red-500 hover:text-red-700 ml-2 text-xs font-semibold">(удалить)</button>
                        </div>
                    </div>

                    <div id="parsed-components-block-modal" class="mb-6 hidden">
                        <h4 class="text-md font-semibold text-gray-700 mb-2">Предварительный просмотр компонентов:</h4>
                        <div class="max-h-60 overflow-y-auto border border-gray-200 rounded-md">
                            <table class="min-w-full divide-y divide-gray-200 text-sm modal-table">
                                <thead>
                                    <tr>
                                        <th>№</th><th>Артикул (файл)</th><th>Наименование (файл)</th>
                                        <th>Кол-во</th><th>Ед.изм.</th><th>Цена сырья (БД)</th><th>Стоимость</th>
                                    </tr>
                                </thead>
                                <tbody id="parsed-components-table-body-modal" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                        <div class="mt-3 text-right">
                            <p class="text-sm">Количество позиций: <span class="font-semibold" id="components-count-modal">0</span></p>
                            <p class="text-sm text-red-500 hidden" id="missing-prices-warning-modal">Внимание! Для <span id="missing-prices-count-modal">0</span> компонент(а/ов) не найдены цены в справочнике или равны нулю.</p>
                            <p class="text-md mt-1">Общая себестоимость (материалы): <strong class="text-lg text-blue-700" id="total-material-cost-modal">0.00 сом</strong></p>
                        </div>
                    </div>

                    <div class="mt-4">
                        <label for="editor-comment-modal" class="form-label">Комментарий (необязательно):</label>
                        <textarea id="editor-comment-modal" name="editor_comment_modal_val" class="form-textarea w-full" rows="3" placeholder="Например, укажите причину обновления или на что обратить внимание..."></textarea>
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t border-gray-200 flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3">
                    <button type="button" onclick="closeTechCardModal()" class="btn btn-secondary w-full sm:w-auto">Отмена</button>
                    <button type="button" id="save-draft-techcard-modal-btn" class="btn btn-warning w-full sm:w-auto" disabled>Сохранить черновик</button>
                    <button type="button" id="submit-techcard-for-approval-modal-btn" class="btn btn-primary w-full sm:w-auto" disabled>Отправить на согласование</button>
                </div>
            </div>
        </div>
    </div>
    <div id="notification-container" class="fixed top-4 right-4 z-[1050] space-y-2"></div>

    <script>
        // --- Глобальные переменные для основной страницы ---
        const PRODUCT_ID_MAIN_PAGE = {{ product.id|tojson if product and product.id else 'null' }};
        const PRODUCT_NAME_MAIN_PAGE = "{{ product.name | e if product else 'Новый товар' }}";
        const PRODUCT_SKU_MAIN_PAGE = "{{ product.sku | e if product else '---' }}";
        
        // Данные для кнопки "Авто (ТК)" на основной странице
        const TECH_CARD_COST_FROM_SERVER_MAIN_PAGE = parseFloat("{{ active_tech_card.total_cost if active_tech_card and active_tech_card.total_cost is not none else '0' }}");
        const TECH_CARD_STATUS_FROM_SERVER_MAIN_PAGE = "{{ active_tech_card.status | e if active_tech_card else 'Нет данных' }}";
        const LATEST_TECH_CARD_UPDATED_AT_MAIN_PAGE = "{{ active_tech_card.updated_at.strftime('%d.%m.%Y %H:%M') if active_tech_card and active_tech_card.updated_at else 'N/A' }}";
        
        // URL для AJAX запросов из модального окна
        // ИСПРАВЛЕНИЕ: Используем шаблон URL для PREVIEW_TECHCARD_URL
        const PREVIEW_TECHCARD_URL_TEMPLATE = "{{ url_for('admin_preview_techcard_components', product_id=0) }}".replace('/0/', '/<product_id_placeholder>/');
        const PROCESS_TECHCARD_MODAL_URL = "{{ url_for('admin_process_techcard_from_modal') }}"; 

        // Константы статусов техкарты (для JS) - убедитесь, что они передаются из Flask, если нужны в JS
        const TECH_CARD_STATUS_DRAFT_JS = "{{ TECH_CARD_STATUS_DRAFT if TECH_CARD_STATUS_DRAFT else 'Черновик' }}";
        const TECH_CARD_STATUS_PENDING_ACCOUNTANT_JS = "{{ TECH_CARD_STATUS_PENDING_ACCOUNTANT if TECH_CARD_STATUS_PENDING_ACCOUNTANT else 'На согласовании (Бухгалтер)' }}";
        
        document.addEventListener('DOMContentLoaded', () => {
            // --- JS для основной страницы (сайдбар, Quill, цены, изображения, характеристики) ---
            // ... (Весь JS код для основной страницы из предыдущего ответа должен быть здесь) ...
            const sidebar = document.getElementById('admin-sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');

            if (sidebarToggle && sidebar) {
                sidebarToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('w-64');
                    sidebar.classList.toggle('w-16');
                    if (sidebar.classList.contains('w-16')) {
                        localStorage.setItem('sidebarCollapsed', 'true');
                    } else {
                        localStorage.removeItem('sidebarCollapsed');
                    }
                });
                if (localStorage.getItem('sidebarCollapsed') === 'true') {
                     sidebar.classList.remove('w-64');
                     sidebar.classList.add('w-16');
                }
            }
            
            var quill = null;
            if (document.getElementById('quill-editor-container')) {
                quill = new Quill('#quill-editor-container', {
                    theme: 'snow',
                    modules: { toolbar: [[{ 'header': [1, 2, 3, false] }],['bold', 'italic', 'underline', 'strike'],[{'list': 'ordered'}, {'list': 'bullet'}],[{ 'align': [] }],['link', 'image'], ['clean']]},
                    placeholder: 'Введите полное описание товара здесь...'
                });
                const fullDescriptionTextarea = document.getElementById('product-full-description');
                if (fullDescriptionTextarea && fullDescriptionTextarea.value) {
                    try {
                        const deltaOrHtml = JSON.parse(fullDescriptionTextarea.value);
                        if (typeof deltaOrHtml === 'object' && deltaOrHtml.ops) { quill.setContents(deltaOrHtml); } 
                        else { quill.clipboard.dangerouslyPasteHTML(0, deltaOrHtml); }
                    } catch (e) { quill.clipboard.dangerouslyPasteHTML(0, fullDescriptionTextarea.value); }
                }
                const productFormForQuill = document.getElementById('product-form');
                if (productFormForQuill) {
                    productFormForQuill.addEventListener('submit', function() {
                        if (quill && fullDescriptionTextarea) { fullDescriptionTextarea.value = JSON.stringify(quill.getContents()); }
                    });
                }
            }

            const costPriceInput = document.getElementById('product-cost-price');
            const costPriceSourceEl = document.getElementById('cost-price-source');
            const fetchCostBtn = document.getElementById('fetch-cost-from-techcard');
            const markupSlider = document.getElementById('product-markup-slider');
            const markupPercentageInput = document.getElementById('product-markup-percentage');
            const retailPriceInput = document.getElementById('product-retail-price');
            const wholesaleMarkupSlider = document.getElementById('product-wholesale-markup-slider');
            const wholesaleMarkupPercentageInput = document.getElementById('product-wholesale-markup-percentage');
            const wholesalePriceInput = document.getElementById('product-wholesale-price');
            const dealerMarkupSlider = document.getElementById('product-dealer-markup-slider');
            const dealerMarkupPercentageInput = document.getElementById('product-dealer-markup-percentage');
            const dealerPriceInput = document.getElementById('product-dealer-price');
            const marginAmountEl = document.getElementById('product-margin-amount');
            const marginPercentageEl = document.getElementById('product-margin-percentage');
            
            function calculateAllPrices() { /* ... (без изменений) ... */ 
                const cost = parseFloat(costPriceInput.value) || 0;
                const retailMarkup = parseFloat(markupPercentageInput.value) || 0;
                if (cost > 0 && retailMarkup >= 0) { retailPriceInput.value = (cost * (1 + retailMarkup / 100)).toFixed(2);
                } else if (!(cost === 0 && retailPriceInput.value && parseFloat(retailPriceInput.value) > 0)) {
                     if (!retailPriceInput.value || parseFloat(retailPriceInput.value) === 0) { retailPriceInput.value = cost > 0 ? cost.toFixed(2) : ""; }
                }
                const wholesaleMarkup = parseFloat(wholesaleMarkupPercentageInput.value) || 0;
                if (cost > 0 && wholesaleMarkup >= 0) { wholesalePriceInput.value = (cost * (1 + wholesaleMarkup / 100)).toFixed(2);
                } else { wholesalePriceInput.value = cost > 0 ? cost.toFixed(2) : "";}
                const dealerMarkup = parseFloat(dealerMarkupPercentageInput.value) || 0;
                if (cost > 0 && dealerMarkup >= 0) { dealerPriceInput.value = (cost * (1 + dealerMarkup / 100)).toFixed(2);
                } else { dealerPriceInput.value = cost > 0 ? cost.toFixed(2) : "";}
                updateMargin();
            }
            function updateMarkupFromRetail() { /* ... (без изменений) ... */ 
                const cost = parseFloat(costPriceInput.value) || 0;
                const retail = parseFloat(retailPriceInput.value) || 0;
                if (cost > 0 && retail >= cost) {
                    const markup = ((retail - cost) / cost) * 100;
                    markupPercentageInput.value = markup.toFixed(0);
                    if(markupSlider) markupSlider.value = markup.toFixed(0);
                    updateSliderColor(markupSlider, markup);
                } else if (cost > 0 && retail < cost && retail > 0) { 
                    if(markupPercentageInput) markupPercentageInput.value = "0"; 
                    if(markupSlider) markupSlider.value = "0";
                    updateSliderColor(markupSlider, 0);
                } else if (cost === 0 && retail > 0) { 
                    if(markupPercentageInput) markupPercentageInput.value = "200"; 
                    if(markupSlider) markupSlider.value = "200";
                    updateSliderColor(markupSlider, 200);
                } else if (markupSlider) { 
                    if(markupPercentageInput) markupPercentageInput.value = markupSlider.value; 
                    updateSliderColor(markupSlider, parseFloat(markupSlider.value));
                }
                calculateAllPrices(); 
            }
            function updateMargin() { /* ... (без изменений) ... */ 
                const cost = parseFloat(costPriceInput.value) || 0;
                const retail = parseFloat(retailPriceInput.value) || 0;
                let marginAmount = 0; let marginPercentage = 0;
                if (retail > 0) {
                    marginAmount = retail - cost;
                    if (cost > 0) { marginPercentage = (marginAmount / cost) * 100;} else { marginPercentage = Infinity; }
                }
                if (marginAmountEl) marginAmountEl.textContent = formatCurrency(marginAmount);
                if (marginPercentageEl) marginPercentageEl.textContent = isFinite(marginPercentage) ? marginPercentage.toFixed(2) : "N/A";
            }
            function updateSliderColor(sliderElement, value) { /* ... (без изменений) ... */ 
                if (!sliderElement) return;
                sliderElement.classList.remove('markup-slider-green', 'markup-slider-yellow', 'markup-slider-orange', 'markup-slider-red');
                if (value < 0) { sliderElement.classList.add('markup-slider-red');
                } else if (value <= 30) { sliderElement.classList.add('markup-slider-orange');
                } else if (value <= 70) { sliderElement.classList.add('markup-slider-yellow');
                } else { sliderElement.classList.add('markup-slider-green');}
            }
            if (fetchCostBtn) { fetchCostBtn.addEventListener('click', () => { /* ... (без изменений) ... */ 
                if (TECH_CARD_COST_FROM_SERVER_MAIN_PAGE !== null && TECH_CARD_COST_FROM_SERVER_MAIN_PAGE >= 0 && 
                    (TECH_CARD_STATUS_FROM_SERVER_MAIN_PAGE === 'Утверждена' || TECH_CARD_STATUS_FROM_SERVER_MAIN_PAGE === 'Обработана')) {
                    costPriceInput.value = TECH_CARD_COST_FROM_SERVER_MAIN_PAGE.toFixed(2);
                    if(costPriceSourceEl) costPriceSourceEl.textContent = `Из техкарты (${TECH_CARD_STATUS_FROM_SERVER_MAIN_PAGE}, от ${LATEST_TECH_CARD_UPDATED_AT_MAIN_PAGE})`;
                    calculateAllPrices();
                } else {
                    let alertMessage = 'Активная (утвержденная/обработанная) техкарта с себестоимостью не найдена для этого товара, или себестоимость равна нулю.';
                    if (TECH_CARD_STATUS_FROM_SERVER_MAIN_PAGE === 'Обработана (требует цен)') {
                        alertMessage = 'Себестоимость по техкарте не может быть подставлена, так как не для всех компонентов сырья указаны цены. Пожалуйста, проверьте цены на сырье и переобработайте техкарту.';
                    } else if (TECH_CARD_STATUS_FROM_SERVER_MAIN_PAGE && TECH_CARD_STATUS_FROM_SERVER_MAIN_PAGE !== 'Нет данных' && TECH_CARD_STATUS_FROM_SERVER_MAIN_PAGE !== 'Техкарта не создана') {
                            alertMessage = `Текущий статус техкарты "${TECH_CARD_STATUS_FROM_SERVER_MAIN_PAGE}" не позволяет автоматически рассчитать себестоимость. Требуется статус "Обработана" или "Утверждена" с корректной себестоимостью.`;
                    }
                    alert(alertMessage);
                    if(costPriceSourceEl) costPriceSourceEl.textContent = 'Техкарта не найдена/неприменима';
                }
            });}
            if (costPriceInput) costPriceInput.addEventListener('input', () => { if(costPriceSourceEl) costPriceSourceEl.textContent = 'Введено вручную'; calculateAllPrices(); });
            [markupSlider, markupPercentageInput].forEach(el => { if(el) el.addEventListener('input', (e) => { const t=e.target.type==='range',v=parseFloat(e.target.value),f=Math.max(0,Math.min(200,isNaN(v)?0:v)); if(t&&markupPercentageInput)markupPercentageInput.value=f;else if(!t&&markupSlider)markupSlider.value=f; updateSliderColor(markupSlider,f);calculateAllPrices();});});
            [wholesaleMarkupSlider, wholesaleMarkupPercentageInput].forEach(el => { if(el) el.addEventListener('input', (e) => { const t=e.target.type==='range',v=parseFloat(e.target.value),f=Math.max(0,Math.min(200,isNaN(v)?0:v)); if(t&&wholesaleMarkupPercentageInput)wholesaleMarkupPercentageInput.value=f;else if(!t&&wholesaleMarkupSlider)wholesaleMarkupSlider.value=f; updateSliderColor(wholesaleMarkupSlider,f);calculateAllPrices();});});
            [dealerMarkupSlider, dealerMarkupPercentageInput].forEach(el => { if(el) el.addEventListener('input', (e) => { const t=e.target.type==='range',v=parseFloat(e.target.value),f=Math.max(0,Math.min(200,isNaN(v)?0:v)); if(t&&dealerMarkupPercentageInput)dealerMarkupPercentageInput.value=f;else if(!t&&dealerMarkupSlider)dealerMarkupSlider.value=f; updateSliderColor(dealerMarkupSlider,f);calculateAllPrices();});});
            if (retailPriceInput) retailPriceInput.addEventListener('input', updateMarkupFromRetail);
            if (PRODUCT_ID_MAIN_PAGE) {} else { if(markupSlider)updateSliderColor(markupSlider,parseFloat(markupSlider.value)); if(wholesaleMarkupSlider)updateSliderColor(wholesaleMarkupSlider,parseFloat(wholesaleMarkupSlider.value)); if(dealerMarkupSlider)updateSliderColor(dealerMarkupSlider,parseFloat(dealerMarkupSlider.value));}
            calculateAllPrices(); 

            const imageDropZoneArea = document.getElementById('image-upload-dropzone-area');
            const imageUploadInput = document.getElementById('image-upload-input');
            const imagePreviewsContainer = document.getElementById('image-previews');
            const mainImageFilenameInput = document.getElementById('main-image-filename-input');
            function handleImageFiles(files) { /* ... (без изменений) ... */ Array.from(files).forEach(file=>{if(file.type.startsWith('image/')){const reader=new FileReader();reader.onload=(e)=>{createImagePreviewElement(e.target.result,file.name,null,file);};reader.readAsDataURL(file);}}); }
            function createImagePreviewElement(src, filename, imageId = null, fileObject = null) { /* ... (без изменений) ... */ const pW=document.createElement('div');pW.className='image-uploader-preview-container product-image-item';if(imageId)pW.dataset.imageId=imageId;pW.dataset.imageFilename=filename;if(fileObject)pW.dataset.isNew="true";const i=document.createElement('img');i.src=src;i.alt='Предпросмотр';i.className='image-uploader-preview';const rB=document.createElement('button');rB.type='button';rB.title='Удалить изображение';rB.className='absolute top-0 right-0 m-1 p-0.5 bg-red-600 hover:bg-red-700 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity remove-image-btn';if(imageId)rB.dataset.imageId=imageId;rB.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>';const sMB=document.createElement('button');sMB.type='button';sMB.title='Сделать главным';sMB.className='absolute bottom-0 left-0 m-1 p-0.5 bg-sky-600 hover:bg-sky-700 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity set-main-image-btn';sMB.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>';pW.appendChild(i);pW.appendChild(rB);pW.appendChild(sMB);imagePreviewsContainer.appendChild(pW);updateMainImageIndicatorAndInput();}
            function updateMainImageIndicatorAndInput() { /* ... (без изменений) ... */ const aP=imagePreviewsContainer.querySelectorAll('.image-uploader-preview-container');aP.forEach((p,idx)=>{const iE=p.querySelector('.image-uploader-preview');const sMB=p.querySelector('.set-main-image-btn');iE.classList.remove('main-image-indicator');if(sMB)sMB.style.display='block';if(idx===0){iE.classList.add('main-image-indicator');if(mainImageFilenameInput)mainImageFilenameInput.value=p.dataset.imageFilename||'';if(sMB)sMB.style.display='none';}});if(aP.length===0&&mainImageFilenameInput){mainImageFilenameInput.value='';}}
            if (imageDropZoneArea && imageUploadInput && imagePreviewsContainer) { imageDropZoneArea.addEventListener('click',()=>imageUploadInput.click());['dragenter','dragover','dragleave','drop'].forEach(evtName=>{imageDropZoneArea.addEventListener(evtName,(e)=>{e.preventDefault();e.stopPropagation();},false);});imageDropZoneArea.addEventListener('dragenter',()=>imageDropZoneArea.classList.add('dragover'));imageDropZoneArea.addEventListener('dragover',()=>imageDropZoneArea.classList.add('dragover'));imageDropZoneArea.addEventListener('dragleave',()=>imageDropZoneArea.classList.remove('dragover'));imageDropZoneArea.addEventListener('drop',(event)=>{imageDropZoneArea.classList.remove('dragover');if(event.dataTransfer.files.length){const dT=new DataTransfer();Array.from(event.dataTransfer.files).forEach(f=>dT.items.add(f));imageUploadInput.files=dT.files;handleImageFiles(imageUploadInput.files);}});imageUploadInput.addEventListener('change',(event)=>{handleImageFiles(event.target.files);});imagePreviewsContainer.addEventListener('click',(event)=>{const rB=event.target.closest('.remove-image-btn');const sMB=event.target.closest('.set-main-image-btn');if(rB){const iIW=rB.closest('.product-image-item');const iId=iIW.dataset.imageId;if(iId){const hI=document.createElement('input');hI.type='hidden';hI.name='deleted_image_ids[]';hI.value=iId;document.getElementById('product-form').appendChild(hI);}iIW.remove();updateMainImageIndicatorAndInput();}else if(sMB){const iIW=sMB.closest('.product-image-item');imagePreviewsContainer.insertBefore(iIW,imagePreviewsContainer.firstChild);updateMainImageIndicatorAndInput();}});if(imagePreviewsContainer.children.length>0){new Sortable(imagePreviewsContainer,{animation:150,ghostClass:'sortable-ghost',onEnd:function(evt){updateMainImageIndicatorAndInput();}});}updateMainImageIndicatorAndInput();}
            
            // --- JS для модального окна техкарты (встроено) ---
            const openTechCardModalBtnEl = document.getElementById('open-techcard-modal-btn'); 
            const techCardModalEl = document.getElementById('techCardModal'); 
            const modalTitleTechCardEl = document.getElementById('modal-title-techcard');
            const modalProductInfoTechCardEl = document.getElementById('modal-product-info-techcard');
            const modalProductIdTechCardInputEl = document.getElementById('modal-product-id-techcard');
            const modalTechCardIdInputEl = document.getElementById('modal-tech-card-id'); // Для ID существующей техкарты
            
            const dropAreaModalEl = document.getElementById('drop-area-modal');
            const fileInputModalEl = document.getElementById('techcard-file-input-modal');
            const fileInfoModalEl = document.getElementById('file-info-modal');
            const loadedFileNameModalEl = document.getElementById('loaded-file-name-modal');
            const loadedFileSizeModalEl = document.getElementById('loaded-file-size-modal');
            const removeFileBtnModalEl = document.getElementById('remove-file-btn-modal');
            
            const parsedComponentsBlockModalEl = document.getElementById('parsed-components-block-modal');
            const parsedComponentsTableBodyModalEl = document.getElementById('parsed-components-table-body-modal');
            const componentsCountModalEl = document.getElementById('components-count-modal');
            const missingPricesWarningModalEl = document.getElementById('missing-prices-warning-modal');
            const missingPricesCountModalEl = document.getElementById('missing-prices-count-modal');
            const totalMaterialCostModalEl = document.getElementById('total-material-cost-modal');
            const editorCommentModalEl = document.getElementById('editor-comment-modal');
            const saveDraftBtnModalEl = document.getElementById('save-draft-techcard-modal-btn');
            const submitForApprovalBtnModalEl = document.getElementById('submit-techcard-for-approval-modal-btn');

            let currentTechCardFileInModal = null; 
            let currentProductIdForModal = null;   
            let currentTechCardIdForModal = null; 

            window.openTechCardModal = function(productName, productSku, productId, mode = 'new', existingTechCardId = null, existingTechCardData = null) {
                if (!techCardModalEl) { console.error("Модальное окно техкарты не найдено!"); return; }
                
                currentProductIdForModal = productId;
                currentTechCardIdForModal = existingTechCardId; 
                if(modalProductIdTechCardInputEl) modalProductIdTechCardInputEl.value = productId || '';
                if(modalTechCardIdInputEl) modalTechCardIdInputEl.value = existingTechCardId || '';

                if(modalProductInfoTechCardEl) modalProductInfoTechCardEl.innerHTML = `Товар: <strong class="font-medium">${productName}</strong> (Артикул: <strong class="font-medium">${productSku}</strong>)`;

                currentTechCardFileInModal = null;
                if(fileInputModalEl) fileInputModalEl.value = ''; 
                if(fileInfoModalEl) fileInfoModalEl.classList.add('hidden');
                if(parsedComponentsBlockModalEl) parsedComponentsBlockModalEl.classList.add('hidden');
                if(editorCommentModalEl) editorCommentModalEl.value = existingTechCardData ? (existingTechCardData.editorComment || '') : '';
                if(dropAreaModalEl) dropAreaModalEl.classList.remove('border-red-500');

                if (mode === 'new' || !existingTechCardId) { 
                    if(modalTitleTechCardEl) modalTitleTechCardEl.textContent = `Загрузка новой техкарты для: ${productName}`;
                    if(uploadBlockModalEl) uploadBlockModalEl.classList.remove('hidden'); 
                    if(saveDraftBtnModalEl) saveDraftBtnModalEl.disabled = true;
                    if(submitForApprovalBtnModalEl) submitForApprovalBtnModalEl.disabled = true;
                } else { 
                    if(modalTitleTechCardEl) modalTitleTechCardEl.textContent = `Редактирование техкарты: ${productName}`;
                    if (existingTechCardData && existingTechCardData.fileName) { 
                        currentTechCardFileInModal = { name: existingTechCardData.fileName, size: existingTechCardData.fileSize || 0, isExisting: true }; 
                        if(loadedFileNameModalEl) loadedFileNameModalEl.textContent = existingTechCardData.fileName;
                        if(loadedFileSizeModalEl) loadedFileSizeModalEl.textContent = existingTechCardData.fileSize ? `${(existingTechCardData.fileSize / 1024).toFixed(2)} KB` : '';
                        if(fileInfoModalEl) fileInfoModalEl.classList.remove('hidden');
                        if(uploadBlockModalEl) uploadBlockModalEl.classList.remove('hidden'); 

                        if (existingTechCardData.components) {
                            displayParsedComponentsInModal(existingTechCardData.components, existingTechCardData.totalCost); 
                            if(parsedComponentsBlockModalEl) parsedComponentsBlockModalEl.classList.remove('hidden');
                        }
                        if(saveDraftBtnModalEl) saveDraftBtnModalEl.disabled = false;
                        if(submitForApprovalBtnModalEl) submitForApprovalBtnModalEl.disabled = false;
                    } else { 
                         if(uploadBlockModalEl) uploadBlockModalEl.classList.remove('hidden');
                         if(saveDraftBtnModalEl) saveDraftBtnModalEl.disabled = true;
                         if(submitForApprovalBtnModalEl) submitForApprovalBtnModalEl.disabled = true;
                    }
                }
                techCardModalEl.classList.remove('hidden');
            }

            window.closeTechCardModal = function() {
                if (techCardModalEl) techCardModalEl.classList.add('hidden');
            }
            
            if(openTechCardModalBtnEl) { 
                openTechCardModalBtnEl.addEventListener('click', function() {
                    if (!PRODUCT_ID_MAIN_PAGE && this.disabled) { // Если кнопка задизейблена и нет ID продукта
                        alert("Пожалуйста, сначала сохраните товар, чтобы добавить или управлять техкартой.");
                        return;
                    }
                    let mode = 'new';
                    let techCardDataForModal = null; 
                    let existingTcId = null;

                    {% if active_tech_card and active_tech_card.id %}
                        existingTcId = {{ active_tech_card.id }};
                        techCardDataForModal = {
                            fileName: "{{ active_tech_card.file_url.split('/')[-1] if active_tech_card and active_tech_card.file_url else '' }}",
                            // Компоненты для существующей карты лучше загружать AJAX-ом при открытии модала,
                            // чтобы не передавать большие объемы данных в HTML.
                            // Либо передавать только если их немного.
                            components: {{ tech_card_components|tojson|safe if tech_card_components and tech_card_components|length < 50 else [] }}, // Ограничение для примера
                            totalCost: {{ active_tech_card.total_cost if active_tech_card and active_tech_card.total_cost is not none else 'null' }},
                            editorComment: "{{ active_tech_card.description|e if active_tech_card and active_tech_card.description else '' }}"
                        };
                        mode = 'edit_existing'; 
                    {% endif %}
                    openTechCardModal(PRODUCT_NAME_MAIN_PAGE, PRODUCT_SKU_MAIN_PAGE, PRODUCT_ID_MAIN_PAGE, mode, existingTcId, techCardDataForModal);
                });
            }


            function handleFileSelectInModal(files) {
                if (files.length === 0) return;
                const file = files[0];
                if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                    alert("Пожалуйста, выберите файл в формате XLSX или XLS.");
                    if(fileInputModalEl) fileInputModalEl.value = '';
                    if(dropAreaModalEl) dropAreaModalEl.classList.add('border-red-500');
                    return;
                }
                if(dropAreaModalEl) dropAreaModalEl.classList.remove('border-red-500');

                if (file.size > 10 * 1024 * 1024) { 
                    alert("Файл слишком большой. Максимальный размер 10МБ.");
                    if(fileInputModalEl) fileInputModalEl.value = '';
                    return;
                }
                currentTechCardFileInModal = file; 
                if(loadedFileNameModalEl) loadedFileNameModalEl.textContent = file.name;
                if(loadedFileSizeModalEl) loadedFileSizeModalEl.textContent = `${(file.size / 1024).toFixed(2)} KB`;
                if(fileInfoModalEl) fileInfoModalEl.classList.remove('hidden');
                
                const formData = new FormData();
                formData.append('tech_card_excel_file_for_preview', file); 
                if (currentProductIdForModal) { 
                    formData.append('product_id', currentProductIdForModal);
                }
                
                let actualPreviewUrl = PREVIEW_TECHCARD_URL_TEMPLATE.replace('<product_id_placeholder>', currentProductIdForModal || 0);
                // Если product_id все еще 0 (например, для нового товара, который еще не сохранен),
                // сервер должен уметь это обработать или вернуть ошибку, если product_id обязателен для preview.
                // В нашем случае /admin/product/<int:product_id>/preview-techcard требует product_id.
                if (!currentProductIdForModal || currentProductIdForModal === '0') {
                    alert("Для предпросмотра техкарты необходимо указание товара. Если это новый товар, сохраните его сначала.");
                    if(removeFileBtnModalEl) removeFileBtnModalEl.click();
                    return;
                }


                fetch(actualPreviewUrl, { 
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayParsedComponentsInModal(data.components, data.total_calculated_cost);
                        if(parsedComponentsBlockModalEl) parsedComponentsBlockModalEl.classList.remove('hidden');
                        if(saveDraftBtnModalEl) saveDraftBtnModalEl.disabled = false;
                        if(submitForApprovalBtnModalEl) submitForApprovalBtnModalEl.disabled = false;
                    } else {
                        showNotification('Ошибка: ' + (data.message || 'Не удалось обработать файл для предпросмотра.'), 'error');
                        if(removeFileBtnModalEl) removeFileBtnModalEl.click(); 
                    }
                })
                .catch(error => {
                    console.error('Ошибка AJAX при парсинге техкарты:', error);
                    showNotification('Сетевая ошибка или ошибка сервера при парсинге техкарты.', 'error');
                    if(removeFileBtnModalEl) removeFileBtnModalEl.click();
                });
            }

            function displayParsedComponentsInModal(components, totalCalculatedCost = null) {
                if (!parsedComponentsTableBodyModalEl) return;
                parsedComponentsTableBodyModalEl.innerHTML = '';
                let missingPriceCount = 0;

                components.forEach((comp, index) => {
                    const row = parsedComponentsTableBodyModalEl.insertRow();
                    row.insertCell().textContent = comp.num || (index + 1);
                    row.insertCell().textContent = comp.articleFromFile || '-';
                    row.insertCell().textContent = comp.nameFromFile || '-';
                    row.insertCell().textContent = parseFloat(comp.quantity).toFixed(3); 
                    row.insertCell().textContent = comp.unitFromFile || '-';

                    let priceCellContent = '<span class="text-red-600 font-semibold">Цена?</span>';
                    let costCellContent = '<span class="text-red-600">-</span>';
                    
                    if (comp.foundInDB) {
                        priceCellContent = formatCurrency(comp.rawMaterialPriceDB);
                        costCellContent = formatCurrency(comp.componentCost);
                        if (comp.rawMaterialPriceDB === null || parseFloat(comp.rawMaterialPriceDB) === 0) {
                            missingPriceCount++;
                            row.classList.add('modal-component-not-found'); 
                            priceCellContent = `<span class="text-orange-600 font-semibold">${parseFloat(comp.rawMaterialPriceDB) === 0 ? 'Цена 0!' : 'Цена?'}</span>`;
                        }
                    } else { 
                         priceCellContent = `${formatCurrency(comp.rawMaterialPriceDB)} (новая)`; // Цена 1.00 по умолчанию
                         costCellContent = formatCurrency(comp.componentCost);
                         row.classList.add('modal-component-new'); 
                    }
                    
                    row.insertCell().innerHTML = priceCellContent;
                    row.insertCell().innerHTML = costCellContent;
                });

                if(componentsCountModalEl) componentsCountModalEl.textContent = components.length;
                if(totalMaterialCostModalEl) totalMaterialCostModalEl.textContent = formatCurrency(totalCalculatedCost !== null ? totalCalculatedCost : 0);
                
                if (missingPriceCount > 0) {
                    if(missingPricesCountModalEl) missingPricesCountModalEl.textContent = missingPriceCount;
                    if(missingPricesWarningModalEl) missingPricesWarningModalEl.classList.remove('hidden');
                } else {
                    if(missingPricesWarningModalEl) missingPricesWarningModalEl.classList.add('hidden');
                }
            }

            if (dropAreaModalEl) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropAreaModalEl.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
                });
                dropAreaModalEl.addEventListener('dragenter', () => dropAreaModalEl.classList.add('dragover'));
                dropAreaModalEl.addEventListener('dragover', () => dropAreaModalEl.classList.add('dragover'));
                dropAreaModalEl.addEventListener('dragleave', () => dropAreaModalEl.classList.remove('dragover'));
                dropAreaModalEl.addEventListener('drop', (e) => {
                    dropAreaModalEl.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        if(fileInputModalEl) fileInputModalEl.files = files; 
                        handleFileSelectInModal(files); 
                    }
                }, false);
            }

            if (fileInputModalEl) {
                fileInputModalEl.addEventListener('change', function () { handleFileSelectInModal(this.files); });
            }

            if (removeFileBtnModalEl) {
                removeFileBtnModalEl.addEventListener('click', () => {
                    currentTechCardFileInModal = null;
                    if(fileInputModalEl) fileInputModalEl.value = '';
                    if(fileInfoModalEl) fileInfoModalEl.classList.add('hidden');
                    if(parsedComponentsBlockModalEl) parsedComponentsBlockModalEl.classList.add('hidden');
                    if(saveDraftBtnModalEl) saveDraftBtnModalEl.disabled = true;
                    if(submitForApprovalBtnModalEl) submitForApprovalBtnModalEl.disabled = true;
                    if(dropAreaModalEl) dropAreaModalEl.classList.remove('border-red-500');
                });
            }
            
            function submitTechCardFromModal(status) {
                if (!currentTechCardFileInModal && !currentTechCardIdForModal) { 
                     alert('Загрузите файл техкарты.'); return;
                }
                if (!currentProductIdForModal && PRODUCT_ID_MAIN_PAGE) { 
                    currentProductIdForModal = PRODUCT_ID_MAIN_PAGE;
                }
                if (!currentProductIdForModal) { // Если все еще нет ID продукта
                    alert('ID товара не определен. Сохраните товар перед добавлением техкарты.'); return;
                }

                const formData = new FormData();
                if (currentTechCardFileInModal && !currentTechCardFileInModal.isExisting) { 
                    formData.append('tech_card_excel_file_modal', currentTechCardFileInModal);
                }
                formData.append('product_id', currentProductIdForModal);
                if (currentTechCardIdForModal) { 
                    formData.append('tech_card_id', currentTechCardIdForModal);
                }
                formData.append('comment', editorCommentModalEl.value);
                formData.append('status', status); 

                fetch(PROCESS_TECHCARD_MODAL_URL, { 
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(data.message || 'Техкарта успешно обработана!', 'success');
                        closeTechCardModal();
                        if (data.redirect_url) { 
                            window.location.href = data.redirect_url;
                        } else { 
                            // Пытаемся обновить данные на основной странице без перезагрузки
                            if (document.getElementById('product-cost-price') && data.new_cost_price !== undefined) {
                                document.getElementById('product-cost-price').value = parseFloat(data.new_cost_price).toFixed(2);
                                if(document.getElementById('cost-price-source')) document.getElementById('cost-price-source').textContent = data.cost_price_source || 'Из техкарты';
                                if (typeof calculateAllPrices === 'function') calculateAllPrices(); 
                            }
                            const summaryDiv = document.getElementById('active-tech-card-summary');
                            if(summaryDiv && data.tech_card_info_html) {
                                summaryDiv.innerHTML = data.tech_card_info_html;
                            } else { // Если нет блока для обновления или HTML не пришел, просто перезагружаем
                                 window.location.reload();
                            }
                        }
                    } else {
                        showNotification('Ошибка: ' + (data.message || 'Не удалось обработать техкарту.'), 'error');
                    }
                })
                .catch(error => {
                    console.error('Ошибка AJAX:', error);
                    showNotification('Сетевая ошибка или ошибка сервера при обработке техкарты.', 'error');
                });
            }

            if(saveDraftBtnModalEl) {
                saveDraftBtnModalEl.addEventListener('click', () => {
                    submitTechCardFromModal(TECH_CARD_STATUS_DRAFT_JS);
                });
            }
            if(submitForApprovalBtnModalEl) {
                submitForApprovalBtnModalEl.addEventListener('click', () => {
                    if (missingPricesWarningModalEl && !missingPricesWarningModalEl.classList.contains('hidden')) {
                        if (!confirm("Внимание! Для некоторых компонентов не найдены цены в справочнике или равны нулю. Себестоимость может быть неточной. Всё равно отправить на согласование?")) {
                            return;
                        }
                    }
                    submitTechCardFromModal(TECH_CARD_STATUS_PENDING_ACCOUNTANT_JS);
                });
            }
            
            const specsContainer = document.getElementById('specifications-container');
            const addSpecBtn = document.getElementById('add-spec-btn');
            if (addSpecBtn && specsContainer) { /* ... (код как раньше) ... */ addSpecBtn.addEventListener('click',()=>{const nSR=document.createElement('div');nSR.className='flex items-center space-x-2 spec-row';nSR.innerHTML=`<input type="text" name="spec_name[]" placeholder="Название характеристики" class="form-input flex-1"><input type="text" name="spec_value[]" placeholder="Значение" class="form-input flex-1"><button type="button" class="text-red-500 hover:text-red-700 remove-spec-btn" title="Удалить характеристику"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>`;specsContainer.appendChild(nSR);});}
            if (specsContainer) { specsContainer.addEventListener('click', function (event) { /* ... (код как раньше) ... */ if(event.target.closest('.remove-spec-btn')){const rTR=event.target.closest('.spec-row');if(specsContainer.querySelectorAll('.spec-row').length>1){rTR.remove();}else{rTR.querySelector('input[name="spec_name[]"]').value='';rTR.querySelector('input[name="spec_value[]"]').value='';}}}); }
            
            const productForm = document.getElementById('product-form');
            if (productForm) { productForm.addEventListener('submit', function (event) { /* ... (код как раньше) ... */ const sN=Array.from(document.querySelectorAll('input[name="spec_name[]"]')).map(i=>i.value.trim());const sV=Array.from(document.querySelectorAll('input[name="spec_value[]"]')).map(i=>i.value.trim());const s={};sN.forEach((n,idx)=>{if(n&&sV[idx]){s[n]=sV[idx];}});let sI=document.querySelector('input[name="specifications_json"]');if(!sI){sI=document.createElement('input');sI.type='hidden';sI.name='specifications_json';productForm.appendChild(sI);}sI.value=JSON.stringify(s);const iO=[];imagePreviewsContainer.querySelectorAll('.product-image-item').forEach(item=>{iO.push(item.dataset.imageFilename);});let iOI=document.querySelector('input[name="image_order"]');if(!iOI){iOI=document.createElement('input');iOI.type='hidden';iOI.name='image_order';productForm.appendChild(iOI);}iOI.value=JSON.stringify(iO);}); }
        
        }); // Конец DOMContentLoaded

        function formatCurrency(amount) {
            if (amount === null || typeof amount === 'undefined' || isNaN(amount)) return "0.00 сом";
            return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'KGS', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount).replace(/\s?сом$/, ' сом');
        }
        function showNotification(message, type = 'info') { // Переместил сюда, чтобы была доступна глобально в скрипте
            const notificationContainerEl = document.getElementById('notification-container'); // Переопределил здесь
            if (!notificationContainerEl) return;

            const notif = document.createElement('div');
            notif.className = `notification-item max-w-xs px-4 py-3 rounded-lg shadow-xl text-white text-sm font-medium transition-all duration-300 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-sky-500'
            }`;
            notif.innerHTML = `
                <i class="fas ${
                    type === 'success' ? 'fa-check-circle' : 
                    type === 'error' ? 'fa-exclamation-triangle' : 'fa-info-circle'
                } mr-2"></i><span>${message}</span>
            `;
            notificationContainerEl.appendChild(notif);
            
            setTimeout(() => {
                notif.classList.add('fade-out');
                setTimeout(() => notif.remove(), 300);
            }, 3500);
        }

    </script>
</body>
</html>

--- Файл: admin_login_page.txt ---

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Вход в Админ-панель - МебельПрайсПро</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Более мягкий фон */
        }
        .login-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .login-card {
            background-color: white;
            padding: 2.5rem; /* Увеличил паддинги */
            border-radius: 12px; /* Более скругленные углы */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1), 0 5px 10px rgba(0, 0, 0, 0.04); /* Улучшенная тень */
            width: 100%;
            max-width: 420px; /* Немного шире */
        }
        .form-input {
            @apply w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 sm:text-sm transition-shadow duration-150 ease-in-out;
        }
        .form-label {
            @apply block text-sm font-medium text-gray-700 mb-1.5; /* Увеличил отступ снизу */
        }
        .btn-primary {
            @apply w-full font-semibold py-3 px-4 rounded-lg shadow-md transition-all duration-150 ease-in-out bg-sky-600 hover:bg-sky-700 text-white focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2;
        }
        .logo-text {
            font-size: 1.75rem; /* Размер лого */
            font-weight: 700;
            color: #1e293b; /* Темно-серый */
        }
        .logo-text span {
            color: #f97316; /* Оранжевый акцент */
        }
        .flash-message {
            @apply p-3 rounded-md text-sm mb-4;
        }
        .flash-success { @apply bg-green-100 text-green-700; }
        .flash-danger { @apply bg-red-100 text-red-700; }
        .flash-warning { @apply bg-yellow-100 text-yellow-700; }
        .flash-info { @apply bg-sky-100 text-sky-700; }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="login-card">
            <div class="text-center mb-8">
                <h1 class="logo-text">Мебель<span class="text-orange-500">Прайс</span>Админ</h1>
                <p class="text-gray-500 text-sm mt-1">Вход в панель управления</p>
            </div>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="flash-message flash-{{ category if category in ['success', 'danger', 'warning', 'info'] else 'info' }}" role="alert">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <form method="POST" action="{{ url_for('login') }}" class="space-y-6">
                {{ form.hidden_tag() if form and form.hidden_tag }} <div>
                    <label for="username" class="form-label">Имя пользователя или Email</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-user text-gray-400"></i>
                        </span>
                        <input type="text" name="username" id="username" class="form-input pl-10" placeholder="admin / admin@example.com" required 
                               value="{{ request.form.username if request and request.form else '' }}">
                    </div>
                </div>

                <div>
                    <div class="flex items-center justify-between">
                        <label for="password" class="form-label">Пароль</label>
                        </div>
                    <div class="relative">
                         <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-lock text-gray-400"></i>
                        </span>
                        <input type="password" name="password" id="password" class="form-input pl-10" placeholder="••••••••" required>
                    </div>
                </div>
                
                <div>
                    <button type="submit" class="btn-primary">
                        Войти
                    </button>
                </div>
            </form>
            
            <p class="mt-8 text-center text-sm text-gray-500">
                Вернуться на <a href="{{ url_for('index') }}" class="font-medium text-sky-600 hover:text-sky-500">главный сайт</a>
            </p>
        </div>
        <footer class="text-center text-sm text-gray-500 mt-8 pb-4">
            &copy; {{ now().year }} МебельПрайсПро. Все права защищены.
        </footer>
    </div>
    <script>
        // Небольшой скрипт для фокуса на поле имени пользователя при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            const usernameInput = document.getElementById('username');
            if (usernameInput) {
                usernameInput.focus();
            }
        });
    </script>
</body>
</html>

--- Файл: admin_products.txt ---


<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление Товарами - МебельПрайсПро Админ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .admin-sidebar {
            transition: width 0.3s ease-in-out;
        }

        .admin-content {
            transition: margin-left 0.3s ease-in-out;
        }

        .form-input, .form-select {
            @apply px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm;
        }

        .table th.sortable-header { 
            @apply cursor-pointer hover:bg-gray-100 relative; 
        }

        .table th .sort-icon-container { 
            @apply inline-flex items-center justify-center ml-1.5 align-middle;
            width: 1em; 
            height: 1em;
        }

        .table th svg.sort-icon {
            @apply h-full w-full;
        }

        .table th svg.sort-icon.neutral { @apply text-gray-400; }
        .table th svg.sort-icon.asc, .table th svg.sort-icon.desc { @apply text-sky-600; }
        
        .table td { @apply px-4 py-3 whitespace-nowrap text-sm text-gray-700; }
        .table tbody tr:nth-child(even) { @apply bg-gray-50; }
        .btn { @apply font-medium py-2 px-4 rounded-md shadow-sm transition-colors duration-150; }
        .btn-primary { @apply bg-sky-600 hover:bg-sky-700 text-white; }
        .btn-secondary { @apply bg-gray-200 hover:bg-gray-300 text-gray-700; }
        .btn-success { @apply bg-green-500 hover:bg-green-600 text-white; }
        .btn-danger { @apply bg-red-500 hover:bg-red-600 text-white; }
        .btn-icon { @apply p-1.5; }

        .status-badge { @apply px-2 inline-flex text-xs leading-5 font-semibold rounded-full; }
        .status-in-stock { @apply bg-green-100 text-green-800; }
        .status-out-of-stock { @apply bg-red-100 text-red-800; }
        .status-on-order { @apply bg-yellow-100 text-yellow-800; }
        .nav-item-count { @apply ml-auto text-xs bg-sky-500 text-white rounded-full px-1.5 py-0.5; }
        .product-thumbnail { @apply h-10 w-10 object-cover rounded-md border border-gray-200; }
        .form-checkbox { @apply rounded text-sky-600 focus:ring-sky-500; }

        .icon-button {
            @apply transition-transform duration-300 ease-in-out transform hover:scale-110;
        }

        .icon-edit {
            @apply text-sky-600 hover:text-sky-800;
        }

        .icon-view {
            @apply text-green-600 hover:text-green-800;
        }

        .icon-delete {
            @apply text-red-600 hover:text-red-800;
        }

        .svg-shadow {
            filter: drop-shadow(0 4px 3px rgba(0, 0, 0, 0.07)) drop-shadow(0 2px 2px rgba(0, 0, 0, 0.06));
        }

        /* Общие стили кнопок и иконок */
        .icon {
            width: 24px;
            height: 24px;
            transition: color 0.3s ease; /* Плавный переход к цвету */
        }

        /* Анимация при наведении */
        .icon:hover {
            transform: scale(1.1); /* Увеличение иконки */
        }
    </style>
</head>
<body class="flex h-screen">
    <aside id="admin-sidebar" class="admin-sidebar w-64 bg-gray-800 text-gray-100 flex flex-col transition-all duration-300 ease-in-out">
        <div class="px-6 py-4 border-b border-gray-700">
            <a href="admin_dashboard.html" class="text-2xl font-semibold text-white">Мебель<span class="text-orange-400">Прайс</span>Админ</a>
        </div>
        <nav class="flex-grow px-3 py-4 space-y-1.5">
            <a href="admin_dashboard.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                Дашборд
            </a>
            <a href="admin_products.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md bg-gray-900 text-sky-400"> 
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                Товары
            </a>
            <!-- Остальные ссылки меню -->
        </nav>
    </aside>

    <div class="flex-1 flex flex-col overflow-hidden">
        <header class="bg-white shadow-sm">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <button id="sidebar-toggle" class="text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-sky-500 md:hidden">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        </button>
                        <h1 class="text-xl font-semibold text-gray-800 ml-3">Управление Товарами</h1>
                    </div>
                    <div class="flex items-center">
                        <span class="text-sm text-gray-600 mr-3">Администратор</span>
                        <img class="h-8 w-8 rounded-full object-cover" src="https://placehold.co/100x100/7dd3fc/0c4a6e?text=A" alt="[Фото пользователя]">
                    </div>
                </div>
            </div>
        </header>
        
        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
            <div class="container mx-auto">
                <div class="mb-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <h2 class="text-2xl font-semibold text-gray-800">Список Товаров (<span id="total-products-count">0</span>)</h2>
                    <div class="flex flex-wrap gap-3">
                        <button id="export-pricelist-btn" class="btn btn-secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline -ml-1 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                            Экспорт прайс-листа (XLS)
                        </button>
                        <a href="admin_product_edit.html" class="btn btn-success">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline -ml-1 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                            Добавить новый товар
                        </a>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-md shadow mb-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-x-4 gap-y-3 items-end">
                        <div class="xl:col-span-2">
                            <label for="filter-product-search-main" class="form-label">Поиск:</label>
                            <input type="text" id="filter-product-search-main" placeholder="Артикул, название..." class="form-input w-full">
                        </div>
                        <div>
                            <label for="filter-category" class="form-label">Категория:</label>
                            <select id="filter-category" class="form-select w-full">
                                <option value="">Все категории</option>
                                <option value="tumbi">Тумбы с раковиной</option>
                                <option value="zerkala">Зеркала и шкафы</option>
                                <option value="penali">Пеналы</option>
                                <option value="komplekti">Комплекты мебели</option>
                                <option value="aksessuari">Аксессуары</option>
                            </select>
                        </div>
                        <div>
                            <label for="filter-availability" class="form-label">Наличие:</label>
                            <select id="filter-availability" class="form-select w-full">
                                <option value="">Все</option>
                                <option value="in_stock">В наличии</option>
                                <option value="on_order">Под заказ</option>
                                <option value="out_of_stock">Нет в наличии</option>
                            </select>
                        </div>
                        <div class="xl:col-start-1"> 
                            <label for="filter-techcard-status" class="form-label">Статус техкарты:</label>
                            <select id="filter-techcard-status" class="form-select w-full">
                                <option value="">Все</option>
                                <option value="no_card">Отсутствует</option>
                                <option value="draft">Черновик</option>
                                <option value="pending">На согласовании</option>
                                <option value="approved">Утверждена</option>
                                <option value="rejected">Отклонена</option>
                            </select>
                        </div>
                        <div class="flex space-x-2 items-end md:col-start-2 lg:col-start-3 xl:col-start-2 mt-4 sm:mt-0">
                            <button id="apply-filter-btn" class="btn btn-primary w-full sm:w-auto">Применить</button>
                            <button id="reset-filter-btn" class="btn btn-secondary w-full sm:w-auto">Сбросить</button>
                        </div>
                    </div>
                </div>

                <div class="bg-white shadow-md rounded-lg overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 table" id="products-table">
                        <thead>
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50">Выбрать</th>
                                <th class="sortable-header px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50" data-sort-by="id">ID <span class="sort-icon-container"></span></th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50">Фото</th>
                                <th class="sortable-header px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50" data-sort-by="sku">Артикул <span class="sort-icon-container"></span></th>
                                <th class="sortable-header px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50" data-sort-by="name">Наименование <span class="sort-icon-container"></span></th>
                                <th class="sortable-header px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50" data-sort-by="category">Категория <span class="sort-icon-container"></span></th>
                                <th class="sortable-header px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50" data-sort-by="price">Цена (сом) <span class="sort-icon-container"></span></th>
                                <th class="sortable-header px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50" data-sort-by="availability">Наличие <span class="sort-icon-container"></span></th>
                                <th class="sortable-header px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50" data-sort-by="techcard_status">Техкарта <span class="sort-icon-container"></span></th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50">Действия</th>
                            </tr>
                        </thead>
                        <tbody id="products-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Динамическое наполнение -->
                        </tbody>
                    </table>
                </div>

                <div class="mt-6 flex justify-center">
                    <nav id="pagination-container" class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        <!-- Динамическая пагинация -->
                    </nav>
                </div>
            </div>
        </main>
    </div>

    <script>
        class ProductManagement {
            constructor() {
                this.products = [];
                this.filteredProducts = [];
                this.currentPage = 1;
                this.itemsPerPage = 10;
                this.totalPages = 0;

                this.initializeDOM();
                this.setupEventListeners();
            }

            initializeDOM() {
                this.filterSearchInput = document.getElementById('filter-product-search-main');
                this.filterCategorySelect = document.getElementById('filter-category');
                this.filterAvailabilitySelect = document.getElementById('filter-availability');
                this.filterTechcardStatus = document.getElementById('filter-techcard-status');
                this.applyFilterButton = document.getElementById('apply-filter-btn');
                this.resetFilterButton = document.getElementById('reset-filter-btn');
                this.productsTableBody = document.getElementById('products-table-body');
                this.paginationContainer = document.getElementById('pagination-container');
                this.totalProductsCount = document.getElementById('total-products-count');
            }

            setupEventListeners() {
                this.applyFilterButton.addEventListener('click', () => this.applyFilters());
                this.resetFilterButton.addEventListener('click', () => this.resetFilters());
            }

            async fetchProducts() {
                // Симуляция получения данных
                this.products = [
                    { id: 1, sku: 'WS-MOD75-ANT', name: 'Тумба "Modern" 75см, антрацит', category: 'tumbi', price: 28500, availability: 'in_stock', techcardStatus: 'approved', thumbnailUrl: 'https://placehold.co/40x40/e0f2fe/0c4a6e?text=Фото1' },
                    { id: 2, sku: 'WS-ZER-ORL', name: 'Зеркало "Orion" с LED подсветкой', category: 'zerkala', price: 12900, availability: 'on_order', techcardStatus: 'pending', thumbnailUrl: 'https://placehold.co/40x40/fef9c3/713f12?text=Фото2' },
                    { id: 3, sku: 'WS-PEN-LIN', name: 'Пенал "Linea Slim" дуб крафт', category: 'penali', price: 17300, availability: 'out_of_stock', techcardStatus: 'no_card', thumbnailUrl: 'https://placehold.co/40x40/ecfccb/365314?text=Фото3' }
                ];

                this.filteredProducts = [...this.products];
                this.renderProducts();
                this.renderPagination();
                this.totalProductsCount.textContent = this.products.length;
            }

            applyFilters() {
                const searchTerm = this.filterSearchInput.value.toLowerCase();
                const category = this.filterCategorySelect.value;
                const availability = this.filterAvailabilitySelect.value;
                const techcardStatus = this.filterTechcardStatus.value;

                this.filteredProducts = this.products.filter(product => {
                    const matchSearch = !searchTerm || 
                        product.sku.toLowerCase().includes(searchTerm) || 
                        product.name.toLowerCase().includes(searchTerm);

                    const matchCategory = !category || product.category === category;
                    const matchAvailability = !availability || product.availability === availability;
                    const matchTechcardStatus = !techcardStatus || product.techcardStatus === techcardStatus;

                    return matchSearch && matchCategory && matchAvailability && matchTechcardStatus;
                });

                this.currentPage = 1;
                this.renderProducts();
                this.renderPagination();
                this.totalProductsCount.textContent = this.filteredProducts.length;
            }

            resetFilters() {
                this.filterSearchInput.value = '';
                this.filterCategorySelect.value = '';
                this.filterAvailabilitySelect.value = '';
                this.filterTechcardStatus.value = '';
                this.filteredProducts = [...this.products];
                this.currentPage = 1;
                this.renderProducts();
                this.renderPagination();
                this.totalProductsCount.textContent = this.products.length;
            }

            renderProducts() {
                const startIndex = (this.currentPage - 1) * this.itemsPerPage;
                const endIndex = startIndex + this.itemsPerPage;
                const pageProducts = this.filteredProducts.slice(startIndex, endIndex);

                this.productsTableBody.innerHTML = pageProducts.map(product => `
                    <tr>
                        <td>
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-sky-600">
                        </td>
                        <td>${product.id}</td>
                        <td><img src="${product.thumbnailUrl}" alt="[Фото товара]" class="product-thumbnail"></td>
                        <td>${product.sku}</td>
                        <td>${product.name}</td>
                        <td>${product.category}</td>
                        <td>${product.price.toLocaleString('ru-RU')} сом</td>
                        <td><span class="status-badge status-${product.availability}">${this.getAvailabilityLabel(product.availability)}</span></td>
                        <td><span class="status-badge status-${product.techcardStatus}">${this.getTechcardStatusLabel(product.techcardStatus)}</span></td>
                        <td class="flex items-center space-x-1 py-3">
                            ${this.renderIconButtons(product)}
                        </td>
                    </tr>
                `).join('');
            }

            renderIconButtons(product) {
                return `
                    <div class="flex items-center space-x-2">
                        <a href="admin_product_edit.html?id=${product.id}" class="icon-button icon-edit" title="Редактировать">
                            <i data-lucide="edit-3" class="icon svg-shadow"></i>
                        </a>
                        <a href="../html/product-detail.html?id=${product.id}" target="_blank" class="icon-button icon-view" title="Просмотреть">
                            <i data-lucide="eye" class="icon svg-shadow"></i>
                        </a>
                        <button onclick="confirmDelete('${product.sku}')" class="icon-button icon-delete" title="Удалить">
                            <i data-lucide="trash-2" class="icon svg-shadow"></i>
                        </button>
                    </div>
                `;
            }

            getAvailabilityLabel(availability) {
                const labels = {
                    'in_stock': 'В наличии',
                    'on_order': 'Под заказ',
                    'out_of_stock': 'Нет в наличии'
                };
                return labels[availability] || availability;
            }

            getTechcardStatusLabel(status) {
                const labels = {
                    'no_card': 'Нет техкарты',
                    'draft': 'Черновик',
                    'pending': 'На согласовании',
                    'approved': 'Утверждена',
                    'rejected': 'Отклонена'
                };
                return labels[status] || status;
            }

            renderPagination() {
                this.totalPages = Math.ceil(this.filteredProducts.length / this.itemsPerPage);
                this.paginationContainer.innerHTML = '';

                for (let i = 1; i <= this.totalPages; i++) {
                    const pageButton = document.createElement('a');
                    pageButton.href = '#';
                    pageButton.textContent = i;
                    pageButton.classList.add(
                        'relative', 'inline-flex', 'items-center', 'px-4', 'py-2', 
                        'border', 'text-sm', 'font-medium',
                        this.currentPage === i ? 'bg-sky-50 border-sky-500 text-sky-600' : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'
                    );
                    pageButton.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.currentPage = i;
                        this.renderProducts();
                        this.renderPagination();
                    });
                    this.paginationContainer.appendChild(pageButton);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const productManagement = new ProductManagement();
            productManagement.fetchProducts();

            lucide.createIcons(); // Инициализация иконок
        });

        function confirmDelete(sku) {
            Swal.fire({
                title: 'Подтверждение удаления',
                text: `Вы действительно хотите удалить товар ${sku}?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Да, удалить!',
                cancelButtonText: 'Отмена',
                background: '#f3f4f6',
                customClass: {
                    popup: 'rounded-lg shadow-2xl',
                    title: 'text-xl font-bold text-gray-800',
                    text: 'text-gray-600'
                },
                animation: true,
                showClass: {
                    popup: 'animate__animated animate__fadeInUp'
                },
                hideClass: {
                    popup: 'animate__animated animate__fadeOutDown'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Удалено!',
                        text

--- Файл: admin_product_edit.txt ---

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }} - МебельПрайсПро Админ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .admin-sidebar { transition: width 0.3s ease-in-out; }
        .admin-content { transition: margin-left 0.3s ease-in-out; }
        .form-input, .form-select, .form-textarea { @apply px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm; }
        .form-label { @apply block text-sm font-medium text-gray-700 mb-1; }
        .btn { @apply font-medium py-2 px-4 rounded-md shadow-sm transition-colors duration-150 ease-in-out; }
        .btn-primary { @apply bg-sky-600 hover:bg-sky-700 text-white; }
        .btn-secondary { @apply bg-gray-200 hover:bg-gray-300 text-gray-800; }
        .btn-success { @apply bg-green-500 hover:bg-green-600 text-white; }
        .btn-warning { @apply bg-yellow-500 hover:bg-yellow-600 text-white; }
        .btn-danger { @apply bg-red-500 hover:bg-red-600 text-white; }
        .nav-item-count { @apply ml-auto text-xs bg-sky-500 text-white rounded-full px-1.5 py-0.5; }
        
        .image-uploader-preview-container { @apply relative group border border-gray-300 rounded-md overflow-hidden w-24 h-24; }
        .image-uploader-preview { @apply w-full h-full object-cover cursor-grab; }
        .image-uploader-preview.sortable-ghost { @apply opacity-50 border-2 border-sky-500; }
        .image-uploader-preview.main-image-indicator { @apply border-2 border-sky-600 shadow-lg; }
        .image-uploader-add { @apply w-24 h-24 border-2 border-dashed border-gray-300 rounded-md flex items-center justify-center text-gray-400 hover:border-sky-500 hover:text-sky-500 cursor-pointer; }
        .image-upload-dropzone { @apply border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-sky-500 bg-gray-50 transition-colors duration-150 ease-in-out; }
        .image-upload-dropzone.dragover { @apply border-sky-500 bg-sky-50 ring-2 ring-sky-500 ring-offset-1; }
        
        .markup-slider-container { @apply flex items-center space-x-3; }
        .markup-slider { @apply w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer; }
        .markup-slider-green::-webkit-slider-thumb { @apply bg-green-500; }
        .markup-slider-green::-moz-range-thumb { @apply bg-green-500; }
        .markup-slider-yellow::-webkit-slider-thumb { @apply bg-yellow-500; }
        .markup-slider-yellow::-moz-range-thumb { @apply bg-yellow-500; }
        .markup-slider-orange::-webkit-slider-thumb { @apply bg-orange-500; }
        .markup-slider-orange::-moz-range-thumb { @apply bg-orange-500; }
        .markup-slider-red::-webkit-slider-thumb { @apply bg-red-500; }
        .markup-slider-red::-moz-range-thumb { @apply bg-red-500; }
        .markup-slider::-webkit-slider-thumb { @apply appearance-none w-5 h-5 rounded-full shadow-md cursor-pointer transition-colors; background-color: #3b82f6; }
        .markup-slider::-moz-range-thumb { @apply w-5 h-5 rounded-full shadow-md cursor-pointer border-none transition-colors; background-color: #3b82f6; }
        
        .status-badge { @apply px-2 py-0.5 text-xs font-medium rounded-full inline-block; }
        .status-approved { @apply bg-green-100 text-green-800; }
        .status-pending-accountant { @apply bg-yellow-100 text-yellow-700; }
        .status-pending-manager { @apply bg-orange-100 text-orange-700; }
        .status-draft { @apply bg-gray-200 text-gray-800; }
        .status-rejected { @apply bg-red-100 text-red-800; } /* Общий для всех отклоненных */
        .status-archived { @apply bg-slate-100 text-slate-600; }
        .status-not-found { @apply bg-gray-100 text-gray-500; }
        .status-needs-prices { @apply bg-amber-100 text-amber-800; } 

        /* Стили для модального окна техкарты */
        .modal-overlay { @apply fixed inset-0 bg-gray-600 bg-opacity-75 transition-opacity; }
        .modal-content { @apply bg-white rounded-lg shadow-xl transform transition-all sm:max-w-3xl w-full p-6; } 
        .modal-table th { @apply px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50; }
        .modal-table td { @apply px-3 py-2 whitespace-nowrap text-sm text-gray-600; }
        .modal-table tbody tr:nth-child(even) { @apply bg-gray-50; }
        .modal-component-not-found td { @apply bg-red-50 text-red-700; } /* Если компонент найден в БД, но цена 0 или не указана */
        .modal-component-new td { @apply bg-yellow-50 text-yellow-700; } /* Если компонент не найден в БД (будет создан новый) */
        .modal-price-placeholder { @apply font-semibold; }

        #drop-area-modal {
            @apply mt-2 p-6 border-2 border-dashed border-gray-300 rounded-md text-center cursor-pointer 
                   hover:border-sky-500 hover:bg-sky-50 transition-colors duration-150 ease-in-out
                   flex flex-col items-center justify-center min-h-[100px]; 
        }
        #drop-area-modal.dragover { 
            @apply border-sky-500 bg-sky-100 ring-2 ring-sky-500 ring-offset-2; 
        }
        #drop-area-modal p { @apply text-sm text-gray-600 pointer-events-none; }
        #drop-area-modal svg { @apply w-10 h-10 text-gray-400 mb-2 pointer-events-none; }
        #file-info-modal { @apply text-sm text-gray-700 mt-2 font-medium; }

        /* Уведомления (Toast) */
        #notification-container { @apply fixed top-4 right-4 z-[1050] space-y-2; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .notification-item { animation: fadeIn 0.3s ease-out, slideIn 0.3s ease-out; }
        .notification-item.fade-out { opacity: 0; transform: translateX(100%); transition: opacity 0.3s ease-in, transform 0.3s ease-in; }
    </style>
</head>
<body class="flex h-screen">

    <aside id="admin-sidebar" class="admin-sidebar w-64 bg-gray-800 text-gray-100 flex flex-col transition-all duration-300 ease-in-out">
        <div class="px-6 py-4 border-b border-gray-700">
            <a href="{{ url_for('admin_dashboard') }}" class="text-2xl font-semibold text-white">Мебель<span class="text-orange-400">Прайс</span>Админ</a>
        </div>
        <nav class="flex-grow px-3 py-4 space-y-1.5">
            <a href="{{ url_for('admin_dashboard') }}" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                Дашборд
            </a>
            <a href="{{ url_for('admin_products') }}" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md bg-gray-900 text-sky-400"> <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                Товары
            </a>
            <a href="{{ url_for('admin_techcard_list') }}" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.153 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM10.5 16.5h3.75m-3.75 0h3.75" /></svg>
                Техкарты (Список)
            </a>
            <a href="{{ url_for('admin_approval_tasks') }}" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                 <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                Согласование Техкарт <span class="nav-item-count" id="nav-approval-count-sidebar">0</span>
            </a>
            <a href="{{ url_for('admin_raw_materials') }}" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10.5 11.25h3M12 15h.008m-7.008 0h14.016m0 0A48.108 48.108 0 0012 15c-2.282 0-4.441.68-6.267 1.875M7.5 7.5h9M3.75 7.5A2.25 2.25 0 016 5.25h12a2.25 2.25 0 012.25 2.25m0 0A2.25 2.25 0 0019.5 6c-.023 0-.046.002-.069.004l-.01.002-.008.001-.002.001-.002 0a.002.002 0 01-.002 0l-.002.001-.008.001-.01.002A2.232 2.232 0 0019.5 6c-1.24 0-2.25.985-2.25 2.188V7.5M3.75 7.5c0 .067.003.132.008.196M12 15c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125h0c-.621 0-1.125.504-1.125 1.125v4.5c0 .621.504 1.125 1.125 1.125h0z" /></svg>
                Сырьё и Цены
            </a>
             <a href="{{ url_for('admin_dealers_list') }}" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345h5.518a.562.562 0 01.329 1.004l-4.243 2.97a.563.563 0 00-.178.643l2.125 5.111a.563.563 0 01-.83.632l-4.243-2.97a.563.563 0 00-.652 0l-4.243 2.97a.563.563 0 01-.83-.632l2.125-5.111a.563.563 0 00-.178-.643l-4.243-2.97a.562.562 0 01.329-1.004h5.518a.563.563 0 00.475-.345L11.48 3.5z" />
                </svg>
                Дилеры и Оптовики
            </a>
            <a href="{{ url_for('admin_users') }}" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" /></svg>
                Пользователи
            </a>
            <a href="{{ url_for('index') }}" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 text-red-400 hover:text-red-300 mt-auto">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" /></svg>
                Выход (на сайт)
            </a>
        </nav>
    </aside>

    <div class="flex-1 flex flex-col overflow-hidden">
        <header class="bg-white shadow-sm">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <button id="sidebar-toggle" class="text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-sky-500 md:hidden">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        </button>
                        <h1 class="text-xl font-semibold text-gray-800 ml-3" id="page-title-main">{{ page_title }}</h1>
                    </div>
                     <div class="flex items-center">
                        <span class="text-sm text-gray-600 mr-3">{{ current_user.username if current_user else 'Гость' }}</span> 
                        <img class="h-8 w-8 rounded-full object-cover" 
                             src="https://placehold.co/100x100/7dd3fc/0c4a6e?text={{ current_user.username[0].upper() if current_user and current_user.username else 'A' }}" 
                             alt="[Фото пользователя]">
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
            <div class="container mx-auto">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="mb-4 p-4 rounded-md 
                                {% if category == 'success' %} bg-green-100 text-green-700 
                                {% elif category == 'danger' %} bg-red-100 text-red-700 
                                {% elif category == 'warning' %} bg-yellow-100 text-yellow-700
                                {% else %} bg-sky-100 text-sky-700 {% endif %}"
                                 role="alert">
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <form id="product-form" method="POST" 
                      action="{{ url_for('admin_edit_product', product_id=product.id) if product and product.id else url_for('admin_add_product') }}"
                      enctype="multipart/form-data">
                    {{ form.hidden_tag() if form }} <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 space-y-6">
                           <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">Основная информация</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="product-name" class="form-label">Наименование товара <span class="text-red-500">*</span></label>
                                        <input type="text" name="name" id="product-name" class="form-input w-full" 
                                               value="{{ product.name if product else (product_data.name if product_data else '') }}" required>
                                    </div>
                                    <div>
                                        <label for="product-sku" class="form-label">Артикул (SKU) <span class="text-red-500">*</span></label>
                                        <input type="text" name="sku" id="product-sku" class="form-input w-full" 
                                               value="{{ product.sku if product else (product_data.sku if product_data else '') }}" required>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">Ценообразование и Наличие</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                                    <div>
                                        <label for="product-cost-price" class="form-label">Себестоимость (сом)</label>
                                        <div class="flex items-center space-x-2">
                                            <input type="number" name="cost_price" id="product-cost-price" class="form-input w-full" 
                                                   step="0.01" min="0" placeholder="0.00" 
                                                   value="{{ '%.2f'|format(product.cost_price|float) if product and product.cost_price is not none else (product_data.cost_price if product_data and product_data.cost_price is not none else '') }}">
                                            <button type="button" id="fetch-cost-from-techcard" 
                                                    class="btn btn-secondary text-xs whitespace-nowrap" 
                                                    title="Подтянуть из утвержденной/обработанной техкарты"
                                                    {% if not product or not product.id or not active_tech_card %}disabled{% endif %}>Авто (ТК)</button>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">Источник: <span id="cost-price-source">{% if product and product.cost_price_source %}{{ product.cost_price_source }}{% else %}Не указана{% endif %}</span></p>
                                    </div>
                                    <div>
                                        <label for="product-markup-percentage" class="form-label">Розничная наценка (%)</label>
                                        <div class="markup-slider-container">
                                            <input type="range" name="markup_slider" id="product-markup-slider" min="0" max="200" 
                                                   value="{{ product.markup_percentage if product and product.markup_percentage is not none else (product_data.markup_percentage if product_data else 50) }}" class="markup-slider flex-grow">
                                            <input type="number" name="markup_percentage" id="product-markup-percentage" 
                                                   value="{{ product.markup_percentage if product and product.markup_percentage is not none else (product_data.markup_percentage if product_data else 50) }}" class="form-input w-20 text-center" step="1" min="0" max="200">
                                            <span>%</span>
                                        </div>
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="product-retail-price" class="form-label">Розничная цена (сом) <span class="text-red-500">*</span></label>
                                        <input type="number" name="price" id="product-retail-price" class="form-input w-full font-semibold" 
                                               step="0.01" min="0" required placeholder="0.00" 
                                               value="{{ '%.2f'|format(product.price|float) if product and product.price is not none else (product_data.price if product_data and product_data.price is not none else '') }}">
                                    </div>
                                    
                                    <div>
                                        <label for="product-wholesale-markup-percentage" class="form-label">Оптовая наценка (%)</label>
                                        <div class="markup-slider-container">
                                            <input type="range" name="wholesale_markup_slider" id="product-wholesale-markup-slider" min="0" max="200" 
                                                   value="{{ product.wholesale_markup_percentage if product and product.wholesale_markup_percentage is not none else (product_data.wholesale_markup_percentage if product_data else 30) }}" class="markup-slider flex-grow">
                                            <input type="number" name="wholesale_markup_percentage" id="product-wholesale-markup-percentage" 
                                                   value="{{ product.wholesale_markup_percentage if product and product.wholesale_markup_percentage is not none else (product_data.wholesale_markup_percentage if product_data else 30) }}" class="form-input w-20 text-center" step="1" min="0" max="200">
                                            <span>%</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="product-wholesale-price" class="form-label">Оптовая цена (сом)</label>
                                        <input type="number" name="wholesale_price" id="product-wholesale-price" class="form-input w-full" 
                                               step="0.01" min="0" placeholder="0.00" 
                                               value="{{ '%.2f'|format(product.wholesale_price|float) if product and product.wholesale_price is not none else (product_data.wholesale_price if product_data and product_data.wholesale_price is not none else '') }}" readonly>
                                    </div>

                                    <div>
                                        <label for="product-dealer-markup-percentage" class="form-label">Дилерская наценка (%)</label>
                                        <div class="markup-slider-container">
                                            <input type="range" name="dealer_markup_slider" id="product-dealer-markup-slider" min="0" max="200" 
                                                   value="{{ product.dealer_markup_percentage if product and product.dealer_markup_percentage is not none else (product_data.dealer_markup_percentage if product_data else 20) }}" class="markup-slider flex-grow">
                                            <input type="number" name="dealer_markup_percentage" id="product-dealer-markup-percentage" 
                                                   value="{{ product.dealer_markup_percentage if product and product.dealer_markup_percentage is not none else (product_data.dealer_markup_percentage if product_data else 20) }}" class="form-input w-20 text-center" step="1" min="0" max="200">
                                            <span>%</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="product-dealer-price" class="form-label">Дилерская цена (сом)</label>
                                        <input type="number" name="dealer_price" id="product-dealer-price" class="form-input w-full" 
                                               step="0.01" min="0" placeholder="0.00" 
                                               value="{{ '%.2f'|format(product.dealer_price|float) if product and product.dealer_price is not none else (product_data.dealer_price if product_data and product_data.dealer_price is not none else '') }}" readonly>
                                    </div>
                                    
                                    <div class="md:col-span-2"> 
                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
                                            <div>
                                                <label for="product-old-price" class="form-label">Старая розничная цена (сом)</label>
                                                <input type="number" name="discounted_price" id="product-old-price" class="form-input w-full" 
                                                    step="0.01" min="0" placeholder="0.00" 
                                                    value="{{ '%.2f'|format(product.discounted_price|float) if product and product.discounted_price is not none else (product_data.discounted_price if product_data and product_data.discounted_price is not none else '') }}">
                                            </div>
                                            <div>
                                                <label class="form-label">Расчетная розничная маржа:</label>
                                                <p class="text-sm text-gray-700 mt-2"><span id="product-margin-amount" class="font-semibold">0.00 сом</span> (<span id="product-margin-percentage" class="font-semibold">0.00</span>%)</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="product-availability" class="form-label">Наличие <span class="text-red-500">*</span></label>
                                        <select id="product-availability" name="availability_status" class="form-select w-full" required>
                                            <option value="in_stock" {% if (product and product.availability_status == 'in_stock') or (product_data and product_data.availability_status == 'in_stock') %}selected{% endif %}>В наличии</option>
                                            <option value="on_order" {% if (product and product.availability_status == 'on_order') or (product_data and product_data.availability_status == 'on_order') %}selected{% endif %}>Под заказ</option>
                                            <option value="out_of_stock" {% if (product and product.availability_status == 'out_of_stock') or (product_data and product_data.availability_status == 'out_of_stock') %}selected{% endif %}>Нет в наличии</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">Описания</h3>
                                <div>
                                    <label for="product-short-description" class="form-label">Краткое описание / Ключевые особенности (каждый пункт с новой строки)</label>
                                    <textarea name="short_description" id="product-short-description" rows="4" class="form-textarea w-full" placeholder="Например:&#10;- Современный дизайн&#10;- Влагостойкие материалы">{{ product.short_description if product else (product_data.short_description if product_data else '') }}</textarea>
                                </div>
                                <div class="mt-4">
                                    <label for="product-full-description" class="form-label">Полное описание</label>
                                    <textarea name="description" id="product-full-description" rows="8" class="form-textarea w-full hidden">{{ product.description if product else (product_data.description if product_data else '') }}</textarea>
                                    <div id="quill-editor-container" class="form-textarea w-full min-h-[200px]">
                                        </div>
                                    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
                                    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-lg shadow" id="product-techcard-section">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-medium text-gray-900">Техническая карта и Состав</h3>
                                    <button type="button" 
                                            id="open-techcard-modal-btn"
                                            class="btn btn-secondary btn-sm"
                                            {% if not product or not product.id %}disabled title="Сначала сохраните товар, чтобы управлять техкартой."{% endif %}>
                                        {% if active_tech_card %}Редактировать/Загрузить новую{% else %}Добавить техкарту{% endif %}
                                    </button>
                                </div>
                                <div id="active-tech-card-summary">
                                   {% include 'admin/_tech_card_summary_snippet.html' %}
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">Технические характеристики</h3>
                                <div id="specifications-container" class="space-y-3">
                                    {% set specs_data = (product.specifications|fromjson if product and product.specifications else (product_data.specifications_json|fromjson if product_data and product_data.specifications_json else {})) %}
                                    {% if specs_data and specs_data is mapping and specs_data|length > 0 %}
                                        {% for spec_name, spec_value in specs_data.items() %}
                                        <div class="flex items-center space-x-2 spec-row">
                                            <input type="text" name="spec_name[]" placeholder="Название характеристики" class="form-input flex-1" value="{{ spec_name }}">
                                            <input type="text" name="spec_value[]" placeholder="Значение" class="form-input flex-1" value="{{ spec_value }}">
                                            <button type="button" class="text-red-500 hover:text-red-700 remove-spec-btn" title="Удалить характеристику">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                            </button>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                     <div class="flex items-center space-x-2 spec-row">
                                        <input type="text" name="spec_name[]" placeholder="Название характеристики (напр. Ширина)" class="form-input flex-1">
                                        <input type="text" name="spec_value[]" placeholder="Значение (напр. 750 мм)" class="form-input flex-1">
                                        <button type="button" class="text-red-500 hover:text-red-700 remove-spec-btn" title="Удалить характеристику">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                        </button>
                                    </div>
                                    {% endif %}
                                </div>
                                <button type="button" id="add-spec-btn" class="mt-3 btn btn-secondary text-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline -ml-1 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                                    Добавить характеристику
                                </button>
                            </div>
                        </div>

                        <div class="lg:col-span-1 space-y-6">
                            <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">Организация</h3>
                                <div>
                                    <label for="product-category" class="form-label">Категория товара <span class="text-red-500">*</span></label>
                                    <select id="product-category" name="category_id" class="form-select w-full" required>
                                        <option value="">Выберите категорию</option>
                                        {% for category_item in categories %} 
                                        <option value="{{ category_item.id }}" 
                                                {% if product and product.category_id == category_item.id %}selected
                                                {% elif product_data and product_data.category_id and product_data.category_id|int == category_item.id %}selected
                                                {% endif %}>
                                            {{ category_item.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mt-4">
                                    <label for="product-status" class="form-label">Статус товара</label>
                                    <select id="product-status" name="is_published" class="form-select w-full">
                                        <option value="true" {% if (product and product.is_published) or (product_data and product_data.is_published == 'true') %}selected{% endif %}>Опубликован</option>
                                        <option value="false" {% if (product and not product.is_published) or (product_data and product_data.is_published == 'false') or (not product and not product_data) %}selected{% endif %}>Черновик</option>
                                    </select>
                                </div>
                                <div class="mt-4">
                                    <label for="product-weight" class="form-label">Вес (кг)</label>
                                    <input type="number" name="weight" id="product-weight" class="form-input w-full" 
                                           step="0.01" min="0" value="{{ product.weight if product and product.weight is not none else (product_data.weight if product_data else '') }}">
                                </div>
                                <div class="mt-4">
                                    <label for="product-dimensions" class="form-label">Габариты (ДxШxВ см)</label>
                                    <input type="text" name="dimensions" id="product-dimensions" class="form-input w-full" 
                                           placeholder="например, 120x60x75" value="{{ product.dimensions if product else (product_data.dimensions if product_data else '') }}">
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">Изображения товара</h3>
                                <div id="image-upload-dropzone-area" class="image-upload-dropzone mb-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                    <p class="text-gray-500 text-sm">Перетащите файлы сюда или <span class="text-sky-600 font-semibold">нажмите для выбора</span></p>
                                    <p class="text-xs text-gray-400 mt-1">PNG, JPG, GIF, WEBP</p>
                                </div>
                                <div id="image-previews" class="grid grid-cols-3 sm:grid-cols-4 gap-3 mb-3">
                                    {% if product and product.images %}
                                        {% for image in product.images|sort(attribute='order_index') %}
                                            <div class="image-uploader-preview-container product-image-item" data-image-id="{{ image.id }}" data-image-filename="{{ image.image_url.split('/')[-1] }}">
                                                <img src="{{ url_for('static', filename=image.image_url) }}" alt="{{ image.alt_text or 'Изображение товара' }}" 
                                                     class="image-uploader-preview {% if image.is_main %}main-image-indicator{% endif %}">
                                                <button type="button" class="absolute top-0 right-0 m-1 p-0.5 bg-red-600 hover:bg-red-700 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity remove-image-btn" title="Удалить изображение" data-image-id="{{ image.id }}">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                                </button>
                                                {% if not image.is_main %}
                                                <button type="button" class="absolute bottom-0 left-0 m-1 p-0.5 bg-sky-600 hover:bg-sky-700 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity set-main-image-btn" title="Сделать главным">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                                                </button>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    {% endif %}
                                    </div>
                                <input type="file" name="product_images_upload[]" id="image-upload-input" multiple accept="image/*" class="hidden">
                                {% set main_image_filename_val = '' %}
                                {% if product and product.images %}
                                    {% set main_image_obj = (product.images|selectattr('is_main', 'true')|first) %}
                                    {% if main_image_obj %}
                                        {% set main_image_filename_val = main_image_obj.image_url.split('/')[-1] %}
                                    {% elif product.images|sort(attribute='order_index')|first %}
                                         {% set main_image_filename_val = (product.images|sort(attribute='order_index')|first).image_url.split('/')[-1] %}
                                    {% endif %}
                                {% endif %}
                                <input type="hidden" name="main_image_filename" id="main-image-filename-input" value="{{ main_image_filename_val }}">
                                <input type="hidden" name="image_order" id="image-order-input" value="">
                                <p class="text-xs text-gray-500">Первое изображение является главным. Перетащите для изменения порядка. Нажмите на звездочку, чтобы сделать изображение главным.</p>
                            </div>
                            
                            <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">SEO-Настройки</h3>
                                <div>
                                    <label for="seo-title" class="form-label">SEO Title</label>
                                    <input type="text" name="seo_title" id="seo-title" class="form-input w-full" value="{{ product.seo_title if product else (product_data.seo_title if product_data else '') }}">
                                </div>
                                <div class="mt-4">
                                    <label for="seo-description" class="form-label">Meta Description</label>
                                    <textarea name="seo_description" id="seo-description" rows="3" class="form-textarea w-full">{{ product.seo_description if product else (product_data.seo_description if product_data else '') }}</textarea>
                                </div>
                                <div class="mt-4">
                                    <label for="seo-keywords" class="form-label">Meta Keywords (через запятую)</label>
                                    <input type="text" name="seo_keywords" id="seo-keywords" class="form-input w-full" value="{{ product.seo_keywords if product else (product_data.seo_keywords if product_data else '') }}">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 pt-6 border-t border-gray-300 flex justify-end space-x-3">
                        <a href="{{ url_for('admin_products') }}" class="btn btn-secondary">Отмена</a>
                        <button type="submit" class="btn btn-success">
                            {% if product and product.id %}Сохранить товар{% else %}Добавить товар{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </main>
    </div>
    
    <div id="techCardModal" class="fixed inset-0 z-[100] overflow-y-auto hidden" aria-labelledby="modal-title-techcard" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="modal-overlay fixed inset-0 bg-gray-600 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeTechCardModal()"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

            <div class="modal-content inline-block align-bottom sm:align-middle sm:my-8 text-left">
                <div>
                    <div class="flex justify-between items-center pb-3 border-b mb-4">
                        <h3 class="text-xl font-semibold text-gray-800" id="modal-title-techcard">
                            Обработка Техкарты
                        </h3>
                        <button type="button" onclick="closeTechCardModal()" class="text-gray-400 hover:text-gray-600">
                            <span class="sr-only">Закрыть</span>
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>

                    <div id="modal-product-info-techcard" class="text-sm text-gray-600 mb-4">
                        </div>
                    
                    <input type="hidden" id="modal-product-id-techcard" name="modal_product_id_techcard_val" value=""> 
                    <input type="hidden" id="modal-tech-card-id" name="modal_tech_card_id_val" value=""> 
                    
                    <div id="upload-block-modal" class="mb-6">
                        <label class="form-label" for="techcard-file-input-modal">Файл техкарты (XLSX/XLS):</label>
                        <div id="drop-area-modal" class="techcard-dropzone"> 
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 text-gray-400 mb-2 pointer-events-none">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                            </svg>
                            <p class="pointer-events-none">Перетащите XLSX/XLS файл сюда или
                                <span class="font-medium text-sky-600 hover:text-sky-500 cursor-pointer" onclick="document.getElementById('techcard-file-input-modal').click()">выберите файл</span>
                            </p>
                            <input type="file" name="tech_card_excel_file_modal_input" id="techcard-file-input-modal" class="hidden" accept=".xlsx,.xls,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel">
                        </div>
                        <div id="file-info-modal" class="mt-2 text-sm text-gray-700 hidden">
                            Выбран файл: <span class="font-medium" id="loaded-file-name-modal"></span> (<span id="loaded-file-size-modal"></span>)
                            <button type="button" id="remove-file-btn-modal" class="text-red-500 hover:text-red-700 ml-2 text-xs font-semibold">(удалить)</button>
                        </div>
                    </div>

                    <div id="parsed-components-block-modal" class="mb-6 hidden">
                        <h4 class="text-md font-semibold text-gray-700 mb-2">Предварительный просмотр компонентов:</h4>
                        <div class="max-h-60 overflow-y-auto border border-gray-200 rounded-md">
                            <table class="min-w-full divide-y divide-gray-200 text-sm modal-table">
                                <thead>
                                    <tr>
                                        <th>№</th><th>Артикул (файл)</th><th>Наименование (файл)</th>
                                        <th>Кол-во</th><th>Ед.изм.</th><th>Цена сырья (БД)</th><th>Стоимость</th>
                                    </tr>
                                </thead>
                                <tbody id="parsed-components-table-body-modal" class="bg-white divide-y divide-gray-200">
                                    </tbody>
                            </table>
                        </div>
                        <div class="mt-3 text-right">
                            <p class="text-sm">Количество позиций: <span class="font-semibold" id="components-count-modal">0</span></p>
                            <p class="text-sm text-red-500 hidden" id="missing-prices-warning-modal">Внимание! Для <span id="missing-prices-count-modal">0</span> компонент(а/ов) не найдены цены в справочнике или равны нулю.</p>
                            <p class="text-md mt-1">Общая себестоимость (материалы): <strong class="text-lg text-blue-700" id="total-material-cost-modal">0.00 сом</strong></p>
                        </div>
                         <div id="parser-warnings-modal" class="mt-2 text-xs text-yellow-600">
                            </div>
                    </div>

                    <div class="mt-4">
                        <label for="editor-comment-modal" class="form-label">Комментарий (необязательно):</label>
                        <textarea id="editor-comment-modal" name="editor_comment_modal_val" class="form-textarea w-full" rows="3" placeholder="Например, укажите причину обновления или на что обратить внимание..."></textarea>
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t border-gray-200 flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3">
                    <button type="button" onclick="closeTechCardModal()" class="btn btn-secondary w-full sm:w-auto">Отмена</button>
                    <button type="button" id="save-draft-techcard-modal-btn" class="btn btn-warning w-full sm:w-auto" disabled>Сохранить черновик</button>
                    <button type="button" id="submit-techcard-for-approval-modal-btn" class="btn btn-primary w-full sm:w-auto" disabled>Отправить на согласование</button>
                </div>
            </div>
        </div>
    </div>
    <div id="notification-container"></div>

    <script>
        // --- Глобальные переменные и константы для JS ---
        const PRODUCT_ID_MAIN_PAGE = {{ product.id|tojson if product and product.id else 'null' }};
        const PRODUCT_NAME_MAIN_PAGE = "{{ product.name | e if product else 'Новый товар' }}";
        const PRODUCT_SKU_MAIN_PAGE = "{{ product.sku | e if product else '---' }}";
        
        // Данные для кнопки "Авто (ТК)" на основной странице
        const TECH_CARD_COST_FROM_SERVER_MAIN_PAGE = parseFloat("{{ active_tech_card.total_cost if active_tech_card and active_tech_card.total_cost is not none else '0' }}");
        const TECH_CARD_STATUS_FROM_SERVER_MAIN_PAGE = "{{ active_tech_card.status | e if active_tech_card else 'Нет данных' }}";
        const LATEST_TECH_CARD_UPDATED_AT_MAIN_PAGE = "{{ active_tech_card.updated_at.strftime('%d.%m.%Y %H:%M') if active_tech_card and active_tech_card.updated_at else 'N/A' }}";
        
        // URL для AJAX запросов из модального окна
        const PREVIEW_TECHCARD_URL_TEMPLATE = "{{ url_for('admin_preview_techcard_components', product_id=0) }}".replace('/0', '/<product_id_placeholder>');
        const PROCESS_TECHCARD_MODAL_URL = "{{ url_for('admin_process_techcard_from_modal') }}"; 

        // Константы статусов техкарты из Flask
        const TECH_CARD_STATUS_DRAFT_JS = "{{ TECH_CARD_STATUS_DRAFT }}";
        const TECH_CARD_STATUS_PENDING_ACCOUNTANT_JS = "{{ TECH_CARD_STATUS_PENDING_ACCOUNTANT }}";
        const TECH_CARD_STATUS_APPROVED_JS = "{{ TECH_CARD_STATUS_APPROVED }}";
        const TECH_CARD_STATUS_PROCESSED_JS = "{{ TECH_CARD_STATUS_PROCESSED }}";
        const TECH_CARD_STATUS_PROCESSED_NEEDS_PRICES_JS = "{{ TECH_CARD_STATUS_PROCESSED_NEEDS_PRICES }}";
        // Добавьте другие статусы, если они нужны в JS логике

        // --- DOM элементы для уведомлений ---
        const notificationContainerEl = document.getElementById('notification-container');

        document.addEventListener('DOMContentLoaded', () => {
            // --- Инициализация сайдбара ---
            const sidebar = document.getElementById('admin-sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            if (sidebarToggle && sidebar) {
                sidebarToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('w-64'); // Полная ширина
                    sidebar.classList.toggle('w-16'); // Свернутая ширина
                    // Сохранение состояния сайдбара в localStorage
                    if (sidebar.classList.contains('w-16')) {
                        localStorage.setItem('sidebarCollapsed', 'true');
                    } else {
                        localStorage.removeItem('sidebarCollapsed');
                    }
                });
                // Восстановление состояния сайдбара при загрузке страницы
                if (localStorage.getItem('sidebarCollapsed') === 'true') {
                     sidebar.classList.remove('w-64');
                     sidebar.classList.add('w-16');
                }
            }
            
            // --- Инициализация Quill RTE (Rich Text Editor) ---
            var quill = null;
            if (document.getElementById('quill-editor-container')) {
                quill = new Quill('#quill-editor-container', {
                    theme: 'snow',
                    modules: { 
                        toolbar: [
                            [{ 'header': [1, 2, 3, false] }],
                            ['bold', 'italic', 'underline', 'strike'],
                            [{'list': 'ordered'}, {'list': 'bullet'}],
                            [{ 'align': [] }],
                            ['link', 'image'], // Можно добавить 'video'
                            ['clean']
                        ]
                    },
                    placeholder: 'Введите полное описание товара здесь...'
                });
                const fullDescriptionTextarea = document.getElementById('product-full-description');
                if (fullDescriptionTextarea && fullDescriptionTextarea.value) {
                    try {
                        // Пытаемся распарсить как JSON (Delta формат Quill)
                        const deltaOrHtml = JSON.parse(fullDescriptionTextarea.value);
                        if (typeof deltaOrHtml === 'object' && deltaOrHtml.ops) { 
                            quill.setContents(deltaOrHtml); 
                        } else { 
                            // Если не Delta, считаем, что это HTML
                            quill.clipboard.dangerouslyPasteHTML(0, deltaOrHtml); 
                        }
                    } catch (e) { 
                        // Если не JSON, считаем, что это простой HTML или текст
                        quill.clipboard.dangerouslyPasteHTML(0, fullDescriptionTextarea.value); 
                    }
                }
                // При отправке формы, сохраняем содержимое Quill в скрытое textarea
                const productFormForQuill = document.getElementById('product-form');
                if (productFormForQuill) {
                    productFormForQuill.addEventListener('submit', function() {
                        if (quill && fullDescriptionTextarea) { 
                            // Сохраняем как JSON (Delta формат) для лучшей совместимости
                            fullDescriptionTextarea.value = JSON.stringify(quill.getContents()); 
                        }
                    });
                }
            }

            // --- Логика управления ценами ---
            const costPriceInput = document.getElementById('product-cost-price');
            const costPriceSourceEl = document.getElementById('cost-price-source');
            const fetchCostBtn = document.getElementById('fetch-cost-from-techcard');
            
            const markupSlider = document.getElementById('product-markup-slider');
            const markupPercentageInput = document.getElementById('product-markup-percentage');
            const retailPriceInput = document.getElementById('product-retail-price');
            
            const wholesaleMarkupSlider = document.getElementById('product-wholesale-markup-slider');
            const wholesaleMarkupPercentageInput = document.getElementById('product-wholesale-markup-percentage');
            const wholesalePriceInput = document.getElementById('product-wholesale-price');
            
            const dealerMarkupSlider = document.getElementById('product-dealer-markup-slider');
            const dealerMarkupPercentageInput = document.getElementById('product-dealer-markup-percentage');
            const dealerPriceInput = document.getElementById('product-dealer-price');
            
            const marginAmountEl = document.getElementById('product-margin-amount');
            const marginPercentageEl = document.getElementById('product-margin-percentage');
            
            function calculateAllPrices() {
                const cost = parseFloat(costPriceInput.value) || 0;

                // Розничная цена
                const retailMarkup = parseFloat(markupPercentageInput.value) || 0;
                if (cost > 0 && retailMarkup >= 0) { 
                    retailPriceInput.value = (cost * (1 + retailMarkup / 100)).toFixed(2);
                } else if (!(cost === 0 && retailPriceInput.value && parseFloat(retailPriceInput.value) > 0)) {
                     // Если себестоимость 0, но розничная цена введена вручную, не перезаписываем ее.
                     // Иначе, если розничная цена не введена или 0, ставим ее равной себестоимости (или пустой, если себестоимость 0).
                     if (!retailPriceInput.value || parseFloat(retailPriceInput.value) === 0) {
                         retailPriceInput.value = cost > 0 ? cost.toFixed(2) : ""; 
                     }
                }
                
                // Оптовая цена
                const wholesaleMarkup = parseFloat(wholesaleMarkupPercentageInput.value) || 0;
                if (cost > 0 && wholesaleMarkup >= 0) { 
                    wholesalePriceInput.value = (cost * (1 + wholesaleMarkup / 100)).toFixed(2);
                } else { 
                    wholesalePriceInput.value = cost > 0 ? cost.toFixed(2) : "";
                }

                // Дилерская цена
                const dealerMarkup = parseFloat(dealerMarkupPercentageInput.value) || 0;
                if (cost > 0 && dealerMarkup >= 0) { 
                    dealerPriceInput.value = (cost * (1 + dealerMarkup / 100)).toFixed(2);
                } else { 
                    dealerPriceInput.value = cost > 0 ? cost.toFixed(2) : "";
                }
                updateMargin();
            }

            function updateMarkupFromRetail() {
                const cost = parseFloat(costPriceInput.value) || 0;
                const retail = parseFloat(retailPriceInput.value) || 0;

                if (cost > 0 && retail >= cost) {
                    const markup = ((retail - cost) / cost) * 100;
                    markupPercentageInput.value = markup.toFixed(0); // Округляем до целого для слайдера
                    if(markupSlider) markupSlider.value = markup.toFixed(0);
                    updateSliderColor(markupSlider, markup);
                } else if (cost > 0 && retail < cost && retail > 0) { 
                    // Если розничная цена ниже себестоимости (но не 0), ставим наценку 0
                    if(markupPercentageInput) markupPercentageInput.value = "0"; 
                    if(markupSlider) markupSlider.value = "0";
                    updateSliderColor(markupSlider, 0);
                } else if (cost === 0 && retail > 0) { 
                    // Если себестоимость 0, а розничная цена есть, наценка максимальная (или иное поведение)
                    if(markupPercentageInput) markupPercentageInput.value = "200"; // Пример максимальной наценки
                    if(markupSlider) markupSlider.value = "200";
                    updateSliderColor(markupSlider, 200);
                } else if (markupSlider) { 
                    // Если розничная цена 0 или некорректна, берем значение из слайдера
                    if(markupPercentageInput) markupPercentageInput.value = markupSlider.value; 
                    updateSliderColor(markupSlider, parseFloat(markupSlider.value));
                }
                // Важно: после обновления наценки из розничной цены, нужно пересчитать все цены,
                // чтобы оптовая и дилерская тоже обновились, если они зависят от себестоимости и своих наценок.
                // Но если розничная цена введена вручную, она не должна меняться от этого вызова.
                // calculateAllPrices(); // Этот вызов может перезаписать retailPriceInput, если он был изменен вручную.
                // Вместо этого, только обновим маржу и зависимые цены (опт, дилер), если они не заблокированы.
                const wholesaleMarkup = parseFloat(wholesaleMarkupPercentageInput.value) || 0;
                if (cost > 0 && wholesaleMarkup >= 0) { wholesalePriceInput.value = (cost * (1 + wholesaleMarkup / 100)).toFixed(2);} 
                else { wholesalePriceInput.value = cost > 0 ? cost.toFixed(2) : "";}
                const dealerMarkup = parseFloat(dealerMarkupPercentageInput.value) || 0;
                if (cost > 0 && dealerMarkup >= 0) { dealerPriceInput.value = (cost * (1 + dealerMarkup / 100)).toFixed(2);}
                else { dealerPriceInput.value = cost > 0 ? cost.toFixed(2) : "";}
                updateMargin();
            }

            function updateMargin() {
                const cost = parseFloat(costPriceInput.value) || 0;
                const retail = parseFloat(retailPriceInput.value) || 0;
                let marginAmount = 0; 
                let marginPercentage = 0;

                if (retail > 0) { // Маржу считаем, только если есть розничная цена
                    marginAmount = retail - cost;
                    if (cost > 0) { 
                        marginPercentage = (marginAmount / cost) * 100;
                    } else if (retail > 0 && cost === 0) {
                        marginPercentage = Infinity; // Бесконечная маржа, если себестоимость 0, а цена есть
                    }
                }
                if (marginAmountEl) marginAmountEl.textContent = formatCurrency(marginAmount);
                if (marginPercentageEl) marginPercentageEl.textContent = isFinite(marginPercentage) ? marginPercentage.toFixed(2) : (marginPercentage === Infinity ? "?" : "0.00");
            }
            
            function updateSliderColor(sliderElement, value) {
                if (!sliderElement) return;
                sliderElement.classList.remove('markup-slider-green', 'markup-slider-yellow', 'markup-slider-orange', 'markup-slider-red');
                if (value < 0) { // Убыток
                    sliderElement.classList.add('markup-slider-red');
                } else if (value <= 30) { // Низкая наценка
                    sliderElement.classList.add('markup-slider-orange');
                } else if (value <= 70) { // Средняя наценка
                    sliderElement.classList.add('markup-slider-yellow');
                } else { // Высокая наценка
                    sliderElement.classList.add('markup-slider-green');
                }
            }

            // Обработчики для полей цен и наценок
            if (fetchCostBtn) { 
                fetchCostBtn.addEventListener('click', () => {
                    if (TECH_CARD_COST_FROM_SERVER_MAIN_PAGE !== null && TECH_CARD_COST_FROM_SERVER_MAIN_PAGE >= 0 &&
                        (TECH_CARD_STATUS_FROM_SERVER_MAIN_PAGE === TECH_CARD_STATUS_APPROVED_JS || 
                         TECH_CARD_STATUS_FROM_SERVER_MAIN_PAGE === TECH_CARD_STATUS_PROCESSED_JS)) {
                        costPriceInput.value = TECH_CARD_COST_FROM_SERVER_MAIN_PAGE.toFixed(2);
                        if(costPriceSourceEl) costPriceSourceEl.textContent = `Из техкарты (${TECH_CARD_STATUS_FROM_SERVER_MAIN_PAGE}, от ${LATEST_TECH_CARD_UPDATED_AT_MAIN_PAGE})`;
                        calculateAllPrices(); // Пересчитываем все цены на основе новой себестоимости
                    } else {
                        let alertMessage = 'Активная (утвержденная/обработанная) техкарта с корректной себестоимостью не найдена для этого товара, или себестоимость равна нулю.';
                        if (TECH_CARD_STATUS_FROM_SERVER_MAIN_PAGE === TECH_CARD_STATUS_PROCESSED_NEEDS_PRICES_JS) {
                            alertMessage = 'Себестоимость по техкарте не может быть подставлена, так как не для всех компонентов сырья указаны цены. Пожалуйста, проверьте цены на сырье и переобработайте техкарту.';
                        } else if (TECH_CARD_STATUS_FROM_SERVER_MAIN_PAGE && TECH_CARD_STATUS_FROM_SERVER_MAIN_PAGE !== 'Нет данных') {
                                alertMessage = `Текущий статус техкарты "${TECH_CARD_STATUS_FROM_SERVER_MAIN_PAGE}" не позволяет автоматически рассчитать себестоимость. Требуется статус "${TECH_CARD_STATUS_APPROVED_JS}" или "${TECH_CARD_STATUS_PROCESSED_JS}" с корректной себестоимостью.`;
                        }
                        showNotification(alertMessage, 'warning');
                        if(costPriceSourceEl) costPriceSourceEl.textContent = 'Техкарта не найдена/неприменима';
                    }
                });
            }

            if (costPriceInput) {
                costPriceInput.addEventListener('input', () => { 
                    if(costPriceSourceEl) costPriceSourceEl.textContent = 'Введено вручную'; 
                    calculateAllPrices(); 
                });
            }

            // Общий обработчик для слайдера и инпута наценки
            function setupMarkupSlider(sliderEl, inputEl) {
                if (sliderEl && inputEl) {
                    const update = (source) => {
                        const value = parseFloat(source.value);
                        const clampedValue = Math.max(0, Math.min(200, isNaN(value) ? 0 : value));
                        if (source.type === 'range') {
                            inputEl.value = clampedValue.toFixed(0);
                        } else {
                            sliderEl.value = clampedValue;
                        }
                        updateSliderColor(sliderEl, clampedValue);
                        calculateAllPrices();
                    };
                    sliderEl.addEventListener('input', (e) => update(e.target));
                    inputEl.addEventListener('input', (e) => update(e.target));
                    // Инициализация цвета слайдера при загрузке
                    updateSliderColor(sliderEl, parseFloat(sliderEl.value));
                }
            }
            setupMarkupSlider(markupSlider, markupPercentageInput);
            setupMarkupSlider(wholesaleMarkupSlider, wholesaleMarkupPercentageInput);
            setupMarkupSlider(dealerMarkupSlider, dealerMarkupPercentageInput);
            
            if (retailPriceInput) {
                retailPriceInput.addEventListener('input', updateMarkupFromRetail);
            }
            
            // Первоначальный расчет всех цен и маржи при загрузке страницы
            calculateAllPrices();

            // --- Логика управления изображениями ---
            const imageDropZoneArea = document.getElementById('image-upload-dropzone-area');
            const imageUploadInput = document.getElementById('image-upload-input');
            const imagePreviewsContainer = document.getElementById('image-previews');
            const mainImageFilenameInput = document.getElementById('main-image-filename-input');
            const imageOrderInput = document.getElementById('image-order-input'); // Для порядка изображений

            function handleImageFiles(files) {
                Array.from(files).forEach(file => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            // Создаем элемент предпросмотра для нового файла
                            createImagePreviewElement(e.target.result, file.name, null, file);
                        };
                        reader.readAsDataURL(file);
                    } else {
                        showNotification(`Файл ${file.name} не является изображением.`, 'warning');
                    }
                });
                updateImageOrderInput(); // Обновляем порядок после добавления
            }

            function createImagePreviewElement(src, filename, imageId = null, fileObject = null) {
                const previewWrapper = document.createElement('div');
                previewWrapper.className = 'image-uploader-preview-container product-image-item';
                if (imageId) previewWrapper.dataset.imageId = imageId;
                previewWrapper.dataset.imageFilename = filename; // Всегда храним имя файла
                if (fileObject) previewWrapper.dataset.isNew = "true"; // Пометка для новых файлов

                const img = document.createElement('img');
                img.src = src;
                img.alt = 'Предпросмотр';
                img.className = 'image-uploader-preview';

                const removeButton = document.createElement('button');
                removeButton.type = 'button';
                removeButton.title = 'Удалить изображение';
                removeButton.className = 'absolute top-0 right-0 m-1 p-0.5 bg-red-600 hover:bg-red-700 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity remove-image-btn';
                if (imageId) removeButton.dataset.imageId = imageId; // Для существующих изображений
                removeButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>';

                const setMainButton = document.createElement('button');
                setMainButton.type = 'button';
                setMainButton.title = 'Сделать главным';
                setMainButton.className = 'absolute bottom-0 left-0 m-1 p-0.5 bg-sky-600 hover:bg-sky-700 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity set-main-image-btn';
                setMainButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>';

                previewWrapper.appendChild(img);
                previewWrapper.appendChild(removeButton);
                previewWrapper.appendChild(setMainButton);
                imagePreviewsContainer.appendChild(previewWrapper);
                
                updateMainImageIndicatorAndInput(); // Обновляем индикатор и скрытое поле
            }

            function updateMainImageIndicatorAndInput() {
                const allPreviewItems = imagePreviewsContainer.querySelectorAll('.product-image-item');
                let mainImageFilename = "";

                allPreviewItems.forEach((itemWrapper, index) => {
                    const imgElement = itemWrapper.querySelector('.image-uploader-preview');
                    const setMainBtn = itemWrapper.querySelector('.set-main-image-btn');
                    
                    imgElement.classList.remove('main-image-indicator');
                    if (setMainBtn) setMainBtn.style.display = 'block'; // Показываем кнопку "сделать главным"

                    if (index === 0 && !mainImageFilename) { // Если это первое изображение и главное еще не найдено
                        imgElement.classList.add('main-image-indicator');
                        mainImageFilename = itemWrapper.dataset.imageFilename || '';
                        if (setMainBtn) setMainBtn.style.display = 'none'; // Скрываем кнопку, если уже главное
                    }
                });

                // Если после перебора первое изображение стало главным, обновляем input
                if (mainImageFilenameInput) mainImageFilenameInput.value = mainImageFilename;

                // Если есть изображение с флагом is_main (например, пришло с сервера), оно должно быть главным
                const explicitlyMain = Array.from(allPreviewItems).find(item => item.querySelector('.image-uploader-preview.main-image-indicator'));
                if (explicitlyMain) {
                     if (mainImageFilenameInput) mainImageFilenameInput.value = explicitlyMain.dataset.imageFilename || '';
                     allPreviewItems.forEach(item => {
                         item.querySelector('.image-uploader-preview').classList.remove('main-image-indicator');
                         const btn = item.querySelector('.set-main-image-btn');
                         if (btn) btn.style.display = 'block';
                     });
                     explicitlyMain.querySelector('.image-uploader-preview').classList.add('main-image-indicator');
                     const mainBtn = explicitlyMain.querySelector('.set-main-image-btn');
                     if (mainBtn) mainBtn.style.display = 'none';
                } else if (allPreviewItems.length > 0 && mainImageFilenameInput && !mainImageFilenameInput.value) {
                    // Если главного нет, но есть изображения, делаем первое главным
                    allPreviewItems[0].querySelector('.image-uploader-preview').classList.add('main-image-indicator');
                    const firstBtn = allPreviewItems[0].querySelector('.set-main-image-btn');
                    if (firstBtn) firstBtn.style.display = 'none';
                    mainImageFilenameInput.value = allPreviewItems[0].dataset.imageFilename || '';
                }
                 updateImageOrderInput();
            }
            
            function updateImageOrderInput() {
                const orderedFilenames = Array.from(imagePreviewsContainer.querySelectorAll('.product-image-item'))
                                           .map(item => item.dataset.imageFilename);
                if (imageOrderInput) imageOrderInput.value = JSON.stringify(orderedFilenames);
            }


            if (imageDropZoneArea && imageUploadInput && imagePreviewsContainer) {
                imageDropZoneArea.addEventListener('click', () => imageUploadInput.click());

                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    imageDropZoneArea.addEventListener(eventName, (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                    }, false);
                });
                imageDropZoneArea.addEventListener('dragenter', () => imageDropZoneArea.classList.add('dragover'));
                imageDropZoneArea.addEventListener('dragover', () => imageDropZoneArea.classList.add('dragover')); // На случай если dragleave сработало случайно
                imageDropZoneArea.addEventListener('dragleave', () => imageDropZoneArea.classList.remove('dragover'));
                imageDropZoneArea.addEventListener('drop', (event) => {
                    imageDropZoneArea.classList.remove('dragover');
                    if (event.dataTransfer.files && event.dataTransfer.files.length > 0) {
                        // Важно: нужно создать новый DataTransfer объект для input'а
                        const dataTransfer = new DataTransfer();
                        Array.from(event.dataTransfer.files).forEach(file => dataTransfer.items.add(file));
                        imageUploadInput.files = dataTransfer.files;
                        handleImageFiles(imageUploadInput.files); // Обрабатываем файлы
                    }
                });

                imageUploadInput.addEventListener('change', (event) => {
                    if (event.target.files && event.target.files.length > 0) {
                        handleImageFiles(event.target.files);
                    }
                });

                imagePreviewsContainer.addEventListener('click', (event) => {
                    const removeBtn = event.target.closest('.remove-image-btn');
                    const setMainBtn = event.target.closest('.set-main-image-btn');

                    if (removeBtn) {
                        const imageItemWrapper = removeBtn.closest('.product-image-item');
                        const imageId = imageItemWrapper.dataset.imageId;
                        if (imageId) { // Если это существующее изображение (из БД)
                            // Добавляем input для отправки ID удаляемого изображения на сервер
                            const hiddenInput = document.createElement('input');
                            hiddenInput.type = 'hidden';
                            hiddenInput.name = 'deleted_image_ids[]';
                            hiddenInput.value = imageId;
                            document.getElementById('product-form').appendChild(hiddenInput);
                        }
                        imageItemWrapper.remove();
                        updateMainImageIndicatorAndInput();
                    } else if (setMainBtn) {
                        const imageItemWrapper = setMainBtn.closest('.product-image-item');
                        // Перемещаем элемент в начало контейнера, чтобы он стал первым
                        imagePreviewsContainer.insertBefore(imageItemWrapper, imagePreviewsContainer.firstChild);
                        updateMainImageIndicatorAndInput();
                    }
                });

                // Инициализация SortableJS для перетаскивания изображений
                if (imagePreviewsContainer.children.length > 0) {
                    new Sortable(imagePreviewsContainer, {
                        animation: 150,
                        ghostClass: 'sortable-ghost', // Класс для "призрака" перетаскиваемого элемента
                        onEnd: function (evt) {
                            // После завершения перетаскивания обновляем индикатор главного изображения и порядок
                            updateMainImageIndicatorAndInput();
                        }
                    });
                }
                // Первоначальное обновление индикатора и порядка при загрузке
                updateMainImageIndicatorAndInput();
            }
            
            // --- Логика управления Техническими характеристиками ---
            const specsContainer = document.getElementById('specifications-container');
            const addSpecBtn = document.getElementById('add-spec-btn');

            if (addSpecBtn && specsContainer) {
                addSpecBtn.addEventListener('click', () => {
                    const newSpecRow = document.createElement('div');
                    newSpecRow.className = 'flex items-center space-x-2 spec-row';
                    newSpecRow.innerHTML = `
                        <input type="text" name="spec_name[]" placeholder="Название характеристики" class="form-input flex-1">
                        <input type="text" name="spec_value[]" placeholder="Значение" class="form-input flex-1">
                        <button type="button" class="text-red-500 hover:text-red-700 remove-spec-btn" title="Удалить характеристику">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    `;
                    specsContainer.appendChild(newSpecRow);
                });
            }
            if (specsContainer) {
                specsContainer.addEventListener('click', function (event) {
                    const removeBtn = event.target.closest('.remove-spec-btn');
                    if (removeBtn) {
                        const rowToRemove = removeBtn.closest('.spec-row');
                        // Не удаляем последнюю строку, а очищаем ее поля
                        if (specsContainer.querySelectorAll('.spec-row').length > 1) {
                            rowToRemove.remove();
                        } else {
                            rowToRemove.querySelector('input[name="spec_name[]"]').value = '';
                            rowToRemove.querySelector('input[name="spec_value[]"]').value = '';
                        }
                    }
                });
            }
            
            // --- Логика для модального окна Техкарты ---
            const openTechCardModalBtnEl = document.getElementById('open-techcard-modal-btn'); 
            const techCardModalEl = document.getElementById('techCardModal'); 
            const modalTitleTechCardEl = document.getElementById('modal-title-techcard');
            const modalProductInfoTechCardEl = document.getElementById('modal-product-info-techcard');
            const modalProductIdTechCardInputEl = document.getElementById('modal-product-id-techcard');
            const modalTechCardIdInputEl = document.getElementById('modal-tech-card-id');
            const uploadBlockModalEl = document.getElementById('upload-block-modal'); // Убедитесь, что этот ID есть в HTML
            
            const dropAreaModalEl = document.getElementById('drop-area-modal');
            const fileInputModalEl = document.getElementById('techcard-file-input-modal');
            const fileInfoModalEl = document.getElementById('file-info-modal');
            const loadedFileNameModalEl = document.getElementById('loaded-file-name-modal');
            const loadedFileSizeModalEl = document.getElementById('loaded-file-size-modal');
            const removeFileBtnModalEl = document.getElementById('remove-file-btn-modal');
            
            const parsedComponentsBlockModalEl = document.getElementById('parsed-components-block-modal');
            const parsedComponentsTableBodyModalEl = document.getElementById('parsed-components-table-body-modal');
            const componentsCountModalEl = document.getElementById('components-count-modal');
            const missingPricesWarningModalEl = document.getElementById('missing-prices-warning-modal');
            const missingPricesCountModalEl = document.getElementById('missing-prices-count-modal');
            const totalMaterialCostModalEl = document.getElementById('total-material-cost-modal');
            const editorCommentModalEl = document.getElementById('editor-comment-modal');
            const saveDraftBtnModalEl = document.getElementById('save-draft-techcard-modal-btn');
            const submitForApprovalBtnModalEl = document.getElementById('submit-techcard-for-approval-modal-btn');
            const parserWarningsModalEl = document.getElementById('parser-warnings-modal');


            let currentTechCardFileInModal = null; // Хранит объект File выбранного файла
            let currentProductIdForModal = PRODUCT_ID_MAIN_PAGE; // ID текущего продукта для модального окна
            let currentTechCardIdForModal = null; // ID существующей техкарты, если редактируем

            window.openTechCardModal = function() {
                if (!techCardModalEl) { 
                    console.error("Модальное окно техкарты не найдено в DOM!"); 
                    showNotification("Ошибка: Модальное окно техкарты не найдено.", "error");
                    return; 
                }
                if (!PRODUCT_ID_MAIN_PAGE) {
                    showNotification("Сначала сохраните товар, чтобы добавить или управлять техкартой.", "warning");
                    return;
                }
                
                currentProductIdForModal = PRODUCT_ID_MAIN_PAGE;
                if(modalProductIdTechCardInputEl) modalProductIdTechCardInputEl.value = currentProductIdForModal;
                
                // Пытаемся получить данные об активной техкарте (если она есть на странице)
                // Это упрощенный вариант, в идеале эти данные должны приходить с сервера или быть в JS-объекте
                let existingTcId = null;
                let existingTcData = null;
                {% if active_tech_card and active_tech_card.id %}
                    existingTcId = {{ active_tech_card.id }};
                    existingTcData = {
                        fileName: "{{ active_tech_card.file_url.split('/')[-1] if active_tech_card and active_tech_card.file_url else '' }}",
                        // Компоненты лучше загружать AJAX-ом при открытии, если их много,
                        // или если мы хотим всегда актуальные данные.
                        // Пока что, если есть активная карта, модал откроется для "редактирования",
                        // что означает загрузку нового файла или изменение статуса/комментария.
                        // Предпросмотр компонентов будет работать при выборе нового файла.
                        totalCost: {{ active_tech_card.total_cost if active_tech_card and active_tech_card.total_cost is not none else 'null' }},
                        editorComment: "{{ active_tech_card.description|e if active_tech_card and active_tech_card.description else '' }}"
                        // Статус и другие поля активной техкарты уже отображаются на основной странице.
                    };
                {% endif %}
                
                currentTechCardIdForModal = existingTcId; 
                if(modalTechCardIdInputEl) modalTechCardIdInputEl.value = existingTcId || '';

                if(modalProductInfoTechCardEl) modalProductInfoTechCardEl.innerHTML = `Товар: <strong class="font-medium">${PRODUCT_NAME_MAIN_PAGE}</strong> (Артикул: <strong class="font-medium">${PRODUCT_SKU_MAIN_PAGE}</strong>)`;

                // Сброс состояния модального окна
                currentTechCardFileInModal = null;
                if(fileInputModalEl) fileInputModalEl.value = ''; 
                if(fileInfoModalEl) fileInfoModalEl.classList.add('hidden');
                if(parsedComponentsBlockModalEl) parsedComponentsBlockModalEl.classList.add('hidden');
                if(editorCommentModalEl) editorCommentModalEl.value = existingTcData ? (existingTcData.editorComment || '') : '';
                if(dropAreaModalEl) dropAreaModalEl.classList.remove('border-red-500'); // Сброс индикации ошибки dropzone
                if(parserWarningsModalEl) parserWarningsModalEl.innerHTML = '';


                if (!existingTcId) { // Если нет существующей активной техкарты, это всегда загрузка новой
                    if(modalTitleTechCardEl) modalTitleTechCardEl.textContent = `Загрузка новой техкарты для: ${PRODUCT_NAME_MAIN_PAGE}`;
                    if(uploadBlockModalEl) uploadBlockModalEl.classList.remove('hidden'); 
                    if(saveDraftBtnModalEl) saveDraftBtnModalEl.disabled = true; // Кнопки активны только после выбора файла
                    if(submitForApprovalBtnModalEl) submitForApprovalBtnModalEl.disabled = true;
                } else { // Если есть существующая активная техкарта
                    if(modalTitleTechCardEl) modalTitleTechCardEl.textContent = `Обновление техкарты для: ${PRODUCT_NAME_MAIN_PAGE}`;
                    if (existingTcData && existingTcData.fileName) { 
                        // Показываем информацию о текущем файле, если он есть
                        currentTechCardFileInModal = { name: existingTcData.fileName, isExisting: true }; 
                        if(loadedFileNameModalEl) loadedFileNameModalEl.textContent = existingTcData.fileName;
                        if(loadedFileSizeModalEl) loadedFileSizeModalEl.textContent = ''; // Размер для существующего файла не так важен
                        if(fileInfoModalEl) fileInfoModalEl.classList.remove('hidden');
                        if(uploadBlockModalEl) uploadBlockModalEl.classList.remove('hidden'); 
                        // Кнопки сохранения статуса/комментария должны быть активны, даже если файл не меняется
                        if(saveDraftBtnModalEl) saveDraftBtnModalEl.disabled = false;
                        if(submitForApprovalBtnModalEl) submitForApprovalBtnModalEl.disabled = false;
                    } else { 
                        // Если есть ID техкарты, но нет файла (маловероятно, но возможно)
                         if(uploadBlockModalEl) uploadBlockModalEl.classList.remove('hidden');
                         if(saveDraftBtnModalEl) saveDraftBtnModalEl.disabled = true;
                         if(submitForApprovalBtnModalEl) submitForApprovalBtnModalEl.disabled = true;
                    }
                }
                techCardModalEl.classList.remove('hidden');
            }

            window.closeTechCardModal = function() {
                if (techCardModalEl) techCardModalEl.classList.add('hidden');
            }
            
            if(openTechCardModalBtnEl && !openTechCardModalBtnEl.disabled) { 
                openTechCardModalBtnEl.addEventListener('click', openTechCardModal);
            }


            function handleFileSelectInModal(files) {
                if (files.length === 0) return;
                const file = files[0];
                if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                    showNotification("Пожалуйста, выберите файл в формате XLSX или XLS.", "warning");
                    if(fileInputModalEl) fileInputModalEl.value = ''; // Сбрасываем input
                    if(dropAreaModalEl) dropAreaModalEl.classList.add('border-red-500');
                    return;
                }
                if(dropAreaModalEl) dropAreaModalEl.classList.remove('border-red-500');

                if (file.size > 10 * 1024 * 1024) { // 10MB limit
                    showNotification("Файл слишком большой. Максимальный размер 10МБ.", "warning");
                    if(fileInputModalEl) fileInputModalEl.value = '';
                    return;
                }
                currentTechCardFileInModal = file; // Сохраняем объект File
                if(loadedFileNameModalEl) loadedFileNameModalEl.textContent = file.name;
                if(loadedFileSizeModalEl) loadedFileSizeModalEl.textContent = `${(file.size / 1024).toFixed(2)} KB`;
                if(fileInfoModalEl) fileInfoModalEl.classList.remove('hidden');
                if(parserWarningsModalEl) parserWarningsModalEl.innerHTML = ''; // Очищаем старые предупреждения парсера
                
                const formData = new FormData();
                formData.append('tech_card_excel_file_for_preview', file); 
                // currentProductIdForModal должен быть установлен при открытии модала
                if (currentProductIdForModal) { 
                    formData.append('product_id', currentProductIdForModal);
                } else {
                    showNotification("ID продукта не определен. Невозможно выполнить предпросмотр.", "error");
                    return;
                }
                
                let previewUrl = PREVIEW_TECHCARD_URL_TEMPLATE.replace('<product_id_placeholder>', currentProductIdForModal);

                fetch(previewUrl, { 
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': '{{ csrf_token() if csrf_token else "" }}' } // Если используете CSRF
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayParsedComponentsInModal(data.components, data.total_calculated_cost);
                        if(parsedComponentsBlockModalEl) parsedComponentsBlockModalEl.classList.remove('hidden');
                        if(saveDraftBtnModalEl) saveDraftBtnModalEl.disabled = false;
                        if(submitForApprovalBtnModalEl) submitForApprovalBtnModalEl.disabled = false;
                        if (data.warnings && data.warnings.length > 0 && parserWarningsModalEl) {
                            parserWarningsModalEl.innerHTML = '<strong>Предупреждения парсера:</strong><ul>' + 
                                data.warnings.map(w => `<li>${w}</li>`).join('') + '</ul>';
                        }
                    } else {
                        showNotification('Ошибка предпросмотра: ' + (data.message || 'Не удалось обработать файл.'), 'error');
                        if(removeFileBtnModalEl) removeFileBtnModalEl.click(); // Сбрасываем файл
                    }
                })
                .catch(error => {
                    console.error('Ошибка AJAX при предпросмотре техкарты:', error);
                    showNotification('Сетевая ошибка или ошибка сервера при предпросмотре техкарты.', 'error');
                    if(removeFileBtnModalEl) removeFileBtnModalEl.click();
                });
            }

            function displayParsedComponentsInModal(components, totalCalculatedCost = null) {
                if (!parsedComponentsTableBodyModalEl) return;
                parsedComponentsTableBodyModalEl.innerHTML = ''; // Очищаем старые компоненты
                let missingPriceCount = 0;

                if (!components || components.length === 0) {
                    parsedComponentsTableBodyModalEl.innerHTML = '<tr><td colspan="7" class="text-center py-4">Компоненты не найдены в файле или не были распознаны.</td></tr>';
                    if(componentsCountModalEl) componentsCountModalEl.textContent = 0;
                    if(totalMaterialCostModalEl) totalMaterialCostModalEl.textContent = formatCurrency(0);
                    if(missingPricesWarningModalEl) missingPricesWarningModalEl.classList.add('hidden');
                    return;
                }

                components.forEach((comp, index) => {
                    const row = parsedComponentsTableBodyModalEl.insertRow();
                    row.insertCell().textContent = comp.num || (index + 1);
                    row.insertCell().textContent = comp.articleFromFile || '-';
                    row.insertCell().textContent = comp.nameFromFile || '-';
                    row.insertCell().textContent = parseFloat(comp.quantity).toFixed(3); 
                    row.insertCell().textContent = comp.unitFromFile || '-';

                    let priceCellContent = '<span class="text-gray-400">N/A</span>';
                    let costCellContent = '<span class="text-gray-400">N/A</span>';
                    
                    // Логика отображения цен и статуса компонента (найден в БД, новый, и т.д.)
                    if (comp.foundInDB) {
                        row.classList.remove('modal-component-new');
                        if (comp.rawMaterialPriceDB !== null && comp.rawMaterialPriceDB > 0) {
                            priceCellContent = formatCurrency(comp.rawMaterialPriceDB);
                            costCellContent = formatCurrency(comp.componentCost);
                        } else {
                            priceCellContent = `<span class="text-orange-600 font-semibold">${comp.rawMaterialPriceDB === 0 ? 'Цена 0!' : 'Цена?'}</span>`;
                            costCellContent = formatCurrency(0); // Если цена 0, стоимость 0
                            missingPriceCount++;
                            row.classList.add('modal-component-not-found'); 
                        }
                    } else { // Новый компонент (isNew = true)
                        row.classList.add('modal-component-new');
                        if (comp.rawMaterialPriceDB !== null && comp.rawMaterialPriceDB > 0) { // Цена из Excel для нового
                             priceCellContent = `${formatCurrency(comp.rawMaterialPriceDB)} (новая)`;
                             costCellContent = formatCurrency(comp.componentCost); // Стоимость по цене из Excel
                        } else {
                             priceCellContent = `<span class="text-orange-600 font-semibold">Цена? (новая)</span>`;
                             costCellContent = formatCurrency(0);
                             missingPriceCount++;
                        }
                    }
                    
                    row.insertCell().innerHTML = priceCellContent;
                    row.insertCell().innerHTML = costCellContent;
                });

                if(componentsCountModalEl) componentsCountModalEl.textContent = components.length;
                if(totalMaterialCostModalEl) totalMaterialCostModalEl.textContent = formatCurrency(totalCalculatedCost !== null ? totalCalculatedCost : 0);
                
                if (missingPriceCount > 0) {
                    if(missingPricesCountModalEl) missingPricesCountModalEl.textContent = missingPriceCount;
                    if(missingPricesWarningModalEl) missingPricesWarningModalEl.classList.remove('hidden');
                } else {
                    if(missingPricesWarningModalEl) missingPricesWarningModalEl.classList.add('hidden');
                }
            }

            // Drag & Drop для файла техкарты в модальном окне
            if (dropAreaModalEl) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropAreaModalEl.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
                });
                dropAreaModalEl.addEventListener('dragenter', () => dropAreaModalEl.classList.add('dragover'));
                dropAreaModalEl.addEventListener('dragover', () => dropAreaModalEl.classList.add('dragover'));
                dropAreaModalEl.addEventListener('dragleave', () => dropAreaModalEl.classList.remove('dragover'));
                dropAreaModalEl.addEventListener('drop', (e) => {
                    dropAreaModalEl.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files && files.length > 0) {
                        if(fileInputModalEl) fileInputModalEl.files = files; // Присваиваем файлы стандартному input
                        handleFileSelectInModal(files); 
                    }
                }, false);
            }

            if (fileInputModalEl) {
                fileInputModalEl.addEventListener('change', function () { handleFileSelectInModal(this.files); });
            }

            if (removeFileBtnModalEl) {
                removeFileBtnModalEl.addEventListener('click', () => {
                    currentTechCardFileInModal = null;
                    if(fileInputModalEl) fileInputModalEl.value = ''; // Сбрасываем input
                    if(fileInfoModalEl) fileInfoModalEl.classList.add('hidden');
                    if(parsedComponentsBlockModalEl) parsedComponentsBlockModalEl.classList.add('hidden');
                    if(parserWarningsModalEl) parserWarningsModalEl.innerHTML = '';
                    // Если не было существующей техкарты, дизейблим кнопки
                    if (!currentTechCardIdForModal) {
                        if(saveDraftBtnModalEl) saveDraftBtnModalEl.disabled = true;
                        if(submitForApprovalBtnModalEl) submitForApprovalBtnModalEl.disabled = true;
                    }
                    // Если была существующая, кнопки остаются активными для смены статуса/комментария
                    if(dropAreaModalEl) dropAreaModalEl.classList.remove('border-red-500');
                });
            }
            
            // Отправка данных техкарты из модального окна
            function submitTechCardFromModal(status) {
                // Если нет нового файла И нет существующей техкарты для обновления статуса, то ошибка
                if (!currentTechCardFileInModal && !currentTechCardIdForModal) { 
                     showNotification('Загрузите файл техкарты или выберите существующую для изменения статуса.', 'warning'); return;
                }
                // currentProductIdForModal должен быть установлен
                if (!currentProductIdForModal) {
                    showNotification('ID товара не определен. Сохраните товар перед добавлением техкарты.', 'error'); return;
                }

                const formData = new FormData();
                // Добавляем файл, только если он новый (не isExisting)
                if (currentTechCardFileInModal && !currentTechCardFileInModal.isExisting) { 
                    formData.append('tech_card_excel_file_modal', currentTechCardFileInModal);
                }
                formData.append('product_id', currentProductIdForModal);
                if (currentTechCardIdForModal) { // Если редактируем существующую (даже если файл новый, ID старой нужен для логики обновления)
                    formData.append('tech_card_id', currentTechCardIdForModal);
                }
                formData.append('comment', editorCommentModalEl.value);
                formData.append('status', status); 

                fetch(PROCESS_TECHCARD_MODAL_URL, { 
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': '{{ csrf_token() if csrf_token else "" }}' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(data.message || 'Техкарта успешно обработана!', 'success');
                        closeTechCardModal();
                        
                        // Обновляем информацию на основной странице
                        if (costPriceInput && data.new_cost_price !== undefined) {
                            costPriceInput.value = parseFloat(data.new_cost_price).toFixed(2);
                        }
                        if (costPriceSourceEl && data.cost_price_source) {
                            costPriceSourceEl.textContent = data.cost_price_source;
                        }
                        if (typeof calculateAllPrices === 'function') { // Пересчитываем все цены
                            calculateAllPrices(); 
                        }
                        
                        const summaryDiv = document.getElementById('active-tech-card-summary');
                        if(summaryDiv && data.tech_card_info_html) {
                            summaryDiv.innerHTML = data.tech_card_info_html;
                            // Обновляем состояние кнопки "Авто (ТК)"
                            if (fetchCostBtn) {
                                const newTcStatus = data.tech_card_status; // Статус новой активной карты
                                const newTcCost = data.new_cost_price;
                                fetchCostBtn.disabled = !(newTcStatus === TECH_CARD_STATUS_APPROVED_JS || newTcStatus === TECH_CARD_STATUS_PROCESSED_JS);
                                // Обновляем глобальные переменные для кнопки "Авто (ТК)"
                                window.TECH_CARD_COST_FROM_SERVER_MAIN_PAGE = parseFloat(newTcCost || '0');
                                window.TECH_CARD_STATUS_FROM_SERVER_MAIN_PAGE = newTcStatus || 'Нет данных';
                                // LATEST_TECH_CARD_UPDATED_AT_MAIN_PAGE тоже нужно бы обновить, если приходит с сервера
                            }
                        } else { 
                             // Если нет блока для обновления или HTML не пришел, можно перезагрузить страницу
                             // window.location.reload(); 
                             // Но лучше, чтобы сервер всегда возвращал HTML для обновления
                             showNotification("Информация о техкарте на странице может быть неактуальна. Обновите страницу.", "info");
                        }
                        // Обновляем текст кнопки открытия модала
                         if (openTechCardModalBtnEl && data.tech_card_id) {
                            openTechCardModalBtnEl.innerHTML = 'Редактировать/Загрузить новую';
                        }

                    } else {
                        showNotification('Ошибка обработки техкарты: ' + (data.message || 'Неизвестная ошибка.'), 'error');
                    }
                })
                .catch(error => {
                    console.error('Ошибка AJAX при обработке техкарты:', error);
                    showNotification('Сетевая ошибка или ошибка сервера при обработке техкарты.', 'error');
                });
            }

            if(saveDraftBtnModalEl) {
                saveDraftBtnModalEl.addEventListener('click', () => {
                    submitTechCardFromModal(TECH_CARD_STATUS_DRAFT_JS);
                });
            }
            if(submitForApprovalBtnModalEl) {
                submitForApprovalBtnModalEl.addEventListener('click', () => {
                    // Проверка на отсутствующие цены перед отправкой на согласование
                    if (missingPricesWarningModalEl && !missingPricesWarningModalEl.classList.contains('hidden')) {
                        if (!confirm("Внимание! Для некоторых компонентов не найдены цены в справочнике или равны нулю. Себестоимость может быть неточной. Всё равно отправить на согласование?")) {
                            return;
                        }
                    }
                    submitTechCardFromModal(TECH_CARD_STATUS_PENDING_ACCOUNTANT_JS); // Или другой статус по умолчанию для согласования
                });
            }
            
            // --- Обработка отправки основной формы товара ---
            const productForm = document.getElementById('product-form');
            if (productForm) { 
                productForm.addEventListener('submit', function (event) {
                    // 1. Сохраняем содержимое Quill
                    if (quill && document.getElementById('product-full-description')) { 
                        document.getElementById('product-full-description').value = JSON.stringify(quill.getContents()); 
                    }

                    // 2. Собираем данные о характеристиках
                    const specNames = Array.from(document.querySelectorAll('input[name="spec_name[]"]')).map(input => input.value.trim());
                    const specValues = Array.from(document.querySelectorAll('input[name="spec_value[]"]')).map(input => input.value.trim());
                    const specificationsObject = {};
                    specNames.forEach((name, index) => {
                        if (name && specValues[index]) { // Сохраняем только если есть и имя, и значение
                            specificationsObject[name] = specValues[index];
                        }
                    });
                    // Добавляем скрытое поле с JSON характеристик
                    let specsJsonInput = document.querySelector('input[name="specifications_json"]');
                    if (!specsJsonInput) {
                        specsJsonInput = document.createElement('input');
                        specsJsonInput.type = 'hidden';
                        specsJsonInput.name = 'specifications_json';
                        productForm.appendChild(specsJsonInput);
                    }
                    specsJsonInput.value = JSON.stringify(specificationsObject);

                    // 3. Собираем порядок изображений (уже делается в updateImageOrderInput)
                    // Убедимся, что imageOrderInput существует и содержит актуальные данные
                    if (!imageOrderInput.value && imagePreviewsContainer.children.length > 0) {
                        updateImageOrderInput(); // На всякий случай
                    }
                }); 
            }
        
        }); // Конец DOMContentLoaded

        // --- Вспомогательные функции JS (глобальные в этом скрипте) ---
        function formatCurrency(amount) {
            if (amount === null || typeof amount === 'undefined' || isNaN(amount)) return "0.00 сом";
            // Используем toLocaleString для форматирования с пробелами и запятой, затем заменяем на точку для единообразия
            let formatted = parseFloat(amount).toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            return formatted.replace(',', '.') + " сом"; // Убедимся, что разделитель - точка
        }

        function showNotification(message, type = 'info', duration = 3500) {
            if (!notificationContainerEl) {
                console.warn("Контейнер уведомлений #notification-container не найден.");
                alert(message); // Фоллбэк на alert
                return;
            }

            const notif = document.createElement('div');
            notif.className = `notification-item max-w-xs px-4 py-3 rounded-lg shadow-xl text-white text-sm font-medium transition-all duration-300 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                type === 'warning' ? 'bg-yellow-500' : 'bg-sky-500' // Добавлен тип warning
            }`;
            notif.innerHTML = `
                <i class="fas ${
                    type === 'success' ? 'fa-check-circle' : 
                    type === 'error' ? 'fa-exclamation-triangle' : 
                    type === 'warning' ? 'fa-exclamation-circle' : 'fa-info-circle'
                } mr-2"></i><span>${message}</span>
            `;
            notificationContainerEl.appendChild(notif);
            
            setTimeout(() => {
                notif.classList.add('fade-out');
                setTimeout(() => notif.remove(), 300); // Время на анимацию исчезновения
            }, duration);
        }

    </script>
</body>
</html>

--- Файл: admin_product_edit_marketer.txt ---

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Редактирование Товара (Маркетинг) - МебельПрайсПро Админ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* gray-100 */
        }
        .admin-sidebar {
            transition: width 0.3s ease-in-out;
        }
        .admin-content {
            transition: margin-left 0.3s ease-in-out;
        }
        .form-input, .form-select, .form-textarea {
            @apply px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm;
        }
        .form-label {
            @apply block text-sm font-medium text-gray-700 mb-1;
        }
        .btn { @apply font-medium py-2 px-4 rounded-md shadow-sm transition-colors duration-150; }
        .btn-primary { @apply bg-sky-600 hover:bg-sky-700 text-white; }
        .btn-secondary { @apply bg-gray-200 hover:bg-gray-300 text-gray-700; }
        .btn-success { @apply bg-green-600 hover:bg-green-700 text-white; }
        .nav-item-count { @apply ml-auto text-xs bg-sky-500 text-white rounded-full px-1.5 py-0.5; }
        
        .image-uploader-preview {
            @apply w-24 h-24 border border-gray-300 rounded-md object-cover cursor-pointer hover:opacity-75;
        }
        .image-uploader-add {
            @apply w-24 h-24 border-2 border-dashed border-gray-300 rounded-md flex items-center justify-center text-gray-400 hover:border-sky-500 hover:text-sky-500 cursor-pointer;
        }
    </style>
</head>
<body class="flex h-screen">

    <aside id="admin-sidebar" class="admin-sidebar w-64 bg-gray-800 text-gray-100 flex flex-col transition-all duration-300 ease-in-out">
        <div class="px-6 py-4 border-b border-gray-700">
            <a href="admin_dashboard.html" class="text-2xl font-semibold text-white">Мебель<span class="text-orange-400">Прайс</span>Админ</a>
        </div>
        <nav class="flex-grow px-3 py-4 space-y-1.5">
            <a href="admin_dashboard.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                Дашборд
            </a>
            <a href="admin_products.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md bg-gray-900 text-sky-400"> <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                Товары
            </a>
            <a href="admin_techcard_list.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.153 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM10.5 16.5h3.75m-3.75 0h3.75" /></svg>
                Техкарты (Редактор)
            </a>
            <a href="admin_approval_tasks.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                 <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                Согласование Техкарт <span class="nav-item-count" id="nav-approval-count-sidebar">3</span>
            </a>
            <a href="admin_raw_materials.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10.5 11.25h3M12 15h.008m-7.008 0h14.016m0 0A48.108 48.108 0 0012 15c-2.282 0-4.441.68-6.267 1.875M7.5 7.5h9M3.75 7.5A2.25 2.25 0 016 5.25h12a2.25 2.25 0 012.25 2.25m0 0A2.25 2.25 0 0019.5 6c-.023 0-.046.002-.069.004l-.01.002-.008.001-.002.001-.002 0a.002.002 0 01-.002 0l-.002.001-.008.001-.01.002A2.232 2.232 0 0019.5 6c-1.24 0-2.25.985-2.25 2.188V7.5M3.75 7.5c0 .067.003.132.008.196M12 15c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125h0c-.621 0-1.125.504-1.125 1.125v4.5c0 .621.504 1.125 1.125 1.125h0z" /></svg>
                Сырьё и Цены
            </a>
             <a href="admin_dealers_list.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345h5.518a.562.562 0 01.329 1.004l-4.243 2.97a.563.563 0 00-.178.643l2.125 5.111a.563.563 0 01-.83.632l-4.243-2.97a.563.563 0 00-.652 0l-4.243 2.97a.563.563 0 01-.83-.632l2.125-5.111a.563.563 0 00-.178-.643l-4.243-2.97a.562.562 0 01.329-1.004h5.518a.563.563 0 00.475-.345L11.48 3.5z" />
                </svg>
                Дилеры и Оптовики
            </a>
            <a href="admin_users.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" /></svg>
                Пользователи
            </a>
            <a href="../html/index.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 text-red-400 hover:text-red-300 mt-auto">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" /></svg>
                Выход (на сайт)
            </a>
        </nav>
    </aside>

    <div class="flex-1 flex flex-col overflow-hidden">
        <header class="bg-white shadow-sm">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <button id="sidebar-toggle" class="text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-sky-500 md:hidden">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        </button>
                        <h1 class="text-xl font-semibold text-gray-800 ml-3" id="page-title-marketer">Добавление товара (Маркетинг)</h1>
                    </div>
                     <div class="flex items-center">
                        <span class="text-sm text-gray-600 mr-3">Петрова М. (Маркетолог)</span>
                        <img class="h-8 w-8 rounded-full object-cover" src="https://placehold.co/100x100/fbbf24/78350f?text=M" alt="[Фото пользователя]">
                    </div>
                </div>
            </div>
        </header>
        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
            <div class="container mx-auto">
                <form id="product-form-marketer">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 space-y-6">
                            <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">Основная информация</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="product-name-marketer" class="form-label">Наименование товара <span class="text-red-500">*</span></label>
                                        <input type="text" name="product-name" id="product-name-marketer" class="form-input w-full" required>
                                    </div>
                                    <div>
                                        <label for="product-sku-marketer" class="form-label">Артикул (SKU)</label>
                                        <input type="text" name="product-sku" id="product-sku-marketer" class="form-input w-full bg-gray-100" readonly placeholder="WS-XYZ-001 (авто)">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">Маркетинговые Описания</h3>
                                <div>
                                    <label for="product-short-description-marketer" class="form-label">Краткое описание / Ключевые особенности (каждый пункт с новой строки)</label>
                                    <textarea name="product-short-description" id="product-short-description-marketer" rows="4" class="form-textarea w-full" placeholder="Например:&#10;- Элегантный европейский дизайн&#10;- Премиальные влагостойкие материалы&#10;- Мягкое закрывание ящиков"></textarea>
                                </div>
                                <div class="mt-4">
                                    <label for="product-full-description-marketer" class="form-label">Полное описание для сайта</label>
                                    <div id="quill-editor-placeholder-marketer" class="form-textarea w-full min-h-[200px] p-3 bg-gray-50 text-gray-400 flex items-center justify-center">
                                        [Здесь будет WYSIWYG редактор для полного описания]
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="lg:col-span-1 space-y-6">
                            <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">Организация</h3>
                                <div>
                                    <label for="product-category-marketer" class="form-label">Категория товара</label>
                                    <input type="text" id="product-category-marketer" class="form-input w-full bg-gray-100" value="Тумбы с раковиной" readonly>
                                </div>
                                <div class="mt-4">
                                    <label for="product-publish-status-marketer" class="form-label">Статус публикации</label>
                                     <input type="text" id="product-publish-status-marketer" class="form-input w-full bg-gray-100" value="Опубликован" readonly>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">Изображения товара</h3>
                                <div id="image-previews-marketer" class="grid grid-cols-3 gap-3 mb-3">
                                    <div class="relative group">
                                        <img src="https://placehold.co/100x100/e0f2fe/0c4a6e?text=Фото1" alt="Предпросмотр" class="image-uploader-preview">
                                        <button class="absolute top-1 right-1 bg-red-500 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity text-xs" title="Удалить">?</button>
                                    </div>
                                    <div class="relative group">
                                        <img src="https://placehold.co/100x100/c7d2fe/3730a3?text=Фото2" alt="Предпросмотр" class="image-uploader-preview">
                                         <button class="absolute top-1 right-1 bg-red-500 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity text-xs" title="Удалить">?</button>
                                    </div>
                                    <div class="image-uploader-add" id="add-image-button-marketer">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                                    </div>
                                </div>
                                <input type="file" id="image-upload-input-marketer" multiple accept="image/*" class="hidden">
                                <p class="text-xs text-gray-500">Первое изображение будет главным. Можно перетаскивать для изменения порядка. Рекомендуемый размер: 800x800px.</p>
                            </div>

                            <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">SEO-Настройки</h3>
                                <div>
                                    <label for="seo-title-marketer" class="form-label">SEO Title</label>
                                    <input type="text" name="seo-title" id="seo-title-marketer" class="form-input w-full">
                                </div>
                                <div class="mt-4">
                                    <label for="seo-description-marketer" class="form-label">Meta Description</label>
                                    <textarea name="seo-description" id="seo-description-marketer" rows="3" class="form-textarea w-full"></textarea>
                                </div>
                                <div class="mt-4">
                                    <label for="seo-keywords-marketer" class="form-label">Meta Keywords (через запятую)</label>
                                    <input type="text" name="seo-keywords" id="seo-keywords-marketer" class="form-input w-full">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 pt-6 border-t border-gray-300 flex justify-end space-x-3">
                        <a href="admin_products.html" class="btn btn-secondary">Отмена</a>
                        <button type="submit" class="btn btn-success">Сохранить изменения</button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const sidebar = document.getElementById('admin-sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');

            if (sidebarToggle && sidebar) {
                sidebarToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('w-64');
                    sidebar.classList.toggle('w-16');
                });
            }

            const approvalCountBadge = document.getElementById('nav-approval-count-sidebar');
            if (approvalCountBadge) {
                approvalCountBadge.textContent = '3';
            }

            const pageTitle = document.getElementById('page-title-marketer');
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');

            if (productId) {
                pageTitle.textContent = `Редактирование товара (Маркетинг): ID ${productId}`;
                document.getElementById('product-name-marketer').value = "Тумба 'Modern' 75см, антрацит (Маркетинг)";
                document.getElementById('product-sku-marketer').value = "WS-MOD75-ANT";
                document.getElementById('product-category-marketer').value = "Тумбы с раковиной";
                document.getElementById('product-publish-status-marketer').value = "Опубликован";
                document.getElementById('product-short-description-marketer').value = "- Изящные линии\n- Фасады МДФ в пленке\n- Доводчики плавного закрывания";
                document.getElementById('seo-title-marketer').value = "Купить Тумба Modern 75см антрацит в Бишкеке | МебельПрайсПро";
                document.getElementById('seo-description-marketer').value = "Стильная тумба Modern 75см в цвете антрацит для ванной комнаты. Высокое качество, современный дизайн. Доставка по Кыргызстану.";
                document.getElementById('seo-keywords-marketer').value = "тумба для ванной, modern, антрацит, 75см, купить, бишкек, мебель для ванной";

            } else {
                pageTitle.textContent = 'Добавление нового товара (Маркетинг)';
            }

            const addImageButton = document.getElementById('add-image-button-marketer');
            const imageUploadInput = document.getElementById('image-upload-input-marketer');
            const imagePreviewsContainer = document.getElementById('image-previews-marketer');

            if (addImageButton && imageUploadInput && imagePreviewsContainer) {
                addImageButton.addEventListener('click', () => imageUploadInput.click());
                imageUploadInput.addEventListener('change', function (event) {
                    const files = event.target.files;
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = function (e) {
                                const imgContainer = document.createElement('div');
                                imgContainer.className = 'relative group';
                                const img = document.createElement('img');
                                img.src = e.target.result;
                                img.alt = "Предпросмотр";
                                img.className = 'image-uploader-preview';

                                const removeBtn = document.createElement('button');
                                removeBtn.className = 'absolute top-1 right-1 bg-red-500 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity text-xs';
                                removeBtn.title = "Удалить";
                                removeBtn.innerHTML = '?';
                                removeBtn.type = 'button';
                                removeBtn.onclick = function () { imgContainer.remove(); };

                                imgContainer.appendChild(img);
                                imgContainer.appendChild(removeBtn);
                                imagePreviewsContainer.insertBefore(imgContainer, addImageButton);
                            }
                            reader.readAsDataURL(file);
                        }
                    }
                });
                imagePreviewsContainer.querySelectorAll('.group button').forEach(button => {
                    button.onclick = function () { button.parentElement.remove(); };
                });
            }

            const productFormMarketer = document.getElementById('product-form-marketer');
            if (productFormMarketer) {
                productFormMarketer.addEventListener('submit', function (event) {
                    event.preventDefault();
                    const formData = new FormData(this);
                    const productData = {};
                    for (let [key, value] of formData.entries()) {
                        productData[key] = value;
                    }
                    console.log("Маркетинговые данные товара для сохранения:", productData);
                    alert(`Маркетинговые данные для товара "${productData['product-name'] || 'Новый товар'}" сохранены (имитация)!`);
                });
            }
        });
    </script>
</body>
</html>

--- Файл: admin_raw_materials.txt ---

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сырьё и Закупочные Цены - МебельПрайсПро Админ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* gray-100 */
        }
        .admin-sidebar {
            transition: width 0.3s ease-in-out;
        }
        .admin-content {
            transition: margin-left 0.3s ease-in-out;
        }
        .form-input, .form-select, .form-textarea {
            @apply px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm;
        }
        .form-label {
            @apply block text-sm font-medium text-gray-700 mb-1;
        }
        .table th.sortable-header { 
            @apply cursor-pointer hover:bg-gray-100 relative; 
        }
        .table th .sort-icon-container { 
            @apply inline-flex items-center justify-center ml-1.5 align-middle;
            width: 1em; 
            height: 1em;
        }
        .table th svg.sort-icon {
            @apply h-full w-full;
        }
        .table th svg.sort-icon.neutral { @apply text-gray-400; }
        .table th svg.sort-icon.asc, .table th svg.sort-icon.desc { @apply text-sky-600; }
        
        .table td { @apply px-4 py-3 whitespace-nowrap text-sm text-gray-700; }
        .table tbody tr:nth-child(even) { @apply bg-gray-50; }
        .btn { @apply font-medium py-2 px-4 rounded-md shadow-sm transition-colors duration-150; }
        .btn-primary { @apply bg-sky-600 hover:bg-sky-700 text-white; }
        .btn-secondary { @apply bg-gray-200 hover:bg-gray-300 text-gray-700; }
        .btn-success { @apply bg-green-500 hover:bg-green-600 text-white; }
        .btn-danger { @apply bg-red-500 hover:bg-red-600 text-white; }
        .btn-warning { @apply bg-yellow-500 hover:bg-yellow-600 text-white; }
        .btn-icon { @apply p-1.5; }
        .nav-item-count { @apply ml-auto text-xs bg-sky-500 text-white rounded-full px-1.5 py-0.5; }
    </style>
</head>
<body class="flex h-screen">

    <aside id="admin-sidebar" class="admin-sidebar w-64 bg-gray-800 text-gray-100 flex flex-col transition-all duration-300 ease-in-out">
        <div class="px-6 py-4 border-b border-gray-700">
            <a href="admin_dashboard.html" class="text-2xl font-semibold text-white">Мебель<span class="text-orange-400">Прайс</span>Админ</a>
        </div>
        <nav class="flex-grow px-3 py-4 space-y-1.5">
            <a href="admin_dashboard.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                Дашборд
            </a>
            <a href="admin_products.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                 <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                Товары
            </a>
            <a href="admin_techcard_list.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.153 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM10.5 16.5h3.75m-3.75 0h3.75" /></svg>
                Техкарты (Редактор)
            </a>
            <a href="admin_approval_tasks.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                 <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                Согласование Техкарт <span class="nav-item-count" id="nav-approval-count-sidebar">3</span>
            </a>
            <a href="admin_raw_materials.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md bg-gray-900 text-sky-400"> <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10.5 11.25h3M12 15h.008m-7.008 0h14.016m0 0A48.108 48.108 0 0012 15c-2.282 0-4.441.68-6.267 1.875M7.5 7.5h9M3.75 7.5A2.25 2.25 0 016 5.25h12a2.25 2.25 0 012.25 2.25m0 0A2.25 2.25 0 0019.5 6c-.023 0-.046.002-.069.004l-.01.002-.008.001-.002.001-.002 0a.002.002 0 01-.002 0l-.002.001-.008.001-.01.002A2.232 2.232 0 0019.5 6c-1.24 0-2.25.985-2.25 2.188V7.5M3.75 7.5c0 .067.003.132.008.196M12 15c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125h0c-.621 0-1.125.504-1.125 1.125v4.5c0 .621.504 1.125 1.125 1.125h0z" /></svg>
                Сырьё и Цены
            </a>
             <a href="admin_dealers_list.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345h5.518a.562.562 0 01.329 1.004l-4.243 2.97a.563.563 0 00-.178.643l2.125 5.111a.563.563 0 01-.83.632l-4.243-2.97a.563.563 0 00-.652 0l-4.243 2.97a.563.563 0 01-.83-.632l2.125-5.111a.563.563 0 00-.178-.643l-4.243-2.97a.562.562 0 01.329-1.004h5.518a.563.563 0 00.475-.345L11.48 3.5z" />
                </svg>
                Дилеры и Оптовики
            </a>
            <a href="admin_users.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" /></svg>
                Пользователи
            </a>
            <a href="../html/index.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 text-red-400 hover:text-red-300 mt-auto">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" /></svg>
                Выход (на сайт)
            </a>
        </nav>
    </aside>

    <div class="flex-1 flex flex-col overflow-hidden">
        <header class="bg-white shadow-sm">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <button id="sidebar-toggle" class="text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-sky-500 md:hidden">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        </button>
                        <h1 class="text-xl font-semibold text-gray-800 ml-3">Сырьё и Закупочные Цены</h1>
                    </div>
                    <div class="flex items-center">
                        <span class="text-sm text-gray-600 mr-3">Администратор</span>
                        <img class="h-8 w-8 rounded-full object-cover" src="https://placehold.co/100x100/7dd3fc/0c4a6e?text=A" alt="[Фото пользователя]">
                    </div>
                </div>
            </div>
        </header>
        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
            <div class="container mx-auto">
                <div class="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                    <h2 class="text-2xl font-semibold text-gray-800">Справочник Сырья (<span id="total-materials-count">78</span>)</h2>
                    <button id="add-new-material-btn" class="btn btn-success">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline -ml-1 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                        Добавить новый материал
                    </button>
                </div>
                
                <div class="bg-white p-4 rounded-md shadow mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="filter-material-search" class="form-label">Поиск по сырью:</label>
                            <input type="text" id="filter-material-search" placeholder="Артикул, название..." class="form-input w-full">
                        </div>
                        <div>
                            <label for="filter-material-supplier" class="form-label">Поставщик:</label>
                            <select id="filter-material-supplier" class="form-select w-full">
                                <option value="">Все поставщики</option>
                                <option value="supplier1">Поставщик А</option>
                                <option value="supplier2">Поставщик Б</option>
                                </select>
                        </div>
                        <div class="flex space-x-2 items-end">
                            <button class="btn btn-primary w-full sm:w-auto">Применить</button>
                            <button class="btn btn-secondary w-full sm:w-auto">Сбросить</button>
                        </div>
                    </div>
                </div>

                <div class="bg-white shadow-md rounded-lg overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 table" id="materials-table">
                        <thead>
                            <tr>
                                <th class="sortable-header" data-sort-by="id">ID <span class="sort-icon-container"></span></th>
                                <th class="sortable-header" data-sort-by="sku">Артикул <span class="sort-icon-container"></span></th>
                                <th class="sortable-header" data-sort-by="name">Наименование материала <span class="sort-icon-container"></span></th>
                                <th class="sortable-header" data-sort-by="unit">Ед. изм. <span class="sort-icon-container"></span></th>
                                <th class="sortable-header" data-sort-by="price">Закуп. цена (сом) <span class="sort-icon-container"></span></th>
                                <th class="sortable-header" data-sort-by="supplier">Поставщик <span class="sort-icon-container"></span></th>
                                <th class="sortable-header" data-sort-by="last_update">Дата изм. цены <span class="sort-icon-container"></span></th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td>1</td>
                                <td>ЛДСП-Б-16</td>
                                <td>ЛДСП Белый гладкий 16мм</td>
                                <td>кв.м</td>
                                <td class="text-right">350.00</td>
                                <td>Поставщик А</td>
                                <td>15.05.2025</td>
                                <td class="flex items-center space-x-1 py-3">
                                    <button class="btn btn-primary btn-icon edit-material-btn" data-id="1" title="Редактировать">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                    </button>
                                    <button class="btn btn-secondary btn-icon view-price-history-btn" data-id="1" title="История цен">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0Z" /></svg>
                                    </button>
                                </td>
                            </tr>
                             <tr>
                                <td>2</td>
                                <td>KR-PVC-0.4</td>
                                <td>Кромка ПВХ 0.4мм Белая</td>
                                <td>м.п.</td>
                                <td class="text-right">12.00</td>
                                <td>Поставщик Б</td>
                                <td>10.05.2025</td>
                                <td class="flex items-center space-x-1 py-3">
                                    <button class="btn btn-primary btn-icon edit-material-btn" data-id="2" title="Редактировать">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                    </button>
                                    <button class="btn btn-secondary btn-icon view-price-history-btn" data-id="2" title="История цен">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0Z" /></svg>
                                    </button>
                                </td>
                            </tr>
                            </tbody>
                    </table>
                </div>
                <div class="mt-6 flex justify-center">
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        <a href="#" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                          <span class="sr-only">Предыдущая</span>
                          <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        </a>
                        <a href="#" aria-current="page" class="z-10 bg-sky-50 border-sky-500 text-sky-600 relative inline-flex items-center px-4 py-2 border text-sm font-medium">1</a>
                        <a href="#" class="bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium">2</a>
                        <a href="#" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                          <span class="sr-only">Следующая</span>
                          <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                        </a>
                      </nav>
                </div>

            </div>
        </main>
    </div>

    <div id="material-modal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="material-modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-600 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full p-6">
                <div class="flex justify-between items-center pb-3">
                    <h3 class="text-lg font-medium text-gray-900" id="material-modal-title">Добавить новый материал</h3>
                    <button onclick="closeMaterialModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <form id="material-form" class="space-y-4">
                    <input type="hidden" id="material-id" name="material-id">
                    <div>
                        <label for="material-sku" class="form-label">Артикул <span class="text-red-500">*</span></label>
                        <input type="text" id="material-sku" name="material-sku" class="form-input w-full" required>
                    </div>
                    <div>
                        <label for="material-name" class="form-label">Наименование материала <span class="text-red-500">*</span></label>
                        <input type="text" id="material-name" name="material-name" class="form-input w-full" required>
                    </div>
                    <div>
                        <label for="material-unit" class="form-label">Единица измерения <span class="text-red-500">*</span></label>
                        <select id="material-unit" name="material-unit" class="form-select w-full" required>
                            <option value="">Выберите...</option>
                            <option value="шт.">шт. (штуки)</option>
                            <option value="кг">кг (килограммы)</option>
                            <option value="г">г (граммы)</option>
                            <option value="м">м (метры)</option>
                            <option value="см">см (сантиметры)</option>
                            <option value="мм">мм (миллиметры)</option>
                            <option value="кв.м">кв.м (квадратные метры)</option>
                            <option value="м.п.">м.п. (метры погонные)</option>
                            <option value="л">л (литры)</option>
                            <option value="мл">мл (миллилитры)</option>
                            <option value="компл.">компл. (комплекты)</option>
                            <option value="пар">пар (пары)</option>
                            <option value="рул.">рул. (рулоны)</option>
                        </select>
                    </div>
                    <div>
                        <label for="material-price" class="form-label">Закупочная цена (сом) <span class="text-red-500">*</span></label>
                        <input type="number" id="material-price" name="material-price" class="form-input w-full" step="0.01" min="0" required>
                    </div>
                    <div>
                        <label for="material-supplier" class="form-label">Поставщик</label>
                        <input type="text" id="material-supplier" name="material-supplier" class="form-input w-full">
                    </div>
                    <div class="pt-4 flex justify-end space-x-2">
                        <button type="button" onclick="closeMaterialModal()" class="btn btn-secondary">Отмена</button>
                        <button type="submit" class="btn btn-success">Сохранить материал</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const sidebar = document.getElementById('admin-sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');

            if (sidebarToggle && sidebar) {
                sidebarToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('w-64');
                    sidebar.classList.toggle('w-16');
                });
            }

            const approvalCountBadge = document.getElementById('nav-approval-count-sidebar');
            if (approvalCountBadge) {
                approvalCountBadge.textContent = '3';
            }

            const sortableHeaders = document.querySelectorAll('#materials-table th.sortable-header');
            let currentSort = { column: null, direction: 'none' };
            const sortIconAsc = `<svg class="sort-icon asc" viewBox="0 0 20 20" fill="currentColor"><polygon points="10 4 4.5 13 15.5 13"></polygon></svg>`;
            const sortIconDesc = `<svg class="sort-icon desc" viewBox="0 0 20 20" fill="currentColor"><polygon points="10 16 4.5 7 15.5 7"></polygon></svg>`;
            const sortIconNeutral = `<svg class="sort-icon neutral" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 15L12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9"></path></svg>`;

            sortableHeaders.forEach(header => {
                const sortIconContainer = header.querySelector('.sort-icon-container');
                if (sortIconContainer) sortIconContainer.innerHTML = sortIconNeutral;
                header.addEventListener('click', () => { /* ... логика сортировки ... */ });
            });

            const materialModal = document.getElementById('material-modal');
            const materialModalTitle = document.getElementById('material-modal-title');
            const materialForm = document.getElementById('material-form');
            const materialIdInput = document.getElementById('material-id');

            document.getElementById('add-new-material-btn').addEventListener('click', () => {
                materialModalTitle.textContent = 'Добавить новый материал';
                materialForm.reset();
                materialIdInput.value = '';
                materialModal.classList.remove('hidden');
            });

            document.querySelectorAll('.edit-material-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const materialId = event.currentTarget.dataset.id;
                    materialModalTitle.textContent = `Редактировать материал (ID: ${materialId})`;
                    materialForm.reset();
                    materialIdInput.value = materialId;
                    if (materialId === "1") {
                        document.getElementById('material-sku').value = "ЛДСП-Б-16";
                        document.getElementById('material-name').value = "ЛДСП Белый гладкий 16мм";
                        document.getElementById('material-unit').value = "кв.м";
                        document.getElementById('material-price').value = "350.00";
                        document.getElementById('material-supplier').value = "Поставщик А";
                    } else if (materialId === "2") {
                        document.getElementById('material-sku').value = "KR-PVC-0.4";
                        document.getElementById('material-name').value = "Кромка ПВХ 0.4мм Белая";
                        document.getElementById('material-unit').value = "м.п.";
                        document.getElementById('material-price').value = "12.00";
                        document.getElementById('material-supplier').value = "Поставщик Б";
                    }
                    materialModal.classList.remove('hidden');
                });
            });

            if (materialForm) {
                materialForm.addEventListener('submit', (event) => {
                    event.preventDefault();
                    const formData = new FormData(materialForm);
                    const data = Object.fromEntries(formData.entries());
                    console.log('Сохранение материала:', data);
                    alert(`Материал "${data['material-name']}" сохранен (имитация).`);
                    closeMaterialModal();
                });
            }
        });

        function closeMaterialModal() {
            const materialModal = document.getElementById('material-modal');
            if (materialModal) materialModal.classList.add('hidden');
        }
    </script>
</body>
</html>

--- Файл: admin_techcard_approval_detail.txt ---

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Согласование Техкарты и Цены - МебельПрайсПро Админ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* gray-100 */
        }
        .admin-sidebar {
            transition: width 0.3s ease-in-out;
        }
        .admin-content {
            transition: margin-left 0.3s ease-in-out;
        }
        .form-input, .form-select, .form-textarea {
            @apply px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm;
        }
        .form-label {
            @apply block text-sm font-medium text-gray-700 mb-1;
        }
        .table th { @apply px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50; }
        .table td { @apply px-4 py-2 whitespace-nowrap text-sm text-gray-600; }
        .table tbody tr:nth-child(even) { @apply bg-gray-50; }
        .btn { @apply font-medium py-2 px-4 rounded-md shadow-sm transition-colors duration-150; }
        .btn-primary { @apply bg-sky-600 hover:bg-sky-700 text-white; }
        .btn-secondary { @apply bg-gray-200 hover:bg-gray-300 text-gray-700; }
        .btn-success { @apply bg-green-600 hover:bg-green-700 text-white; }
        .btn-danger { @apply bg-red-600 hover:bg-red-700 text-white; }
        .btn-warning { @apply bg-yellow-500 hover:bg-yellow-600 text-white; }
        .component-not-found td {
            @apply bg-red-50 text-red-700;
        }
        .component-not-found .price-placeholder {
            @apply font-semibold;
        }
        .comparison-card { @apply bg-white p-4 rounded-md shadow; }
        .nav-item-count { @apply ml-auto text-xs bg-sky-500 text-white rounded-full px-1.5 py-0.5; }
    </style>
</head>
<body class="flex h-screen">

    <aside id="admin-sidebar" class="admin-sidebar w-64 bg-gray-800 text-gray-100 flex flex-col transition-all duration-300 ease-in-out">
        <div class="px-6 py-4 border-b border-gray-700">
            <a href="admin_dashboard.html" class="text-2xl font-semibold text-white">Мебель<span class="text-orange-400">Прайс</span>Админ</a>
        </div>
        <nav class="flex-grow px-3 py-4 space-y-1.5">
            <a href="admin_dashboard.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                Дашборд
            </a>
            <a href="admin_products.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                 <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                Товары
            </a>
            <a href="admin_techcard_list.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.153 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM10.5 16.5h3.75m-3.75 0h3.75" /></svg>
                Техкарты (Редактор)
            </a>
            <a href="admin_approval_tasks.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md bg-gray-900 text-sky-400"> <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                Согласование Техкарт <span class="nav-item-count" id="nav-approval-count-sidebar">3</span>
            </a>
            <a href="admin_raw_materials.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10.5 11.25h3M12 15h.008m-7.008 0h14.016m0 0A48.108 48.108 0 0012 15c-2.282 0-4.441.68-6.267 1.875M7.5 7.5h9M3.75 7.5A2.25 2.25 0 016 5.25h12a2.25 2.25 0 012.25 2.25m0 0A2.25 2.25 0 0019.5 6c-.023 0-.046.002-.069.004l-.01.002-.008.001-.002.001-.002 0a.002.002 0 01-.002 0l-.002.001-.008.001-.01.002A2.232 2.232 0 0019.5 6c-1.24 0-2.25.985-2.25 2.188V7.5M3.75 7.5c0 .067.003.132.008.196M12 15c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125h0c-.621 0-1.125.504-1.125 1.125v4.5c0 .621.504 1.125 1.125 1.125h0z" /></svg>
                Сырьё и Цены
            </a>
             <a href="admin_dealers_list.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345h5.518a.562.562 0 01.329 1.004l-4.243 2.97a.563.563 0 00-.178.643l2.125 5.111a.563.563 0 01-.83.632l-4.243-2.97a.563.563 0 00-.652 0l-4.243 2.97a.563.563 0 01-.83-.632l2.125-5.111a.563.563 0 00-.178-.643l-4.243-2.97a.562.562 0 01.329-1.004h5.518a.563.563 0 00.475-.345L11.48 3.5z" />
                </svg>
                Дилеры и Оптовики
            </a>
            <a href="admin_users.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" /></svg>
                Пользователи
            </a>
            <a href="../html/index.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 text-red-400 hover:text-red-300 mt-auto">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" /></svg>
                Выход (на сайт)
            </a>
        </nav>
    </aside>

    <div class="flex-1 flex flex-col overflow-hidden">
        <header class="bg-white shadow-sm">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <button id="sidebar-toggle" class="text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-sky-500 md:hidden">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        </button>
                        <h1 class="text-xl font-semibold text-gray-800 ml-3" id="page-main-title">Согласование Техкарты и Цены</h1>
                    </div>
                    <div class="flex items-center">
                        <span class="text-sm text-gray-600 mr-3">Иванов И.И. (Руководитель)</span>
                        <img class="h-8 w-8 rounded-full object-cover" src="https://placehold.co/100x100/a0aec0/ffffff?text=User" alt="[Фото пользователя]">
                    </div>
                </div>
            </div>
        </header>
        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4 sm:p-6">
            <div class="container mx-auto">
                <div class="mb-6 p-4 sm:p-6 bg-white rounded-lg border shadow-sm">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-3">
                        <h2 class="text-xl font-semibold text-gray-800">
                            Задача на согласование: <span class="text-sky-600" id="product-name-title-detail">Тумба "Фест" 60 с раковиной</span>
                        </h2>
                        <a href="admin_approval_tasks.html" class="text-sm text-sky-600 hover:underline mt-2 sm:mt-0">&larr; К списку задач</a>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3 text-sm">
                        <p><strong>Артикул товара:</strong> <span id="product-sku-info-detail" class="text-gray-700">WS-FST60-WHT</span></p>
                        <p><strong>Инициатор:</strong> <span id="editor-name-info-detail" class="text-gray-700">Петров П.П.</span></p>
                        <p><strong>Дата поступления:</strong> <span id="submission-date-info-detail" class="text-gray-700">18.05.2025 10:30</span></p>
                        <p><strong>Тип изменения:</strong> <span id="change-type-info-detail" class="text-gray-700">Новая техкарта</span></p>
                    </div>
                    <div class="mt-3">
                        <p class="text-sm"><strong>Комментарий редактора:</strong></p>
                        <div id="editor-comment-display-detail" class="text-sm p-3 border rounded bg-gray-50 max-h-28 overflow-y-auto mt-1">
                            Первичная загрузка техкарты для нового изделия. Прошу проверить расчеты и корректность подбора материалов. Особое внимание на кромку.
                        </div>
                    </div>
                </div>

                <div id="techcard-comparison-block-detail" class="grid md:grid-cols-2 gap-6 mb-6 hidden">
                    <div class="comparison-card">
                        <h3 class="text-lg font-medium text-gray-700 mb-2">Текущая техкарта (Утверждена: <span id="current-techcard-date-detail">10.01.2025</span>)</h3>
                        <p class="text-sm mt-1">Себестоимость (материалы): <span class="font-semibold" id="current-material-cost-detail">480.00 сом</span></p>
                        <p class="text-sm">Текущая розничная цена: <span class="font-semibold" id="current-retail-price-display-detail">1200.00 сом</span></p>
                        <a href="#" id="download-current-techcard-link-detail" target="_blank" class="mt-2 text-xs text-sky-600 hover:underline inline-flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            Скачать текущий XLSX
                        </a>
                    </div>
                    <div class="comparison-card bg-sky-50 border-sky-200">
                        <h3 class="text-lg font-medium text-sky-700 mb-2">Новая техкарта (Загружена: <span id="new-techcard-upload-date-detail">18.05.2025</span>)</h3>
                         <a href="#" id="download-new-techcard-link-detail" target="_blank" class="mt-2 text-xs text-sky-600 hover:underline inline-flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            Скачать новый XLSX (на утверждение)
                        </a>
                    </div>
                </div>

                <div class="bg-white p-4 sm:p-6 rounded-lg shadow-sm mb-6">
                    <h3 class="text-lg font-medium text-gray-800 mb-3">Компоненты по новой техкарте:</h3>
                    <div class="max-h-80 overflow-y-auto border border-gray-200 rounded-md">
                        <table class="min-w-full divide-y divide-gray-200 text-sm table">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th>№</th>
                                    <th>Артикул (файл)</th>
                                    <th>Наименование (файл)</th>
                                    <th>Кол-во</th>
                                    <th>Ед.изм.</th>
                                    <th>Цена сырья (БД)</th>
                                    <th>Стоимость</th>
                                </tr>
                            </thead>
                            <tbody id="new-parsed-components-table-body-detail" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <div class="mt-4 text-right">
                        <p class="text-sm">Количество позиций: <span class="font-semibold" id="new-components-count-detail">0</span></p>
                        <p class="text-sm text-red-500 hidden" id="new-missing-prices-warning-detail">Внимание! Для <span id="new-missing-prices-count-detail">0</span> компонент(а/ов) не найдены цены в справочнике.</p>
                        <p class="text-md mt-1">Общая себестоимость материалов (по новой техкарте): <strong class="text-xl text-blue-700" id="new-total-material-cost-detail">0.00 сом</strong></p>
                    </div>
                </div>

                <div class="bg-white p-4 sm:p-6 rounded-lg shadow-sm">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Установление Розничной Цены</h3>
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div class="p-4 bg-gray-50 rounded-md border">
                            <p class="text-sm text-gray-600">Текущая розничная цена в каталоге:</p>
                            <p class="text-2xl font-bold text-gray-500" id="current-retail-price-info-detail">0.00 сом</p>
                        </div>
                        <div class="p-4 bg-blue-50 rounded-md border border-blue-200">
                            <p class="text-sm text-blue-700">Рекомендуемая розничная цена <br class="hidden sm:inline">(себестоимость <span class="font-bold" id="new-cost-for-recommendation-detail">0.00 сом</span>, наценка <span id="markup-percentage-info-detail">0%</span>):</p>
                            <p class="text-2xl font-bold text-blue-600" id="recommended-retail-price-detail">0.00 сом</p>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="final-retail-price-detail" class="form-label text-lg font-medium">Установить новую розничную цену:<span class="text-red-500">*</span></label>
                        <div class="flex items-center">
                            <input type="number" id="final-retail-price-detail" value="" class="form-input text-xl py-2 w-full md:w-1/2 lg:w-1/3" step="0.01" min="0">
                            <span class="ml-2 text-lg text-gray-700">сом</span>
                        </div>
                        <p id="price-validation-error-detail" class="text-red-500 text-xs mt-1 hidden">Цена должна быть положительным числом.</p>
                    </div>

                    <div class="mb-6">
                        <label for="supervisor-comment-detail" class="form-label">Комментарий/Обоснование решения (обязательно при отклонении):</label>
                        <textarea id="supervisor-comment-detail" class="form-textarea w-full" rows="3" placeholder="Например, причина отклонения или детали утверждения..."></textarea>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-3 justify-end border-t border-gray-200 pt-6">
                        <button id="reject-changes-btn-detail" type="button" class="btn btn-danger w-full sm:w-auto">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline -ml-1 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                            Отклонить
                        </button>
                        <button id="approve-changes-btn-detail" type="button" class="btn btn-success w-full sm:w-auto">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline -ml-1 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                            Утвердить и Обновить Цену
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Моковый JS для страницы admin_techcard_approval_detail.html
        document.addEventListener('DOMContentLoaded', () => {
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const adminSidebar = document.getElementById('admin-sidebar');
            if (sidebarToggle && adminSidebar) {
                sidebarToggle.addEventListener('click', () => {
                    adminSidebar.classList.toggle('w-64');
                    adminSidebar.classList.toggle('w-16');
                });
            }

            const approvalCountBadge = document.getElementById('nav-approval-count-sidebar');
            if (approvalCountBadge) {
                approvalCountBadge.textContent = '3'; // Пример
            }


            const urlParams = new URLSearchParams(window.location.search);
            const taskId = urlParams.get('id') || '1';

            const mockRawMaterialPrices = {
                "ЛДСП-Б-16": { name: "ЛДСП Белый гладкий 16мм", price: 350.00, unit: "кв.м" },
                "ZER-AGC-04": { name: "Зеркало 4мм AGC влагостойкое (старый)", price: 1150.00, unit: "кв.м" },
                "KR-PVC-0.4": { name: "Кромка ПВХ 0.4мм Белая", price: 12.00, unit: "м.п." },
                "RUCHKA-01": { name: "Ручка мебельная скоба", price: 85.00, unit: "шт." },
                "ZER-AGC-04-NEW": { name: "Зеркало 4мм AGC (Новый поставщик)", price: 1050.00, unit: "кв.м" }
            };

            const tasks = {
                '1': {
                    productName: 'Тумба "Фест" 60 с раковиной', productSku: 'WS-FST60-WHT', editorName: 'Петров П.П.',
                    submissionDate: '18.05.2025 10:30', changeType: 'Новая техкарта',
                    editorComment: 'Первичная загрузка техкарты для нового изделия. Прошу проверить расчеты и корректность подбора материалов. Особое внимание на кромку.',
                    currentRetailPrice: null, isUpdate: false,
                    newTechCardComponents: [
                        { num: 1, article: "ЛДСП-Б-16", name: "ЛДСП Белый гладкий 16мм", quantity: 1.25, unit: "кв.м" },
                        { num: 2, article: "ZER-AGC-04-NEW", name: "Зеркало 4мм AGC (Новый поставщик)", quantity: 0.48, unit: "кв.м" },
                        { num: 3, article: "KR-PVC-0.4", name: "Кромка ПВХ 0.4мм Белая", quantity: 5.6, unit: "м.п." },
                        { num: 4, article: "NO-PRICE-YET", name: "Фурнитура XYZ (без цены)", quantity: 1, unit: "компл." },
                    ]
                },
                '2': {
                    productName: 'Зеркало "Орион" 80 LED', productSku: 'WS-ZER80-LED', editorName: 'Сидорова А.А.',
                    submissionDate: '17.05.2025 16:15', changeType: 'Обновление техкарты',
                    editorComment: 'Замена материала подсветки на более энергоэффективный. Себестоимость немного изменилась.',
                    currentRetailPrice: 12000.00, isUpdate: true,
                    currentTechCardInfo: { date: '10.01.2025', materialCost: 4800.00, retailPrice: 12000.00, fileName: 'techcard_orion80_v1.xlsx' },
                    newTechCardComponents: [
                        { num: 1, article: "ZER-AGC-04", name: "Зеркало 4мм AGC", quantity: 0.96, unit: "кв.м" },
                        { num: 2, article: "LED-STRIP-NEW", name: "LED лента (новая, экономичная)", quantity: 2.5, unit: "м.п." },
                    ]
                },
                '3': {
                    productName: 'Пенал "Линеа"', productSku: 'WS-PEN-LIN', editorName: 'Система (изм. цен сырья)',
                    submissionDate: '16.05.2025 09:00', changeType: 'Запрос на пересчет цены',
                    editorComment: 'Изменилась закупочная цена на "ЛДСП-Б-16". Требуется пересмотр розничной цены.',
                    currentRetailPrice: 9500.00, isUpdate: false,
                    newTechCardComponents: [
                        { num: 1, article: "ЛДСП-Б-16", name: "ЛДСП Белый гладкий 16мм", quantity: 2.1, unit: "кв.м" },
                        { num: 2, article: "RUCHKA-01", name: "Ручка мебельная", quantity: 2, unit: "шт." },
                    ]
                }
            };

            const taskData = tasks[taskId] || tasks['1'];

            document.getElementById('page-main-title').textContent = `Согласование: ${taskData.productName}`;
            document.getElementById('product-name-title-detail').textContent = taskData.productName;
            document.getElementById('product-sku-info-detail').textContent = taskData.productSku;
            document.getElementById('editor-name-info-detail').textContent = taskData.editorName;
            document.getElementById('submission-date-info-detail').textContent = taskData.submissionDate;
            document.getElementById('change-type-info-detail').textContent = taskData.changeType;
            document.getElementById('editor-comment-display-detail').textContent = taskData.editorComment;
            document.getElementById('current-retail-price-info-detail').textContent = taskData.currentRetailPrice !== null ? formatCurrency(taskData.currentRetailPrice) : "Не установлена";

            const comparisonBlock = document.getElementById('techcard-comparison-block-detail');
            if (taskData.isUpdate && taskData.currentTechCardInfo && comparisonBlock) {
                document.getElementById('current-techcard-date-detail').textContent = taskData.currentTechCardInfo.date;
                document.getElementById('current-material-cost-detail').textContent = formatCurrency(taskData.currentTechCardInfo.materialCost);
                document.getElementById('current-retail-price-display-detail').textContent = formatCurrency(taskData.currentTechCardInfo.retailPrice);
                document.getElementById('download-current-techcard-link-detail').href = `#download-archive/${taskData.currentTechCardInfo.fileName}`;
                document.getElementById('new-techcard-upload-date-detail').textContent = taskData.submissionDate;
                document.getElementById('download-new-techcard-link-detail').href = `#download-pending/new_techcard_for_${taskData.productSku}.xlsx`;
                comparisonBlock.classList.remove('hidden');
            }

            const newComponentsTableBody = document.getElementById('new-parsed-components-table-body-detail');
            let newTotalMaterialCost = 0;
            let newMissingPricesCount = 0;
            newComponentsTableBody.innerHTML = '';

            taskData.newTechCardComponents.forEach((comp, index) => {
                const row = newComponentsTableBody.insertRow();
                row.insertCell().textContent = comp.num || (index + 1);
                row.insertCell().textContent = comp.article;
                row.insertCell().textContent = comp.name;
                row.insertCell().textContent = comp.quantity;
                row.insertCell().textContent = comp.unit;

                const priceInfo = mockRawMaterialPrices[comp.article];
                let unitPrice = 0;
                let componentCost = 0;
                let priceCellContent = '<span class="text-red-600 font-semibold">Не найдено!</span>';
                let costCellContent = '<span class="text-red-600">-</span>';

                if (priceInfo) {
                    unitPrice = priceInfo.price;
                    componentCost = comp.quantity * unitPrice;
                    newTotalMaterialCost += componentCost;
                    priceCellContent = formatCurrency(unitPrice);
                    costCellContent = formatCurrency(componentCost);
                } else {
                    newMissingPricesCount++;
                    row.classList.add('component-not-found');
                }

                row.insertCell().innerHTML = priceCellContent;
                row.insertCell().innerHTML = costCellContent;
            });

            document.getElementById('new-components-count-detail').textContent = taskData.newTechCardComponents.length;
            document.getElementById('new-total-material-cost-detail').textContent = formatCurrency(newTotalMaterialCost);
            document.getElementById('new-cost-for-recommendation-detail').textContent = formatCurrency(newTotalMaterialCost);

            const newMissingPricesWarning = document.getElementById('new-missing-prices-warning-detail');
            if (newMissingPricesCount > 0) {
                document.getElementById('new-missing-prices-count-detail').textContent = newMissingPricesCount;
                newMissingPricesWarning.classList.remove('hidden');
            } else {
                newMissingPricesWarning.classList.add('hidden');
            }

            const markupPercentage = 120;
            document.getElementById('markup-percentage-info-detail').textContent = `${markupPercentage}%`;
            const recommendedPrice = newTotalMaterialCost * (1 + markupPercentage / 100);
            document.getElementById('recommended-retail-price-detail').textContent = formatCurrency(recommendedPrice);
            document.getElementById('final-retail-price-detail').value = recommendedPrice > 0 ? recommendedPrice.toFixed(2) : '';


            const approveBtn = document.getElementById('approve-changes-btn-detail');
            const rejectBtn = document.getElementById('reject-changes-btn-detail');
            const finalPriceInput = document.getElementById('final-retail-price-detail');
            const supervisorCommentInput = document.getElementById('supervisor-comment-detail');
            const priceValidationError = document.getElementById('price-validation-error-detail');

            function validatePrice() {
                const price = parseFloat(finalPriceInput.value);
                if (isNaN(price) || price <= 0) {
                    priceValidationError.classList.remove('hidden');
                    finalPriceInput.classList.add('border-red-500');
                    return false;
                }
                priceValidationError.classList.add('hidden');
                finalPriceInput.classList.remove('border-red-500');
                return true;
            }

            finalPriceInput.addEventListener('input', validatePrice);

            if (approveBtn) {
                approveBtn.addEventListener('click', () => {
                    if (!validatePrice()) return;
                    if (newMissingPricesCount > 0 && !confirm("Внимание! Для некоторых компонентов не найдены цены в справочнике. Себестоимость и рекомендуемая цена могут быть неточными. Всё равно утвердить?")) {
                        return;
                    }
                    console.log("Утверждено:", { taskId: taskId, finalPrice: parseFloat(finalPriceInput.value), supervisorComment: supervisorCommentInput.value });
                    alert(`Задача #${taskId} для "${taskData.productName}" утверждена. Новая цена: ${formatCurrency(parseFloat(finalPriceInput.value))}`);
                    window.location.href = 'admin_approval_tasks.html';
                });
            }

            if (rejectBtn) {
                rejectBtn.addEventListener('click', () => {
                    if (!supervisorCommentInput.value.trim()) {
                        alert("Пожалуйста, укажите причину отклонения в комментарии.");
                        supervisorCommentInput.focus();
                        return;
                    }
                    console.log("Отклонено:", { taskId: taskId, supervisorComment: supervisorCommentInput.value });
                    alert(`Задача #${taskId} для "${taskData.productName}" отклонена.`);
                    window.location.href = 'admin_approval_tasks.html';
                });
            }
        });

        function formatCurrency(amount) {
            if (amount === null || typeof amount === 'undefined' || isNaN(amount)) return "0.00 сом";
            return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'KGS', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount).replace(/\s?сом$/, ' сом');
        }
    </script>
</body>
</html>

--- Файл: admin_techcard_list.txt ---

                                                                                 <!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление Техкартами - МебельПрайсПро Админ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* gray-100 */
        }
        .admin-sidebar {
            transition: width 0.3s ease-in-out;
        }
        .admin-content {
            transition: margin-left 0.3s ease-in-out;
        }
        .form-input, .form-select {
            @apply px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm;
        }
        .table th.sortable-header { 
            @apply cursor-pointer hover:bg-gray-100 relative; 
        }
        .table th .sort-icon-container { 
            @apply inline-flex items-center justify-center ml-1.5 align-middle;
            width: 1em; 
            height: 1em;
        }
        .table th svg.sort-icon {
            @apply h-full w-full;
        }
        .table th svg.sort-icon.neutral { @apply text-gray-400; }
        .table th svg.sort-icon.asc, .table th svg.sort-icon.desc { @apply text-sky-600; }
        
        .table td { @apply px-4 py-3 whitespace-nowrap text-sm text-gray-700; }
        .table tbody tr:nth-child(even) { @apply bg-gray-50; }
        .btn { @apply font-medium py-2 px-4 rounded-md shadow-sm transition-colors duration-150; }
        .btn-primary { @apply bg-sky-600 hover:bg-sky-700 text-white; }
        .btn-secondary { @apply bg-gray-200 hover:bg-gray-300 text-gray-700; }
        .btn-success { @apply bg-green-500 hover:bg-green-600 text-white; }
        .btn-warning { @apply bg-yellow-500 hover:bg-yellow-600 text-white; }
        .btn-danger { @apply bg-red-500 hover:bg-red-600 text-white; }
        .btn-icon { @apply p-1.5; }

        .status-badge { @apply px-2 inline-flex text-xs leading-5 font-semibold rounded-full; }
        .status-no_card { @apply bg-gray-100 text-gray-700; }
        .status-draft { @apply bg-yellow-100 text-yellow-800; }
        .status-pending_approval { @apply bg-blue-100 text-blue-800; }
        .status-approved { @apply bg-green-100 text-green-800; }
        .status-rejected { @apply bg-red-100 text-red-800; }
        .nav-item-count { @apply ml-auto text-xs bg-sky-500 text-white rounded-full px-1.5 py-0.5; }
    </style>
</head>
<body class="flex h-screen">

    <aside id="admin-sidebar" class="admin-sidebar w-64 bg-gray-800 text-gray-100 flex flex-col transition-all duration-300 ease-in-out">
        <div class="px-6 py-4 border-b border-gray-700">
            <a href="admin_dashboard.html" class="text-2xl font-semibold text-white">Мебель<span class="text-orange-400">Прайс</span>Админ</a>
        </div>
        <nav class="flex-grow px-3 py-4 space-y-1.5">
            <a href="admin_dashboard.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                Дашборд
            </a>
            <a href="admin_products.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                 <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                Товары
            </a>
            <a href="admin_techcard_list.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md bg-gray-900 text-sky-400"> <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.153 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM10.5 16.5h3.75m-3.75 0h3.75" /></svg>
                Техкарты (Редактор)
            </a>
            <a href="admin_approval_tasks.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                 <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                Согласование Техкарт <span class="nav-item-count" id="nav-approval-count-sidebar">3</span>
            </a>
            <a href="admin_raw_materials.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10.5 11.25h3M12 15h.008m-7.008 0h14.016m0 0A48.108 48.108 0 0012 15c-2.282 0-4.441.68-6.267 1.875M7.5 7.5h9M3.75 7.5A2.25 2.25 0 016 5.25h12a2.25 2.25 0 012.25 2.25m0 0A2.25 2.25 0 0019.5 6c-.023 0-.046.002-.069.004l-.01.002-.008.001-.002.001-.002 0a.002.002 0 01-.002 0l-.002.001-.008.001-.01.002A2.232 2.232 0 0019.5 6c-1.24 0-2.25.985-2.25 2.188V7.5M3.75 7.5c0 .067.003.132.008.196M12 15c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125h0c-.621 0-1.125.504-1.125 1.125v4.5c0 .621.504 1.125 1.125 1.125h0z" /></svg>
                Сырьё и Цены
            </a>
             <a href="admin_dealers_list.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345h5.518a.562.562 0 01.329 1.004l-4.243 2.97a.563.563 0 00-.178.643l2.125 5.111a.563.563 0 01-.83.632l-4.243-2.97a.563.563 0 00-.652 0l-4.243 2.97a.563.563 0 01-.83-.632l2.125-5.111a.563.563 0 00-.178-.643l-4.243-2.97a.562.562 0 01.329-1.004h5.518a.563.563 0 00.475-.345L11.48 3.5z" />
                </svg>
                Дилеры и Оптовики
            </a>
            <a href="admin_users.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" /></svg>
                Пользователи
            </a>
            <a href="../html/index.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 text-red-400 hover:text-red-300 mt-auto">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" /></svg>
                Выход (на сайт)
            </a>
        </nav>
    </aside>

    <div class="flex-1 flex flex-col overflow-hidden">
        <header class="bg-white shadow-sm">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <button id="sidebar-toggle" class="text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-sky-500 md:hidden">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        </button>
                        <h1 class="text-xl font-semibold text-gray-800 ml-3">Управление Техкартами</h1>
                    </div>
                    <div class="flex items-center">
                        <span class="text-sm text-gray-600 mr-3">Редактор Техкарт</span>
                        <img class="h-8 w-8 rounded-full object-cover" src="https://placehold.co/100x100/e2e8f0/4a5568?text=E" alt="[Фото пользователя]">
                    </div>
                </div>
            </div>
        </header>
        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
            <div class="container mx-auto">
                <div class="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                     <h2 class="text-2xl font-semibold text-gray-800">Техкарты Товаров (<span id="total-techcards-count">3</span>)</h2>
                    <button id="batch-upload-techcards-btn" class="btn btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline -ml-1 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                        Загрузить пакет техкарт
                    </button>
                </div>
                <div class="bg-white p-4 rounded-md shadow mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                        <div>
                            <label for="filter-product-search-techcard" class="form-label">Поиск по товару:</label>
                            <input type="text" id="filter-product-search-techcard" placeholder="Артикул, название..." class="form-input w-full">
                        </div>
                        <div>
                            <label for="filter-category-techcard" class="form-label">Категория:</label>
                            <select id="filter-category-techcard" class="form-select w-full">
                                <option value="">Все категории</option>
                                <option value="tumbi">Тумбы с раковиной</option>
                                <option value="zerkala">Зеркала и шкафы</option>
                            </select>
                        </div>
                        <div>
                            <label for="filter-status-techcard" class="form-label">Статус техкарты:</label>
                            <select id="filter-status-techcard" class="form-select w-full">
                                <option value="">Все статусы</option>
                                <option value="no_card">Отсутствует</option>
                                <option value="draft">Черновик</option>
                                <option value="pending_approval">На согласовании</option>
                                <option value="approved">Утверждена</option>
                                <option value="rejected">Отклонена</option>
                            </select>
                        </div>
                        <div class="flex space-x-2 items-end">
                            <button class="btn btn-primary w-full sm:w-auto">Применить</button>
                            <button class="btn btn-secondary w-full sm:w-auto">Сбросить</button>
                        </div>
                    </div>
                </div>
                <div class="bg-white shadow-md rounded-lg overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 table" id="techcards-table">
                        <thead>
                            <tr>
                                <th class="sortable-header" data-sort-by="product_id">ID Товара <span class="sort-icon-container"></span></th>
                                <th class="sortable-header" data-sort-by="product_name">Наименование Товара <span class="sort-icon-container"></span></th>
                                <th class="sortable-header" data-sort-by="product_sku">Артикул <span class="sort-icon-container"></span></th>
                                <th class="sortable-header" data-sort-by="category">Категория <span class="sort-icon-container"></span></th>
                                <th class="sortable-header" data-sort-by="techcard_status">Статус Техкарты <span class="sort-icon-container"></span></th>
                                <th class="sortable-header" data-sort-by="last_update">Обновлено <span class="sort-icon-container"></span></th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td>1</td>
                                <td>Тумба "Modern" 75см, антрацит</td>
                                <td>WS-MOD75-ANT</td>
                                <td>Тумбы с раковиной</td>
                                <td><span class="status-badge status-approved">Утверждена</span></td>
                                <td>15.05.2025</td>
                                <td class="flex items-center space-x-1 py-3">
                                    <button class="btn btn-secondary btn-icon view-techcard-btn" data-product-id="1" title="Просмотреть техкарту">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                    </button>
                                    <button class="btn btn-primary btn-icon upload-new-version-btn" data-product-id="1" title="Загрузить новую версию">
                                         <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td>2</td>
                                <td>Зеркало "Orion" с LED подсветкой</td>
                                <td>WS-ZER-ORL</td>
                                <td>Зеркала и шкафы</td>
                                <td><span class="status-badge status-pending_approval">На согласовании</span></td>
                                <td>17.05.2025</td>
                                <td class="flex items-center space-x-1 py-3">
                                     <button class="btn btn-secondary btn-icon view-techcard-btn" data-product-id="2" title="Просмотреть детали">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                    </button>
                                    <button class="btn btn-warning btn-icon text-white cancel-submission-btn" data-product-id="2" title="Отменить отправку">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                                    </button>
                                </td>
                            </tr>
                             <tr>
                                <td>3</td>
                                <td>Пенал "Linea Slim" дуб крафт</td>
                                <td>WS-PEN-LIN</td>
                                <td>Пеналы</td>
                                <td><span class="status-badge status-no_card">Нет техкарты</span></td>
                                <td>-</td>
                                <td class="flex items-center space-x-1 py-3">
                                    <button class="btn btn-success btn-icon upload-techcard-btn" data-product-id="3" title="Загрузить техкарту">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9.75v6.75m0 0l-3-3m3 3l3-3m-8.25 6a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" /></svg>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="mt-6 flex justify-center">
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        <a href="#" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                          <span class="sr-only">Предыдущая</span>
                          <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        </a>
                        <a href="#" aria-current="page" class="z-10 bg-sky-50 border-sky-500 text-sky-600 relative inline-flex items-center px-4 py-2 border text-sm font-medium">1</a>
                        <a href="#" class="bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium">2</a>
                        <a href="#" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                          <span class="sr-only">Следующая</span>
                          <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                        </a>
                      </nav>
                </div>
            </div>
        </main>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const sidebar = document.getElementById('admin-sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            
            if (sidebarToggle && sidebar) {
                sidebarToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('w-64');
                    sidebar.classList.toggle('w-16'); 
                });
            }
            
            const approvalCountBadge = document.getElementById('nav-approval-count-sidebar');
            if (approvalCountBadge) {
                approvalCountBadge.textContent = '3'; 
            }

            const sortableHeaders = document.querySelectorAll('#techcards-table th.sortable-header');
            let currentSort = { column: null, direction: 'none' };
            const sortIconAsc = `<svg class="sort-icon asc" viewBox="0 0 20 20" fill="currentColor"><polygon points="10 4 4.5 13 15.5 13"></polygon></svg>`;
            const sortIconDesc = `<svg class="sort-icon desc" viewBox="0 0 20 20" fill="currentColor"><polygon points="10 16 4.5 7 15.5 7"></polygon></svg>`;
            const sortIconNeutral = `<svg class="sort-icon neutral" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 15L12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9"></path></svg>`;

            sortableHeaders.forEach(header => {
                const sortIconContainer = header.querySelector('.sort-icon-container');
                if (sortIconContainer) sortIconContainer.innerHTML = sortIconNeutral;
                header.addEventListener('click', () => { /* ... логика сортировки ... */ });
            });

            // Обработчики для кнопок в таблице (открытие модального окна и т.д.)
            // Эти кнопки должны будут вызывать модальное окно, которое мы ранее определили в admin_upload_techcard_modal.html
            // Для простоты, пока просто выведем alert
            document.querySelectorAll('.upload-techcard-btn, .upload-new-version-btn, .view-techcard-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = e.currentTarget.dataset.productId;
                    alert(`Действие для товара ID ${productId}: ${e.currentTarget.title} (откроется модальное окно)`);
                    // Здесь будет логика открытия модального окна admin_upload_techcard_modal.html с передачей productId
                });
            });
             document.querySelectorAll('.cancel-submission-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = e.currentTarget.dataset.productId;
                    if(confirm(`Отменить отправку техкарты для товара ID ${productId} на согласование?`)){
                        alert(`Отправка для товара ID ${productId} отменена (имитация).`);
                        // Логика изменения статуса
                    }
                });
            });
        });
    </script>
</body>
</html>

--- Файл: admin_users.txt ---

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление Пользователями - МебельПрайсПро Админ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* gray-100 */
        }
        .admin-sidebar {
            transition: width 0.3s ease-in-out;
        }
        .admin-content {
            transition: margin-left 0.3s ease-in-out;
        }
        .form-input, .form-select, .form-textarea {
            @apply px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm;
        }
        .form-label {
            @apply block text-sm font-medium text-gray-700 mb-1;
        }
        .table th.sortable-header { 
            @apply cursor-pointer hover:bg-gray-100 relative; 
        }
        .table th .sort-icon-container { 
            @apply inline-flex items-center justify-center ml-1.5 align-middle;
            width: 1em; 
            height: 1em;
        }
        .table th svg.sort-icon {
            @apply h-full w-full;
        }
        .table th svg.sort-icon.neutral { @apply text-gray-400; }
        .table th svg.sort-icon.asc, .table th svg.sort-icon.desc { @apply text-sky-600; }
        
        .table td { @apply px-4 py-3 whitespace-nowrap text-sm text-gray-700; }
        .table tbody tr:nth-child(even) { @apply bg-gray-50; }
        .btn { @apply font-medium py-2 px-4 rounded-md shadow-sm transition-colors duration-150; }
        .btn-primary { @apply bg-sky-600 hover:bg-sky-700 text-white; }
        .btn-secondary { @apply bg-gray-200 hover:bg-gray-300 text-gray-700; }
        .btn-success { @apply bg-green-500 hover:bg-green-600 text-white; }
        .btn-danger { @apply bg-red-500 hover:bg-red-600 text-white; }
        .btn-warning { @apply bg-yellow-500 hover:bg-yellow-600 text-white; }
        .btn-icon { @apply p-1.5; }
        .nav-item-count { @apply ml-auto text-xs bg-sky-500 text-white rounded-full px-1.5 py-0.5; }
        .status-badge { @apply px-2 inline-flex text-xs leading-5 font-semibold rounded-full; }
        .status-active { @apply bg-green-100 text-green-800; }
        .status-inactive { @apply bg-red-100 text-red-800; }
    </style>
</head>
<body class="flex h-screen">

    <aside id="admin-sidebar" class="admin-sidebar w-64 bg-gray-800 text-gray-100 flex flex-col transition-all duration-300 ease-in-out">
        <div class="px-6 py-4 border-b border-gray-700">
            <a href="admin_dashboard.html" class="text-2xl font-semibold text-white">Мебель<span class="text-orange-400">Прайс</span>Админ</a>
        </div>
        <nav class="flex-grow px-3 py-4 space-y-1.5">
            <a href="admin_dashboard.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                Дашборд
            </a>
            <a href="admin_products.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                 <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                Товары
            </a>
            <a href="admin_techcard_list.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.153 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM10.5 16.5h3.75m-3.75 0h3.75" /></svg>
                Техкарты (Редактор)
            </a>
            <a href="admin_approval_tasks.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                 <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                Согласование Техкарт <span class="nav-item-count" id="nav-approval-count-sidebar">3</span>
            </a>
            <a href="admin_raw_materials.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10.5 11.25h3M12 15h.008m-7.008 0h14.016m0 0A48.108 48.108 0 0012 15c-2.282 0-4.441.68-6.267 1.875M7.5 7.5h9M3.75 7.5A2.25 2.25 0 016 5.25h12a2.25 2.25 0 012.25 2.25m0 0A2.25 2.25 0 0019.5 6c-.023 0-.046.002-.069.004l-.01.002-.008.001-.002.001-.002 0a.002.002 0 01-.002 0l-.002.001-.008.001-.01.002A2.232 2.232 0 0019.5 6c-1.24 0-2.25.985-2.25 2.188V7.5M3.75 7.5c0 .067.003.132.008.196M12 15c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125h0c-.621 0-1.125.504-1.125 1.125v4.5c0 .621.504 1.125 1.125 1.125h0z" /></svg>
                Сырьё и Цены
            </a>
             <a href="admin_dealers_list.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 hover:text-sky-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345h5.518a.562.562 0 01.329 1.004l-4.243 2.97a.563.563 0 00-.178.643l2.125 5.111a.563.563 0 01-.83.632l-4.243-2.97a.563.563 0 00-.652 0l-4.243 2.97a.563.563 0 01-.83-.632l2.125-5.111a.563.563 0 00-.178-.643l-4.243-2.97a.562.562 0 01.329-1.004h5.518a.563.563 0 00.475-.345L11.48 3.5z" />
                </svg>
                Дилеры и Оптовики
            </a>
            <a href="admin_users.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md bg-gray-900 text-sky-400"> <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" /></svg>
                Пользователи
            </a>
            <a href="../html/index.html" class="flex items-center px-3 py-2.5 text-sm font-medium rounded-md hover:bg-gray-700 text-red-400 hover:text-red-300 mt-auto">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" /></svg>
                Выход (на сайт)
            </a>
        </nav>
    </aside>

    <div class="flex-1 flex flex-col overflow-hidden">
        <header class="bg-white shadow-sm">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <button id="sidebar-toggle" class="text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-sky-500 md:hidden">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        </button>
                        <h1 class="text-xl font-semibold text-gray-800 ml-3">Управление Пользователями</h1>
                    </div>
                    <div class="flex items-center">
                        <span class="text-sm text-gray-600 mr-3">Администратор</span>
                        <img class="h-8 w-8 rounded-full object-cover" src="https://placehold.co/100x100/7dd3fc/0c4a6e?text=A" alt="[Фото пользователя]">
                    </div>
                </div>
            </div>
        </header>
        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
            <div class="container mx-auto">
                <div class="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                    <h2 class="text-2xl font-semibold text-gray-800">Список Пользователей (<span id="total-users-count">5</span>)</h2>
                    <button id="add-new-user-btn" class="btn btn-success">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline -ml-1 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                        Добавить пользователя
                    </button>
                </div>
                
                <div class="bg-white p-4 rounded-md shadow mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="filter-user-search" class="form-label">Поиск по пользователю:</label>
                            <input type="text" id="filter-user-search" placeholder="Имя, Email..." class="form-input w-full">
                        </div>
                        <div>
                            <label for="filter-user-role" class="form-label">Роль:</label>
                            <select id="filter-user-role" class="form-select w-full">
                                <option value="">Все роли</option>
                                <option value="admin">Администратор</option>
                                <option value="manager">Руководитель</option>
                                <option value="editor">Редактор техкарт</option>
                                <option value="marketer">Маркетолог</option>
                            </select>
                        </div>
                        <div class="flex space-x-2 items-end">
                            <button class="btn btn-primary w-full sm:w-auto">Применить</button>
                            <button class="btn btn-secondary w-full sm:w-auto">Сбросить</button>
                        </div>
                    </div>
                </div>

                <div class="bg-white shadow-md rounded-lg overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 table" id="users-table">
                        <thead>
                            <tr>
                                <th class="sortable-header" data-sort-by="id">ID <span class="sort-icon-container"></span></th>
                                <th class="sortable-header" data-sort-by="name">ФИО <span class="sort-icon-container"></span></th>
                                <th class="sortable-header" data-sort-by="email">Email <span class="sort-icon-container"></span></th>
                                <th class="sortable-header" data-sort-by="role">Роль <span class="sort-icon-container"></span></th>
                                <th class="sortable-header" data-sort-by="status">Статус <span class="sort-icon-container"></span></th>
                                <th class="sortable-header" data-sort-by="registration_date">Дата регистрации <span class="sort-icon-container"></span></th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td>1</td>
                                <td>Иванов Иван Иванович</td>
                                <td>admin@example.com</td>
                                <td>Администратор</td>
                                <td><span class="status-badge status-active">Активен</span></td>
                                <td>01.01.2024</td>
                                <td class="flex items-center space-x-1 py-3">
                                    <button class="btn btn-primary btn-icon edit-user-btn" data-id="1" title="Редактировать">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                    </button>
                                    <button class="btn btn-warning btn-icon toggle-user-status-btn" data-id="1" data-current-status="active" title="Деактивировать">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg>
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td>2</td>
                                <td>Петров Петр Петрович</td>
                                <td>editor@example.com</td>
                                <td>Редактор техкарт</td>
                                <td><span class="status-badge status-active">Активен</span></td>
                                <td>10.02.2024</td>
                                <td class="flex items-center space-x-1 py-3">
                                    <button class="btn btn-primary btn-icon edit-user-btn" data-id="2" title="Редактировать">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                    </button>
                                    <button class="btn btn-warning btn-icon toggle-user-status-btn" data-id="2" data-current-status="active" title="Деактивировать">
                                       <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg>
                                    </button>
                                </td>
                            </tr>
                             <tr>
                                <td>3</td>
                                <td>Сидорова Анна Игоревна</td>
                                <td>marketer@example.com</td>
                                <td>Маркетолог</td>
                                <td><span class="status-badge status-inactive">Неактивен</span></td>
                                <td>05.03.2024</td>
                                <td class="flex items-center space-x-1 py-3">
                                    <button class="btn btn-primary btn-icon edit-user-btn" data-id="3" title="Редактировать">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                    </button>
                                    <button class="btn btn-success btn-icon toggle-user-status-btn" data-id="3" data-current-status="inactive" title="Активировать">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                                    </button>
                                </td>
                            </tr>
                            </tbody>
                    </table>
                </div>
                <div class="mt-6 flex justify-center">
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        <a href="#" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                          <span class="sr-only">Предыдущая</span>
                          <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        </a>
                        <a href="#" aria-current="page" class="z-10 bg-sky-50 border-sky-500 text-sky-600 relative inline-flex items-center px-4 py-2 border text-sm font-medium">1</a>
                        <a href="#" class="bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium">2</a>
                        <a href="#" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                          <span class="sr-only">Следующая</span>
                          <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                        </a>
                      </nav>
                </div>

            </div>
        </main>
    </div>

    <div id="user-modal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="user-modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-600 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full p-6">
                <div class="flex justify-between items-center pb-3">
                    <h3 class="text-lg font-medium text-gray-900" id="user-modal-title">Добавить нового пользователя</h3>
                    <button onclick="closeUserModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <form id="user-form" class="space-y-4">
                    <input type="hidden" id="user-id" name="user-id">
                    <div>
                        <label for="user-fullname" class="form-label">ФИО <span class="text-red-500">*</span></label>
                        <input type="text" id="user-fullname" name="user-fullname" class="form-input w-full" required>
                    </div>
                    <div>
                        <label for="user-email" class="form-label">Email <span class="text-red-500">*</span></label>
                        <input type="email" id="user-email" name="user-email" class="form-input w-full" required>
                    </div>
                    <div>
                        <label for="user-role-modal" class="form-label">Роль <span class="text-red-500">*</span></label>
                        <select id="user-role-modal" name="user-role" class="form-select w-full" required>
                            <option value="">Выберите роль</option>
                            <option value="admin">Администратор</option>
                            <option value="manager">Руководитель</option>
                            <option value="editor">Редактор техкарт</option>
                            <option value="marketer">Маркетолог</option>
                        </select>
                    </div>
                     <div>
                        <label for="user-password" class="form-label">Пароль</label>
                        <input type="password" id="user-password" name="user-password" class="form-input w-full" autocomplete="new-password" placeholder="Оставьте пустым, чтобы не менять">
                         <p class="text-xs text-gray-500 mt-1" id="password-hint">При создании нового пользователя, если поле пустое, пароль будет сгенерирован автоматически и отправлен на Email.</p>
                    </div>
                    <div>
                        <label for="user-status-modal" class="form-label">Статус</label>
                        <select id="user-status-modal" name="user-status" class="form-select w-full">
                            <option value="active">Активен</option>
                            <option value="inactive">Неактивен</option>
                        </select>
                    </div>
                    <div class="pt-4 flex justify-end space-x-2">
                        <button type="button" onclick="closeUserModal()" class="btn btn-secondary">Отмена</button>
                        <button type="submit" class="btn btn-success">Сохранить пользователя</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const sidebar = document.getElementById('admin-sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');

            if (sidebarToggle && sidebar) {
                sidebarToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('w-64');
                    sidebar.classList.toggle('w-16');
                });
            }

            const approvalCountBadge = document.getElementById('nav-approval-count-sidebar');
            if (approvalCountBadge) {
                approvalCountBadge.textContent = '3';
            }

            const sortableHeaders = document.querySelectorAll('#users-table th.sortable-header');
            let currentSort = { column: null, direction: 'none' };
            const sortIconAsc = `<svg class="sort-icon asc" viewBox="0 0 20 20" fill="currentColor"><polygon points="10 4 4.5 13 15.5 13"></polygon></svg>`;
            const sortIconDesc = `<svg class="sort-icon desc" viewBox="0 0 20 20" fill="currentColor"><polygon points="10 16 4.5 7 15.5 7"></polygon></svg>`;
            const sortIconNeutral = `<svg class="sort-icon neutral" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 15L12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9"></path></svg>`;

            sortableHeaders.forEach(header => {
                const sortIconContainer = header.querySelector('.sort-icon-container');
                if (sortIconContainer) sortIconContainer.innerHTML = sortIconNeutral;
                header.addEventListener('click', () => { /* ... логика сортировки ... */ });
            });

            const userModal = document.getElementById('user-modal');
            const userModalTitle = document.getElementById('user-modal-title');
            const userForm = document.getElementById('user-form');
            const userIdInput = document.getElementById('user-id');
            const passwordHint = document.getElementById('password-hint');

            document.getElementById('add-new-user-btn').addEventListener('click', () => {
                userModalTitle.textContent = 'Добавить нового пользователя';
                userForm.reset();
                userIdInput.value = '';
                document.getElementById('user-password').placeholder = "Пароль будет сгенерирован";
                if (passwordHint) passwordHint.textContent = "При создании нового пользователя, если поле пустое, пароль будет сгенерирован автоматически и отправлен на Email.";
                userModal.classList.remove('hidden');
            });

            document.querySelectorAll('.edit-user-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const userId = event.currentTarget.dataset.id;
                    userModalTitle.textContent = `Редактировать пользователя (ID: ${userId})`;
                    userForm.reset();
                    userIdInput.value = userId;
                    document.getElementById('user-password').placeholder = "Оставьте пустым, чтобы не менять";
                    if (passwordHint) passwordHint.textContent = "Оставьте поле пароля пустым, если не хотите его изменять.";
                    // TODO: Загрузить данные пользователя по ID и заполнить форму
                    userModal.classList.remove('hidden');
                });
            });

            if (userForm) {
                userForm.addEventListener('submit', (event) => {
                    event.preventDefault();
                    const formData = new FormData(userForm);
                    const data = Object.fromEntries(formData.entries());
                    console.log('Сохранение пользователя:', data);
                    alert(`Пользователь "${data['user-fullname']}" сохранен (имитация).`);
                    closeUserModal();
                });
            }

            document.querySelectorAll('.toggle-user-status-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const userId = event.currentTarget.dataset.id;
                    const currentStatus = event.currentTarget.dataset.currentStatus;
                    const newStatusActionText = currentStatus === 'active' ? 'Деактивировать' : 'Активировать';
                    const userName = event.currentTarget.closest('tr').querySelector('td:nth-child(2)').textContent;
                    if (confirm(`Вы уверены, что хотите сделать пользователя "${userName}" ${newStatusActionText.toLowerCase()}?`)) {
                        console.log(`Изменение статуса для пользователя ID ${userId}`);
                        alert(`Статус пользователя "${userName}" изменен (имитация).`);
                        const statusBadge = event.currentTarget.closest('tr').querySelector('.status-badge');
                        const iconActivate = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>`;
                        const iconDeactivate = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg>`;

                        if (currentStatus === 'active') {
                            statusBadge.classList.remove('status-active');
                            statusBadge.classList.add('status-inactive');
                            statusBadge.textContent = 'Неактивен';
                            event.currentTarget.dataset.currentStatus = 'inactive';
                            event.currentTarget.title = 'Активировать';
                            event.currentTarget.innerHTML = iconActivate;
                            event.currentTarget.classList.remove('btn-warning');
                            event.currentTarget.classList.add('btn-success');
                        } else {
                            statusBadge.classList.remove('status-inactive');
                            statusBadge.classList.add('status-active');
                            statusBadge.textContent = 'Активен';
                            event.currentTarget.dataset.currentStatus = 'active';
                            event.currentTarget.title = 'Деактивировать';
                            event.currentTarget.innerHTML = iconDeactivate;
                            event.currentTarget.classList.remove('btn-success');
                            event.currentTarget.classList.add('btn-warning');
                        }
                    }
                });
            });

        });

        function closeUserModal() {
            const userModal = document.getElementById('user-modal');
            if (userModal) userModal.classList.add('hidden');
        }
    </script>
</body>
</html>

--- Файл: _tech_card_summary_snippet.txt ---

{% if active_tech_card %}
    <p class="text-sm text-gray-700">РђРєС‚РёРІРЅР°СЏ С‚РµС…РєР°СЂС‚Р°: <span class="font-semibold">{{ active_tech_card.name }} (v{{ active_tech_card.version }})</span></p>
    <p class="text-sm text-gray-700">РЎС‚Р°С‚СѓСЃ: 
        <span class="font-semibold status-badge 
            {% if active_tech_card.status == TECH_CARD_STATUS_APPROVED %}status-approved
            {% elif active_tech_card.status == TECH_CARD_STATUS_PENDING_ACCOUNTANT %}status-pending-accountant
            {% elif active_tech_card.status == TECH_CARD_STATUS_PENDING_MANAGER %}status-pending-manager
            {% elif active_tech_card.status == TECH_CARD_STATUS_PROCESSED %}status-approved 
            {% elif active_tech_card.status == TECH_CARD_STATUS_PROCESSED_NEEDS_PRICES %}status-needs-prices
            {% elif active_tech_card.status == TECH_CARD_STATUS_DRAFT %}status-draft
            {% elif active_tech_card.status == TECH_CARD_STATUS_REJECTED_ACCOUNTANT or active_tech_card.status == TECH_CARD_STATUS_REJECTED_MANAGER %}status-rejected
            {% elif active_tech_card.status == TECH_CARD_STATUS_ARCHIVED %}status-archived
            {% else %}status-not-found{% endif %}">
            {{ active_tech_card.status }}
        </span>
    </p>
    <p class="text-xs text-gray-500">РЎРµР±РµСЃС‚РѕРёРјРѕСЃС‚СЊ РїРѕ РЅРµР№: 
        <span class="font-semibold">
            {{ '%.2f СЃРѕРј'|format(active_tech_card.total_cost|float) if active_tech_card.total_cost is not none else 'N/A' }}
        </span>
    </p>
    {% if active_tech_card.file_url %}
    <p class="text-xs text-gray-500">Р¤Р°Р№Р»: {{ active_tech_card.file_url.split('/')[-1] }}</p>
    {% endif %}
    {% if active_tech_card.updated_at %}
    <p class="text-xs text-gray-500">РћР±РЅРѕРІР»РµРЅР°: {{ active_tech_card.updated_at.strftime('%d.%m.%Y %H:%M') }}</p>
    {% endif %}
    
    {% if tech_card_components and tech_card_components|length > 0 %}
        <h4 class="text-md font-medium text-gray-800 mt-4 mb-2">РљРѕРјРїРѕРЅРµРЅС‚С‹ Р°РєС‚РёРІРЅРѕР№ С‚РµС…РєР°СЂС‚С‹:</h4>
        <div class="max-h-60 overflow-y-auto border border-gray-200 rounded-md">
            <table class="min-w-full divide-y divide-gray-200 table-auto"> <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">в„–</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">РђСЂС‚РёРєСѓР»</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">РќР°РёРјРµРЅРѕРІР°РЅРёРµ</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">РљРѕР»-РІРѕ</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Р•Рґ.</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Р¦РµРЅР°</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">РЎСѓРјРјР°</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for component in tech_card_components %}
                    <tr>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-600">{{ loop.index }}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-600">{{ component.raw_material_item.sku or '-' }}</td>
                        <td class="px-3 py-2 text-sm text-gray-600">{{ component.raw_material_item.name }}</td> <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-600">{{ "%.3f"|format(component.quantity|float) }}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-600">{{ component.raw_material_item.unit_of_measurement }}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-600">{{ "%.2f"|format(component.raw_material_item.price|float) if component.raw_material_item.price is not none else 'N/A' }}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-600">
                            {% if component.raw_material_item.price is not none and component.quantity is not none %}
                                {{ "%.2f"|format((component.quantity * component.raw_material_item.price)|float) }}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p class="text-sm text-gray-500 mt-2">РљРѕРјРїРѕРЅРµРЅС‚С‹ РґР»СЏ СЌС‚РѕР№ С‚РµС…РєР°СЂС‚С‹ РЅРµ Р·Р°РіСЂСѓР¶РµРЅС‹ РёР»Рё РѕС‚СЃСѓС‚СЃС‚РІСѓСЋС‚.</p>
    {% endif %}
 {% else %}
    <p class="text-sm text-gray-500">РђРєС‚РёРІРЅР°СЏ С‚РµС…РєР°СЂС‚Р° РґР»СЏ СЌС‚РѕРіРѕ С‚РѕРІР°СЂР° РЅРµ РЅР°Р№РґРµРЅР° РёР»Рё РµС‰Рµ РЅРµ РѕР±СЂР°Р±РѕС‚Р°РЅР°. РќР°Р¶РјРёС‚Рµ РєРЅРѕРїРєСѓ "Р”РѕР±Р°РІРёС‚СЊ С‚РµС…РєР°СЂС‚Сѓ" РІС‹С€Рµ.</p>
 {% endif %}

--- Файл: объединенный_файл.txt ---

